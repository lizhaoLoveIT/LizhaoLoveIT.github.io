<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>核心动画 | Ammar's Blog</title><meta name="description" content="核心动画"><meta name="keywords" content="iOS"><meta name="author" content="Ammar"><meta name="copyright" content="Ammar"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://lizhaoloveit.cn/2014/07/20/%E6%A0%B8%E5%BF%83%E5%8A%A8%E7%94%BB/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="核心动画"><meta name="twitter:description" content="核心动画"><meta name="twitter:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta property="og:type" content="article"><meta property="og:title" content="核心动画"><meta property="og:url" content="http://lizhaoloveit.cn/2014/07/20/%E6%A0%B8%E5%BF%83%E5%8A%A8%E7%94%BB/"><meta property="og:site_name" content="Ammar's Blog"><meta property="og:description" content="核心动画"><meta property="og:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="KVC" href="http://lizhaoloveit.cn/2014/07/20/KVC/"><link rel="next" title="Quartz2D" href="http://lizhaoloveit.cn/2014/07/11/Quartz2D/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?162506e75ffd64287398566b2f5738c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"VRMKRAV9AT","apiKey":"bd7157400046d0f02396708a501a3480","indexName":"lizhaoloveit","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://lizhaoloveit.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script><meta name="generator" content="Hexo 4.2.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#图层-CALayer-对象"><span class="toc-number">1.</span> <span class="toc-text">图层 CALayer 对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CALayer-属性"><span class="toc-number">1.2.</span> <span class="toc-text">CALayer 属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CALayer-使用注意点："><span class="toc-number">1.3.</span> <span class="toc-text">CALayer 使用注意点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#图层的手动创建"><span class="toc-number">1.4.</span> <span class="toc-text">图层的手动创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义图层的内容"><span class="toc-number">1.5.</span> <span class="toc-text">自定义图层的内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#方法一：自己写一个类继承-CALayer"><span class="toc-number">1.5.1.</span> <span class="toc-text">方法一：自己写一个类继承 CALayer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#方法二：实现代理方法"><span class="toc-number">1.5.2.</span> <span class="toc-text">方法二：实现代理方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CALayer-上动画的暂停和恢复"><span class="toc-number">1.6.</span> <span class="toc-text">CALayer 上动画的暂停和恢复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UIView-能够显示内容的原理"><span class="toc-number">2.</span> <span class="toc-text">UIView 能够显示内容的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#隐式动画"><span class="toc-number">3.</span> <span class="toc-text">隐式动画</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Core-Animation"><span class="toc-number">4.</span> <span class="toc-text">Core Animation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用步骤："><span class="toc-number">4.1.</span> <span class="toc-text">使用步骤：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAAnimation-内部结构"><span class="toc-number">4.2.</span> <span class="toc-text">CAAnimation 内部结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动画代理方法"><span class="toc-number">4.3.</span> <span class="toc-text">动画代理方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAAnimation-的常用属性"><span class="toc-number">5.</span> <span class="toc-text">CAAnimation 的常用属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAAnimation-的子类们"><span class="toc-number">6.</span> <span class="toc-text">CAAnimation 的子类们</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CATransition-transition-有过渡的意思-重要"><span class="toc-number">6.1.</span> <span class="toc-text">CATransition(transition 有过渡的意思)(重要)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CABasicAnimation基本动画"><span class="toc-number">6.2.</span> <span class="toc-text">CABasicAnimation基本动画</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAKeyframeAnimation帧动画"><span class="toc-number">6.3.</span> <span class="toc-text">CAKeyframeAnimation帧动画</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAAnimationGroup"><span class="toc-number">6.4.</span> <span class="toc-text">CAAnimationGroup</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UIView-animation"><span class="toc-number">7.</span> <span class="toc-text">UIView animation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CADisplayLink"><span class="toc-number">8.</span> <span class="toc-text">CADisplayLink</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介-1"><span class="toc-number">8.1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#所在框架"><span class="toc-number">8.1.1.</span> <span class="toc-text">所在框架</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#功能"><span class="toc-number">8.1.2.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用方式"><span class="toc-number">8.1.3.</span> <span class="toc-text">使用方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#特性"><span class="toc-number">8.2.</span> <span class="toc-text">特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#原理"><span class="toc-number">8.2.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#周期设置方式"><span class="toc-number">8.2.2.</span> <span class="toc-text">周期设置方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#精确度"><span class="toc-number">8.2.3.</span> <span class="toc-text">精确度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用场合"><span class="toc-number">8.2.4.</span> <span class="toc-text">使用场合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重要属性"><span class="toc-number">8.3.</span> <span class="toc-text">重要属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#frameInterval"><span class="toc-number">8.3.1.</span> <span class="toc-text">frameInterval</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#duration"><span class="toc-number">8.3.2.</span> <span class="toc-text">duration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#timestamp"><span class="toc-number">8.3.3.</span> <span class="toc-text">timestamp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注意"><span class="toc-number">8.4.</span> <span class="toc-text">注意</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考文档"><span class="toc-number">8.5.</span> <span class="toc-text">参考文档</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://lizhaoloveit.cn/blogimages/blog/top_img.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Ammar's Blog</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description">微信号：aicjaish</div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a><a class="site-page" href="/comment/"><i class="fa-fw fa fa-coffee"></i><span> 留言</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">核心动画</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2014-07-20<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-07-29</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/">iOS</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/CoreAnimation/">CoreAnimation</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.7k</span><span class="post-meta__separator">|</span><span>阅读时长: 18 分钟</span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h2 id="图层-CALayer-对象"><a href="#图层-CALayer-对象" class="headerlink" title="图层 CALayer 对象"></a>图层 CALayer 对象</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>iOS中，我们能看得见的东西，基本上都是 UIView，比如一个按钮，一个文本标签。而 UIView 之所以能显示在屏幕上，完全时因为它内部的一个图层。</p>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>在创建UIView对象时，内部会自动创建图层 CALayer 对象，通过 UIView 的 layer 属性可以访问这个图层对象。</p>
<p>当 UIView 需要显示到屏幕上时，会调用 drawRect: 方法进行绘图，并且会将所有内部内容绘制在自己的图层上，绘图之后，系统会将图层拷贝到屏幕上，于是就完成了 UIView 的显示。</p>
<p>iOS7 以前需要导入框架，QuartzCore.framework</p>
<blockquote>
<p>QuartzCore 框架和 CoreGraphics 框架是可以跨平台使用的，在 iOS 和 Mac OS X 上都能使用。</p>
</blockquote>
<h3 id="CALayer-属性"><a href="#CALayer-属性" class="headerlink" title="CALayer 属性"></a>CALayer 属性</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 宽度和高度</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CGRect</span> bounds;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 位置 用来设置 CALayer 在父层中的位置 (配合 anchorPoint 确定图层在控件中的位置)</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CGPoint</span> position;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 锚点(x,y的范围都是0-1)，决定着 CALayer身上 的哪个点会在 position 属性所指的位置，默认值为（0.5, 0.5）</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CGPoint</span> anchorPoint;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 背景颜色(CGColorRef类型)</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CGColorRef</span> backgroundColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内容(比如设置为图片CGImageRef)</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>) <span class="keyword">id</span> contents;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CGFloat</span> borderWidth; <span class="comment">// 边框宽度</span></span><br><span class="line"><span class="comment">// 注意：边框加在 view 里面</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nullable</span>) <span class="built_in">CGColorRef</span> borderColor; <span class="comment">// 边框颜色</span></span><br><span class="line"><span class="keyword">self</span>.purpleView.layer.borderColor = [<span class="built_in">UIColor</span> greenColor].CGColor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CGFloat</span> cornerRadius; <span class="comment">// view 的圆角</span></span><br><span class="line"><span class="keyword">self</span>.purpleView.layer.masksToBounds = <span class="literal">NO</span>; <span class="comment">// 超出 View 裁剪 默认时 NO</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nullable</span>) <span class="built_in">CGColorRef</span> shadowColor; <span class="comment">// 阴影颜色</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">CGSize</span> shadowOffset;    <span class="comment">// default is CGSizeMake(0, -1)</span></span><br><span class="line"><span class="comment">// CGSizeMake(x, y)，阴影向右边偏移了 x，向下偏移了 y</span></span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">float</span> shadowOpacity; <span class="comment">// 阴影不透明度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：阴影的 颜色、偏差和阴影不透明度 配合使用才有效果</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CATransform3D</span> transform; <span class="comment">// 核心属性 3D</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3D 旋转参数的意思是，从原点到(1, 1, 0)的线为轴，旋转 M_PI_4;</span></span><br><span class="line"><span class="keyword">self</span>.purpleView.layer.transform = <span class="built_in">CATransform3DMakeRotation</span>(M_PI_4, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">self</span>.purpleView.layer.transform = <span class="built_in">CATransform3DMakeScale</span>(<span class="number">1.5</span>, <span class="number">0.5</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">[<span class="keyword">self</span>.purpleView.layer setValue:@(M_PI_2) forKeyPath:<span class="string">@"transform.rotation"</span>];</span><br><span class="line">    </span><br><span class="line">[<span class="keyword">self</span>.purpleView.layer setValue:[<span class="built_in">NSValue</span> valueWithCATransform3D:<span class="built_in">CATransform3DMakeScale</span>(<span class="number">0.5</span>, <span class="number">2</span>, <span class="number">0</span>)] forKeyPath:<span class="string">@"transform"</span>];</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 可以传哪些 key path 在官方文档 CATransform3D key paths</span></span><br><span class="line">[<span class="keyword">self</span>.purpleView.layer setValue:@(<span class="number">0.5</span>) forKeyPath:<span class="string">@"transform.scale.y"</span>];</span><br></pre></td></tr></table></figure>

<p>只要是继承了 UIView，都有图层属性，因此 imageView，button 都可以设置以上属性。</p>
<p>在设置 imageView 的圆角时，由于 imageView 内部还有一个用于显示<br>图片的子层(UIView 内部只有一个主图层)，因此我们改变 imageView 的 Layer时，改变的是主层的圆角。子层显示在主层上，因此图片并没有圆角效果，只有再加一句代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imageView.layer.masksToBounds = <span class="literal">NO</span>; <span class="comment">// 超出 View 裁剪 默认时 NO</span></span><br></pre></td></tr></table></figure>
<p>告诉 imageView 超出主层的部分全部减掉。才会显示圆角效果。</p>
<h3 id="CALayer-使用注意点："><a href="#CALayer-使用注意点：" class="headerlink" title="CALayer 使用注意点："></a>CALayer 使用注意点：</h3><p>UIView 可以通过 subViews 属性访问所有的子视图，CALayer 也可以通过 subLayers 属性访问所有的子层</p>
<p>UIView 可以通过 superView 属性访问父视图，CALayer 也可以通过 superLayer 访问父层。</p>
<p>如果两个 UIView 是父子关系，那么它们内部的 CALayer 也是父子关系</p>
<h3 id="图层的手动创建"><a href="#图层的手动创建" class="headerlink" title="图层的手动创建"></a>图层的手动创建</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 创建图层</span></span><br><span class="line"><span class="built_in">CALayer</span> *layer = [<span class="built_in">CALayer</span> layer];</span><br><span class="line">layer.frame = <span class="built_in">CGRectMake</span>(<span class="number">50</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">layer.backgroundColor = [<span class="built_in">UIColor</span> redColor].CGColor;</span><br><span class="line"><span class="comment">// 设置图层内容</span></span><br><span class="line">layer.contents = (<span class="keyword">id</span>)[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"阿狸头像"</span>].CGImage;</span><br><span class="line">[<span class="keyword">self</span>.view.layer addSublayer:layer];</span><br></pre></td></tr></table></figure>

<h3 id="自定义图层的内容"><a href="#自定义图层的内容" class="headerlink" title="自定义图层的内容"></a>自定义图层的内容</h3><h4 id="方法一：自己写一个类继承-CALayer"><a href="#方法一：自己写一个类继承-CALayer" class="headerlink" title="方法一：自己写一个类继承 CALayer"></a>方法一：自己写一个类继承 CALayer</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"MyLayer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyLayer</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)drawInContext:(<span class="built_in">CGContextRef</span>)ctx</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 红色</span></span><br><span class="line">    <span class="built_in">CGContextSetRGBFillColor</span>(ctx, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 添加圆</span></span><br><span class="line">    <span class="built_in">CGContextAddEllipseInRect</span>(ctx, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">50</span>));</span><br><span class="line">    <span class="comment">// 实心绘制</span></span><br><span class="line">    <span class="built_in">CGContextFillPath</span>(ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.purpleView.hidden = <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    MyLayer *layer = [MyLayer layer];</span><br><span class="line">    layer.bounds = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">    layer.position = <span class="built_in">CGPointZero</span>;</span><br><span class="line">    layer.anchorPoint = <span class="built_in">CGPointZero</span>;</span><br><span class="line">    layer.backgroundColor = [<span class="built_in">UIColor</span> blueColor].CGColor;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 有这句话才能执行 -drawInContext 和 drawRect 方法</span></span><br><span class="line">    [layer setNeedsDisplay];</span><br><span class="line">    [<span class="keyword">self</span>.view.layer addSublayer:layer];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法二：实现代理方法"><a href="#方法二：实现代理方法" class="headerlink" title="方法二：实现代理方法"></a>方法二：实现代理方法</h4><p>CALayer 的代理是没有协议的，这说明任何对象都可以当 CALayer 代理。而代理方法就在 NSObject 中。当图层需要显示的时候，会调用代理的绘制方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.purpleView.hidden = <span class="literal">YES</span>;</span><br><span class="line">    <span class="built_in">CALayer</span> *layer = [<span class="built_in">CALayer</span> layer];</span><br><span class="line">    layer.bounds = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">    layer.position = <span class="built_in">CGPointZero</span>;</span><br><span class="line">    layer.anchorPoint = <span class="built_in">CGPointZero</span>;</span><br><span class="line">    layer.delegate = <span class="keyword">self</span>;</span><br><span class="line">    layer.backgroundColor = [<span class="built_in">UIColor</span> blueColor].CGColor;</span><br><span class="line">    [layer setNeedsDisplay];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.view.layer addSublayer:layer];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - CALayer 的代理方法</span></span><br><span class="line">- (<span class="keyword">void</span>)drawLayer:(<span class="built_in">CALayer</span> *)layer inContext:(<span class="built_in">CGContextRef</span>)ctx</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 红色</span></span><br><span class="line">    <span class="built_in">CGContextSetRGBFillColor</span>(ctx, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 添加圆</span></span><br><span class="line">    <span class="built_in">CGContextAddEllipseInRect</span>(ctx, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">50</span>));</span><br><span class="line">    <span class="comment">// 实心绘制</span></span><br><span class="line">    <span class="built_in">CGContextFillPath</span>(ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CALayer-上动画的暂停和恢复"><a href="#CALayer-上动画的暂停和恢复" class="headerlink" title="CALayer 上动画的暂停和恢复"></a>CALayer 上动画的暂停和恢复</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark 暂停CALayer的动画</span></span><br><span class="line">- (<span class="keyword">void</span>)pauseLayer:(<span class="built_in">CALayer</span>*)layer</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CFTimeInterval</span> pausedTime = [layer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 让CALayer的时间停止走动</span></span><br><span class="line">      layer.speed = <span class="number">0.0</span>;</span><br><span class="line">    <span class="comment">// 让CALayer的时间停留在pausedTime这个时刻</span></span><br><span class="line">    layer.timeOffset = pausedTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark 恢复CALayer的动画</span></span><br><span class="line">-(<span class="keyword">void</span>)resumeLayer:(<span class="built_in">CALayer</span>*)layer</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CFTimeInterval</span> pausedTime = layer.timeOffset;</span><br><span class="line">    <span class="comment">// 1. 让CALayer的时间继续行走</span></span><br><span class="line">      layer.speed = <span class="number">1.0</span>;</span><br><span class="line">    <span class="comment">// 2. 取消上次记录的停留时刻</span></span><br><span class="line">      layer.timeOffset = <span class="number">0.0</span>;</span><br><span class="line">    <span class="comment">// 3. 取消上次设置的时间</span></span><br><span class="line">      layer.beginTime = <span class="number">0.0</span>;    </span><br><span class="line">    <span class="comment">// 4. 计算暂停的时间(这里也可以用CACurrentMediaTime()-pausedTime)</span></span><br><span class="line">    <span class="built_in">CFTimeInterval</span> timeSincePause = [layer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>] - pausedTime;</span><br><span class="line">    <span class="comment">// 5. 设置相对于父坐标系的开始时间(往后退timeSincePause)</span></span><br><span class="line">      layer.beginTime = timeSincePause;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="UIView-能够显示内容的原理"><a href="#UIView-能够显示内容的原理" class="headerlink" title="UIView 能够显示内容的原理"></a>UIView 能够显示内容的原理</h2><p>首先 <code>view.layer.delegate</code> &#x3D;&#x3D; <code>view</code>，一个 view 内部的图层的代理就是这个 view。<code>view.layer</code> 会准备一个 Layer Graphics Contex(图层类型上下文)</p>
<p>这时要显示内容时会调用 <code>view.layer.delegate</code> 的 -drawLayer:inContext: 方法将图层上的东西绘制出来，而 drawLayer:inContext: 方法内部又回调用 <code>-drawRect:</code> 方法。</p>
<p>因此 view 就可以在 <code>-drawRect:</code> 方法中实现绘图代码，所有东西最终都绘制到 view.layer 上面，系统再将 view.layer 的内容拷贝到屏幕，于是完成了 view 的显示。</p>
<hr>
<h2 id="隐式动画"><a href="#隐式动画" class="headerlink" title="隐式动画"></a>隐式动画</h2><p>每一个 UIView 内部都默认关联着一个 CALayer，我们可以称这个 Layer 为 Root Layer(根层)</p>
<p>所有的非 Root Layer，就是那些手动创建的 CALayer 对象，都存在着隐式动画</p>
<p>当我们对于非 Root Layer 的部分属性进行修改时，默认会自动产生一些动画效果。这些属性称为 Animatable Properties(可动画属性)比如：</p>
<ul>
<li>bounds：用于设置 CALayer 的宽度和高度，修改这个属性会产生缩放动画</li>
<li>backgroundColor：用于设置 CALayer 的背景色，修改这个属性会产生背景色的渐变动画</li>
<li>position：用于设置 CALayer 的位置，修改这个属性会产生平移动画</li>
</ul>
<p>代码如下：</p>
<p>首先，需要新建图层，因为只有非根层才有隐式动画。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.purpleView.hidden = <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CALayer</span> *layer = [<span class="built_in">CALayer</span> layer];</span><br><span class="line">    </span><br><span class="line">    layer.bounds = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">    layer.backgroundColor = [<span class="built_in">UIColor</span> redColor].CGColor;</span><br><span class="line">    layer.position = <span class="built_in">CGPointZero</span>;</span><br><span class="line">    layer.anchorPoint = <span class="built_in">CGPointZero</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view.layer addSublayer:layer];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.layer = layer;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们点击屏幕时候要做一些事情：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.layer.backgroundColor = [<span class="built_in">UIColor</span> blueColor].CGColor;</span><br><span class="line">    <span class="keyword">self</span>.layer.opacity = <span class="number">0.5</span>;</span><br><span class="line">    <span class="keyword">self</span>.layer.position = <span class="built_in">CGPointMake</span>(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果要关掉动画，将代码放到下面事务内部：</span></span><br><span class="line">    [<span class="built_in">CATransaction</span> begin]; <span class="comment">// 开启事务</span></span><br><span class="line">    [<span class="built_in">CATransaction</span> setDisableActions:<span class="literal">YES</span>];</span><br><span class="line">    <span class="keyword">self</span>.layer.position = <span class="built_in">CGPointMake</span>(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">self</span>.layer.opacity = <span class="number">0.5</span>;</span><br><span class="line">    [<span class="built_in">CATransaction</span> commit]; <span class="comment">// 提交事务</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Core-Animation"><a href="#Core-Animation" class="headerlink" title="Core Animation"></a>Core Animation</h2><p>Core Animation简介：</p>
<p>Core Animation 可以用在 Mac OS X 和 iOS 平台。<br>动画执行过程都是在后台操作，不会阻塞主线程。<br>Core Animation 直接作用在 CALayer 上，并非 UIView。</p>
<h3 id="使用步骤："><a href="#使用步骤：" class="headerlink" title="使用步骤："></a>使用步骤：</h3><ol>
<li><p>需要 QuartzCore.framework 框架 &lt;QuartzCore&#x2F;QuartzCore.h&gt;</p>
</li>
<li><p>初始化一个CAAnimation 对象，设置动画相关属性。</p>
</li>
<li><p>通过调用 CALayer 的 <code>addAnimation:forKey:</code> 方法增加 CAAnimation 对象到 CALayer 中，这样就能开始执行动画了，key 为该动画的标识符，删除动画时会用到。</p>
</li>
<li><p>通过调用 CALayer 的 <code>removeAnimationForKey:</code> 方法可以停止 CALayer 中的动画。</p>
</li>
</ol>
<h3 id="CAAnimation-内部结构"><a href="#CAAnimation-内部结构" class="headerlink" title="CAAnimation 内部结构"></a>CAAnimation 内部结构</h3><p>CAAnimation 是抽象类</p>
<p>其实，一般情况下，我们使用的比较多的是CAAnimation的子类，因此，先大致看看CAAnimation的继承结构：</p>
<p>黑线代表继承，黑色文字代表类名，白色文字代表属性。其中CAMediaTiming是一个协议(protocol)。</p>
<h3 id="动画代理方法"><a href="#动画代理方法" class="headerlink" title="动画代理方法"></a>动画代理方法</h3><p>property delegate;</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">CAAnimationDelegate</span>)</span></span><br><span class="line"><span class="comment">// 动画开始执行的时候触发这个方法</span></span><br><span class="line">- (<span class="keyword">void</span>)animationDidStart:(<span class="built_in">CAAnimation</span> *)anim;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 动画执行完毕的时候触发这个方法</span></span><br><span class="line">- (<span class="keyword">void</span>)animationDidStop:(<span class="built_in">CAAnimation</span> *)anim finished:(<span class="built_in">BOOL</span>)flag;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h2 id="CAAnimation-的常用属性"><a href="#CAAnimation-的常用属性" class="headerlink" title="CAAnimation 的常用属性"></a>CAAnimation 的常用属性</h2><ul>
<li>可用的keyPath</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动画进度，从动画的百分之80开始执行动画</span></span><br><span class="line">animation.startProgress = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 从 startProgress 开始 以 endProgress 结束</span></span><br><span class="line"><span class="comment">// 以动画的百分之 startProgress 开始 以 动画的 endProgress 结束</span></span><br><span class="line">animation.endProgress = <span class="number">0.6</span>;</span><br><span class="line">animation.duration = <span class="number">2.0</span>;</span><br><span class="line"><span class="comment">// 完成时会移除动画，默认值为 YES    </span></span><br><span class="line">animation.removedOnCompletion = <span class="literal">NO</span>; </span><br><span class="line"><span class="comment">// fillMode 动画执行完毕后的绘制模式</span></span><br><span class="line">animation.fillMode = kCAFillModeForwards;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置动画的执行节奏</span></span><br><span class="line">animation.timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithName:kCAMediaTimingFunctionEaseIn];</span><br></pre></td></tr></table></figure>

<ul>
<li>fillMode 动画执行完毕后的绘制模式<ul>
<li>kCAFillModeForwards 当动画结束后，layer会一直保持着动画最新的状态</li>
<li>kCAFillModeBackwards 与 kCAFillModeForwards 相对应，表示只要一开始执行动画(-addAnimation: 方法)，便会让 layer 立即进入初始位置(fromValue)</li>
<li>kCAFillModeRemoved 这个是默认值，动画开始前和动画结束后，动画对layer都没有影响，动画结束后，layer会恢复到之前的状态</li>
<li>kCAFillModeBoth 动画加入后开始之前，layer便处于动画初始状态，动画结束后layer保持动画最后的状态。</li>
</ul>
</li>
</ul>
<p>&#x3D;&#x3D;其中 transform 属性传入的是 CATransform3D&#x3D;&#x3D;</p>
<ul>
<li><p>timingFunction 属性可选的值有：</p>
<ul>
<li>kCAMediaTimingFunctionLinear（线性）：匀速，给你一个相对静态的感觉</li>
<li>kCAMediaTimingFunctionEaseIn（渐进）：动画缓慢进入，然后加速离开</li>
<li>kCAMediaTimingFunctionEaseOut（渐出）：动画全速进入，然后减速的到达目的地</li>
<li>kCAMediaTimingFunctionEaseInEaseOut（渐进渐出）：动画缓慢的进入，中间加速，然后减速的到达目的地。这个是默认的动画行为。</li>
</ul>
</li>
</ul>
<h2 id="CAAnimation-的子类们"><a href="#CAAnimation-的子类们" class="headerlink" title="CAAnimation 的子类们"></a>CAAnimation 的子类们</h2><h3 id="CATransition-transition-有过渡的意思-重要"><a href="#CATransition-transition-有过渡的意思-重要" class="headerlink" title="CATransition(transition 有过渡的意思)(重要)"></a>CATransition(transition 有过渡的意思)(重要)</h3><p>作用：转场动画</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 转场动画</span></span><br><span class="line"><span class="built_in">CATransition</span> *animation = [<span class="built_in">CATransition</span> animation];</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 关于 type 见下面的图表 </span></span><br><span class="line">animation.type = <span class="string">@"moveIn"</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// subtype 控制转场方向：</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">kCATransitionFade: </span></span><br><span class="line"><span class="comment">kCATransitionFromBottom: 从上往下</span></span><br><span class="line"><span class="comment">kCATransitionFromTop: 从下往上</span></span><br><span class="line"><span class="comment">kCATransitionFromLeft: 从左往右</span></span><br><span class="line"><span class="comment">kCATransitionFromRight: 从右往左</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">animation.subtype = kCATransitionFromBottom;</span><br><span class="line">    </span><br><span class="line">animation.duration = <span class="number">0.5</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 动画进度，从动画的百分之80开始执行动画</span></span><br><span class="line">animation.startProgress = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 从 startProgress 开始 以 endProgress 结束</span></span><br><span class="line"><span class="comment">// 以动画的百分之 startProgress 开始 以 动画的 endProgress 结束</span></span><br><span class="line">animation.endProgress = <span class="number">0.6</span>;</span><br><span class="line">    </span><br><span class="line">[<span class="keyword">self</span>.imageView.layer addAnimation:animation forKey:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<h3 id="CABasicAnimation基本动画"><a href="#CABasicAnimation基本动画" class="headerlink" title="CABasicAnimation基本动画"></a>CABasicAnimation基本动画</h3><ul>
<li>代码如下：</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.创建动画对象</span></span><br><span class="line"><span class="built_in">CABasicAnimation</span> *animation = [<span class="built_in">CABasicAnimation</span> animation];</span><br><span class="line"><span class="comment">// 2.设置动画属性</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// keyPath 决定了执行怎样的动画，调整哪个属性来执行动画</span></span><br><span class="line">animation.keyPath = <span class="string">@"position"</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 如果没有 fromValue 属性，表示从当前位置开始 类型 id 意味着只能传入对象</span></span><br><span class="line">animation.fromValue = [<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointMake</span>(<span class="number">0</span>, <span class="number">0</span>)];</span><br><span class="line">animation.toValue = [<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointMake</span>(<span class="number">200</span>, <span class="number">300</span>)];</span><br><span class="line">    </span><br><span class="line"><span class="comment">// byValue 表示递增值，表示在自己的基础上增加多少值</span></span><br><span class="line">animation.byValue;</span><br><span class="line">    </span><br><span class="line">animation.duration = <span class="number">2.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// animation.repeatCount 动画运行次数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果只写到这里，做完动画会返回原样</span></span><br><span class="line"><span class="comment">// 完成时会移除动画，默认值为 YES    </span></span><br><span class="line">animation.removedOnCompletion = <span class="literal">NO</span>; </span><br><span class="line"><span class="comment">// fillMode 动画执行完毕后的绘制模式</span></span><br><span class="line">animation.fillMode = kCAFillModeForwards;</span><br><span class="line"><span class="comment">// 3.添加动画</span></span><br><span class="line">[<span class="keyword">self</span>.layer addAnimation:animation forKey:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<h3 id="CAKeyframeAnimation帧动画"><a href="#CAKeyframeAnimation帧动画" class="headerlink" title="CAKeyframeAnimation帧动画"></a>CAKeyframeAnimation帧动画</h3><p>可以做一些列连续顺畅的操作</p>
<ul>
<li>第一种方式：</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CAKeyframeAnimation</span> *animation = [<span class="built_in">CAKeyframeAnimation</span> animation];</span><br><span class="line">animation.keyPath = <span class="string">@"position"</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 绘制路径</span></span><br><span class="line"><span class="built_in">CGMutablePathRef</span> path = <span class="built_in">CGPathCreateMutable</span>();</span><br><span class="line">    </span><br><span class="line"><span class="built_in">CGPathAddEllipseInRect</span>(path, <span class="literal">NULL</span>, <span class="built_in">CGRectMake</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line">    </span><br><span class="line">animation.path = path;</span><br><span class="line"><span class="built_in">CGPathRelease</span>(path);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 用 quartz2D 绘制路径</span></span><br><span class="line">    </span><br><span class="line">animation.duration = <span class="number">2.0</span>;</span><br><span class="line">animation.removedOnCompletion = <span class="literal">NO</span>;</span><br><span class="line">animation.fillMode = kCAFillModeForwards;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 设置动画的执行节奏</span></span><br><span class="line">animation.timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithName:kCAMediaTimingFunctionEaseIn];</span><br><span class="line">    </span><br><span class="line">[<span class="keyword">self</span>.purpleView.layer addAnimation:animation forKey:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<ul>
<li>第二种方式：</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CAKeyframeAnimation</span> *animation = [<span class="built_in">CAKeyframeAnimation</span> animation];</span><br><span class="line">    </span><br><span class="line">animation.keyPath = <span class="string">@"position"</span>;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSValue</span> *v1 = [<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointZero</span>];</span><br><span class="line"><span class="built_in">NSValue</span> *v2 = [<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointMake</span>(<span class="number">100</span>, <span class="number">100</span>)];</span><br><span class="line"><span class="built_in">NSValue</span> *v3 = [<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointMake</span>(<span class="number">0</span>, <span class="number">0</span>)];</span><br><span class="line"><span class="built_in">NSValue</span> *v4 = [<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointMake</span>(<span class="number">200</span>, <span class="number">300</span>)];</span><br><span class="line"><span class="built_in">NSValue</span> *v5 = [<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointMake</span>(<span class="number">300</span>, <span class="number">200</span>)];</span><br><span class="line"><span class="built_in">NSValue</span> *v6 = [<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointMake</span>(<span class="number">0</span>, <span class="number">0</span>)];</span><br><span class="line">    </span><br><span class="line">animation.values = @[v1, v2, v3, v4, v5, v6];</span><br><span class="line">    </span><br><span class="line">animation.duration = <span class="number">2.0</span>;</span><br><span class="line">animation.removedOnCompletion = <span class="literal">NO</span>;</span><br><span class="line">animation.fillMode = kCAFillModeForwards;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 控制每一帧的时间 表示第一帧用 1s，后面每一帧都用 0.2s</span></span><br><span class="line"><span class="comment">//    animation.keyTimes = @[@0.5, @0.1, @0.1, @0.1, @0.1, @0.1];</span></span><br><span class="line">    </span><br><span class="line">[<span class="keyword">self</span>.purpleView.layer addAnimation:animation forKey:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<h3 id="CAAnimationGroup"><a href="#CAAnimationGroup" class="headerlink" title="CAAnimationGroup"></a>CAAnimationGroup</h3><p>动画组，可以让很多对象一起执行动画</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同时缩放，平移，旋转</span></span><br><span class="line"><span class="built_in">CAAnimationGroup</span> *group = [<span class="built_in">CAAnimationGroup</span> animation];</span><br><span class="line"></span><br><span class="line"><span class="built_in">CABasicAnimation</span> *scale = [<span class="built_in">CABasicAnimation</span> animation];</span><br><span class="line">scale.keyPath = <span class="string">@"transform.scale"</span>;</span><br><span class="line">scale.toValue = @<span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CABasicAnimation</span> *rotation = [<span class="built_in">CABasicAnimation</span> animation];</span><br><span class="line">rotation.keyPath = <span class="string">@"transform.rotation"</span>;</span><br><span class="line">rotation.toValue = @(arc4random_uniform(M_PI));</span><br><span class="line"></span><br><span class="line"><span class="built_in">CABasicAnimation</span> *position = [<span class="built_in">CABasicAnimation</span> animation];</span><br><span class="line">position.keyPath = <span class="string">@"position"</span>;</span><br><span class="line">position.toValue = [<span class="built_in">NSValue</span> valueWithCGPoint:<span class="built_in">CGPointMake</span>(arc4random_uniform(<span class="number">200</span>), arc4random_uniform(<span class="number">200</span>))];</span><br><span class="line"></span><br><span class="line">group.animations = @[scale,rotation,position];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.purpleView.layer addAnimation:group forKey:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<h2 id="UIView-animation"><a href="#UIView-animation" class="headerlink" title="UIView animation"></a>UIView animation</h2><p>图层动画都是假象，动画执行过程中，图层的 position 属性一直没有变过</p>
<blockquote>
<p>开发中用的比较多的不是图层动画，除非是<strong>转场动画</strong>。一般开发中用的比较多的是 UIView 动画。</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)animateWithDuration:(<span class="built_in">NSTimeInterval</span>)duration delay:(<span class="built_in">NSTimeInterval</span>)delay options:(<span class="built_in">UIViewAnimationOptions</span>)options animations:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))animations completion:(<span class="keyword">void</span> (^ __<span class="keyword">nullable</span>)(<span class="built_in">BOOL</span> finished))completion <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0);</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)animateWithDuration:(<span class="built_in">NSTimeInterval</span>)duration animations:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))animations completion:(<span class="keyword">void</span> (^ __<span class="keyword">nullable</span>)(<span class="built_in">BOOL</span> finished))completion <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0); <span class="comment">// delay = 0.0, options = 0</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)animateWithDuration:(<span class="built_in">NSTimeInterval</span>)duration animations:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))animations <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0); <span class="comment">// delay = 0.0, options = 0, completion = NULL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Performs `animations` using a timing curve described by the motion of a spring. When `dampingRatio` is 1, the animation will smoothly decelerate to its final model values without oscillating. Damping ratios less than 1 will oscillate more and more before coming to a complete stop. You can use the initial spring velocity to specify how fast the object at the end of the simulated spring was moving before it was attached. It's a unit coordinate system, where 1 is defined as travelling the total animation distance in a second. So if you're changing an object's position by 200pt in this animation, and you want the animation to behave as if the object was moving at 100pt/s before the animation started, you'd pass 0.5. You'll typically want to pass 0 for the velocity. */</span> </span><br><span class="line">+ (<span class="keyword">void</span>)animateWithDuration:(<span class="built_in">NSTimeInterval</span>)duration delay:(<span class="built_in">NSTimeInterval</span>)delay usingSpringWithDamping:(<span class="built_in">CGFloat</span>)dampingRatio initialSpringVelocity:(<span class="built_in">CGFloat</span>)velocity options:(<span class="built_in">UIViewAnimationOptions</span>)options animations:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))animations completion:(<span class="keyword">void</span> (^ __<span class="keyword">nullable</span>)(<span class="built_in">BOOL</span> finished))completion <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">7</span>_0);</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)transitionWithView:(<span class="built_in">UIView</span> *)view duration:(<span class="built_in">NSTimeInterval</span>)duration options:(<span class="built_in">UIViewAnimationOptions</span>)options animations:(<span class="keyword">void</span> (^ __<span class="keyword">nullable</span>)(<span class="keyword">void</span>))animations completion:(<span class="keyword">void</span> (^ __<span class="keyword">nullable</span>)(<span class="built_in">BOOL</span> finished))completion <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0);</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)transitionFromView:(<span class="built_in">UIView</span> *)fromView toView:(<span class="built_in">UIView</span> *)toView duration:(<span class="built_in">NSTimeInterval</span>)duration options:(<span class="built_in">UIViewAnimationOptions</span>)options completion:(<span class="keyword">void</span> (^ __<span class="keyword">nullable</span>)(<span class="built_in">BOOL</span> finished))completion <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0); <span class="comment">// toView added to fromView.superview, fromView removed from its superview</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Performs the requested system-provided animation on one or more views. Specify addtional animations in the parallelAnimations block. These additional animations will run alongside the system animation with the same timing and duration that the system animation defines/inherits. Additional animations should not modify properties of the view on which the system animation is being performed. Not all system animations honor all available options.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)performSystemAnimation:(<span class="built_in">UISystemAnimation</span>)animation onViews:(<span class="built_in">NSArray</span>&lt;__kindof <span class="built_in">UIView</span> *&gt; *)views options:(<span class="built_in">UIViewAnimationOptions</span>)options animations:(<span class="keyword">void</span> (^ __<span class="keyword">nullable</span>)(<span class="keyword">void</span>))parallelAnimations completion:(<span class="keyword">void</span> (^ __<span class="keyword">nullable</span>)(<span class="built_in">BOOL</span> finished))completion <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">7</span>_0);</span><br></pre></td></tr></table></figure>

<h2 id="CADisplayLink"><a href="#CADisplayLink" class="headerlink" title="CADisplayLink"></a>CADisplayLink</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><h4 id="所在框架"><a href="#所在框架" class="headerlink" title="所在框架"></a>所在框架</h4><p>CADisplayLink 和其它 CoreAnimation 类一样，都是在 QuartzCore.framework 里。</p>
<h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><p>CADisplayLink 最主要的特征是能提供一个周期性的调用我们赋给它的 selector 的机制，从这点上看它很像定时器 NSTimer。</p>
<h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startDisplayLink</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.displayLink = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:<span class="keyword">self</span></span><br><span class="line">         selector:<span class="keyword">@selector</span>(handleDisplayLink:)];</span><br><span class="line">    [<span class="keyword">self</span>.displayLink addToRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop]</span><br><span class="line">      forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)handleDisplayLink:(<span class="built_in">CADisplayLink</span> *)displayLink</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)stopDisplayLink</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span>.displayLink invalidate];</span><br><span class="line">    <span class="keyword">self</span>.displayLink = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当把 CADisplayLink 对象 add 到 runloop 中后，selector 就能被周期性调用，类似于 NSTimer 被启动了；</p>
<p>执行 invalidate 操作时， CADisplayLink 对象就会从 runloop 中移除，selector 调用也随即停止，类似于 NSTimer 的 invalidate 方法。</p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><p>下面结合 NSTimer 来介绍 CADisplayLink，与 NSTimer 不同的地方有：</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>CADisplayLink 是一个能让我们以和屏幕刷新率同步的频率将特定的内容画到屏幕上的定时器类。 CADisplayLink 以特定模式注册到 runloop 后， 每当屏幕显示内容刷新结束的时候，runloop 就会向 CADisplayLink 指定的 target 发送一次指定的 selector 消息， CADisplayLink 类对应的 selector 就会被调用一次。 </p>
<p>NSTimer 以指定的模式注册到 runloop 后，每当设定的周期时间到达后，runloop 会向指定的 target 发送一次指定的 selector 消息。</p>
<h4 id="周期设置方式"><a href="#周期设置方式" class="headerlink" title="周期设置方式"></a>周期设置方式</h4><p>iOS设备的屏幕刷新频率(FPS)是60Hz，因此 CADisplayLink的selector 默认调用周期是每秒60次，这个周期可以通过 frameInterval 属性设置， CADisplayLink 的 selector 每秒调用次数 &#x3D; 60 &#x2F; frameInterval。比如当 frameInterval 设为 2，每秒调用就变成 30 次。因此， CADisplayLink 周期的设置方式略显不便。</p>
<h4 id="精确度"><a href="#精确度" class="headerlink" title="精确度"></a>精确度</h4><p>iOS设备的屏幕刷新频率是固定的，CADisplayLink 在正常情况下会在每次刷新结束都被调用，精确度相当高。</p>
<p>NSTimer 的精确度就显得低了点，比如 NSTimer 的触发时间到的时候，runloop 如果在忙于别的调用，触发时间就会推迟到下一个 runloop 周期。更有甚者，在 OS X v10.9 以后为了尽量避免在 NSTimer 触发时间到了而去中断当前处理的任务，NSTimer 新增了 tolerance 属性，让用户可以设置可以容忍的触发的时间范围。</p>
<h4 id="使用场合"><a href="#使用场合" class="headerlink" title="使用场合"></a>使用场合</h4><p>从原理上不难看出， CADisplayLink 使用场合相对专一， 适合做界面的不停重绘，比如视频播放的时候需要不停地获取下一帧用于界面渲染。</p>
<p>NSTimer的使用范围要广泛的多，各种需要单次或者循环定时处理的任务都可以使用。</p>
<h3 id="重要属性"><a href="#重要属性" class="headerlink" title="重要属性"></a>重要属性</h3><p>下面不完整的列出了 CADisplayLink 的几个重要属性：</p>
<h4 id="frameInterval"><a href="#frameInterval" class="headerlink" title="frameInterval"></a>frameInterval</h4><p>可读可写的 NSInteger 型值，标识间隔多少帧调用一次 selector 方法，默认值是1 ，即每帧都调用一次。</p>
<blockquote>
<p>官方文档中强调，当该值被设定小于1时，结果是不可预知的。 </p>
</blockquote>
<h4 id="duration"><a href="#duration" class="headerlink" title="duration"></a>duration</h4><p>只读的 CFTimeInterval 值，表示两次屏幕刷新之间的时间间隔。需要注意的是，该属性在 target 的 selector 被首次调用以后才会被赋值。selector 的调用间隔时间计算方式是：时间 &#x3D; duration × frameInterval。 </p>
<p>现存的 iOS 设备屏幕的 FPS 都是60Hz，这一点可以从 CADisplayLink 的 duration 属性看出来。duration 的值都是0.166666…，即1&#x2F;60。尽管如此，我们并没法确定苹果不会改变 FPS ，如果以后某一天将 FPS 提升到了120Hz了怎么办呢？这时，你设置了 frameInterval 属性值为2期望每秒刷新30次，却发现每秒刷新了60次，结果可想而知，出于安全考虑，还是先根据 duration 判断屏幕的 FPS 再去使用  CADisplayLink 。</p>
<h4 id="timestamp"><a href="#timestamp" class="headerlink" title="timestamp"></a>timestamp</h4><p>只读的 CFTimeInterval 值，表示屏幕显示的上一帧的时间戳，这个属性通常被target 用来计算下一帧中应该显示的内容。<br>打印 timestamp 值，其样式类似于：</p>
<p><code>179699.631584</code></p>
<p>虽然名为时间戳，但这和常见的 unix 时间戳差异很大，事实上这是 CoreAnimation 使用的时间格式。每个 CALayer 都有一个本地时间（CALayer 本地时间的具体作用会在后续文章中说明），可以获取当前 CALayer 的本地时间并打印：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFTimeInterval</span> localLayerTime = [myLayer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">"localLayerTime:%f"</span>,localLayerTime);</span><br></pre></td></tr></table></figure>

<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>iOS并不能保证能以每秒60次的频率调用回调方法，这取决于： </p>
<ul>
<li>CPU的空闲程度</li>
</ul>
<p>如果CPU忙于其它计算，就没法保证以60HZ执行屏幕的绘制动作，导致跳过若干次调用回调方法的机会，跳过次数取决CPU的忙碌程度。 </p>
<ul>
<li>执行回调方法所用的时间</li>
</ul>
<p>如果执行回调时间大于重绘每帧的间隔时间，就会导致跳过若干次回调调用机会，这取决于执行时间长短。 </p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ol>
<li>官方文档</li>
</ol>
<p><a href="https://developer.apple.com/library/ios/documentation/QuartzCore/Reference/CADisplayLink_ClassRef/Reference/Reference.html#//apple_ref/doc/uid/TP40009031-CH1-DontLinkElementID_1" target="_blank" rel="noopener">https://developer.apple.com/library/ios/documentation/QuartzCore/Reference/CADisplayLink_ClassRef/Reference/Reference.html#//apple_ref/doc/uid/TP40009031-CH1-DontLinkElementID_1</a> </p>
<ol start="2">
<li>官方使用CADisplayLink播放视频的例子</li>
</ol>
<p><a href="https://developer.apple.com/library/ios/samplecode/AVBasicVideoOutput/Introduction/Intro.html#//apple_ref/doc/uid/DTS40013109" target="_blank" rel="noopener">https://developer.apple.com/library/ios/samplecode/AVBasicVideoOutput/Introduction/Intro.html#//apple_ref/doc/uid/DTS40013109</a> </p>
<p>本文代码连结：<a href="https://github.com/lizhaoLoveIT/CAAnimation" target="_blank" rel="noopener">CAAnimation</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ammar</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lizhaoloveit.cn/2014/07/20/%E6%A0%B8%E5%BF%83%E5%8A%A8%E7%94%BB/">http://lizhaoloveit.cn/2014/07/20/%E6%A0%B8%E5%BF%83%E5%8A%A8%E7%94%BB/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lizhaoloveit.cn">Ammar's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/iOS/">iOS    </a></div><div class="post_share"><div class="social-share" data-image="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2014/07/20/KVC/"><img class="prev_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>KVC</span></div></a></div><div class="next-post pull-right"><a href="/2014/07/11/Quartz2D/"><img class="next_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Quartz2D</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'http://lizhaoloveit.cn/2014/07/20/%E6%A0%B8%E5%BF%83%E5%8A%A8%E7%94%BB/';
  this.page.identifier = '2014/07/20/核心动画/';
  this.page.title = '核心动画';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'lizhao' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2024 By Ammar</div><div class="icp"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener"><span>浙ICP备19013619号-1</span></a></div><div class="bag"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010502006128" target="_blank" rel="noopener"><img src="/img/beian.png"><span>浙公网安备 33010502006128号</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="far fa-moon nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script async src="/js/search/algolia.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>