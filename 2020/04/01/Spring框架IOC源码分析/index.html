<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Spring框架IOC源码分析 | Ammar's Blog</title><meta name="description" content="Spring框架IOC源码分析"><meta name="keywords" content="Spring"><meta name="author" content="Ammar"><meta name="copyright" content="Ammar"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://lizhaoloveit.cn/2020/04/01/Spring%E6%A1%86%E6%9E%B6IOC%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Spring框架IOC源码分析"><meta name="twitter:description" content="Spring框架IOC源码分析"><meta name="twitter:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Spring框架IOC源码分析"><meta property="og:url" content="http://lizhaoloveit.cn/2020/04/01/Spring%E6%A1%86%E6%9E%B6IOC%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="Ammar's Blog"><meta property="og:description" content="Spring框架IOC源码分析"><meta property="og:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="服务器搭建和配置" href="http://lizhaoloveit.cn/2020/05/10/%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E5%92%8C%E9%85%8D%E7%BD%AE/"><link rel="next" title="MyBatis工作原理" href="http://lizhaoloveit.cn/2020/03/28/MyBatis%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?162506e75ffd64287398566b2f5738c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"VRMKRAV9AT","apiKey":"bd7157400046d0f02396708a501a3480","indexName":"lizhaoloveit","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://lizhaoloveit.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-模块的手写分析"><span class="toc-number">1.</span> <span class="toc-text">Spring 模块的手写分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanFactory-基本的类体系结构。"><span class="toc-number">1.1.</span> <span class="toc-text">BeanFactory 基本的类体系结构。</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#抽象类和实现类"><span class="toc-number">1.1.1.</span> <span class="toc-text">抽象类和实现类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BeanFactory"><span class="toc-number">1.1.2.</span> <span class="toc-text">BeanFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ListableBeanFactory"><span class="toc-number">1.1.3.</span> <span class="toc-text">ListableBeanFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HierarchicalBeanFactory"><span class="toc-number">1.1.4.</span> <span class="toc-text">HierarchicalBeanFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AutowireCapableBeanFactory"><span class="toc-number">1.1.5.</span> <span class="toc-text">AutowireCapableBeanFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigurableBeanFactory"><span class="toc-number">1.1.6.</span> <span class="toc-text">ConfigurableBeanFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigurableListableBeanFactory"><span class="toc-number">1.1.7.</span> <span class="toc-text">ConfigurableListableBeanFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BeanDefinition"><span class="toc-number">1.1.8.</span> <span class="toc-text">BeanDefinition</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#手写-IOC-框架思路"><span class="toc-number">1.2.</span> <span class="toc-text">手写 IOC 框架思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实现"><span class="toc-number">2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#初始化工厂-beanFactory"><span class="toc-number">2.1.</span> <span class="toc-text">初始化工厂 beanFactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#取值"><span class="toc-number">2.2.</span> <span class="toc-text">取值</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringIoc源码"><span class="toc-number">3.</span> <span class="toc-text">SpringIoc源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#循环依赖问题"><span class="toc-number">4.</span> <span class="toc-text">循环依赖问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://lizhaoloveit.cn/blogimages/blog/top_img.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Ammar's Blog</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description">微信号：aicjaish</div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a><a class="site-page" href="/comment/"><i class="fa-fw fa fa-coffee"></i><span> 留言</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Spring框架IOC源码分析</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-04-01<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-04-05</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/">Java</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">7.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 30 分钟</span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="Spring-模块的手写分析"><a href="#Spring-模块的手写分析" class="headerlink" title="Spring 模块的手写分析"></a>Spring 模块的手写分析</h1><hr>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/sourcecode/spring/15852679657744-spring.jpg" alt=""></p>
<blockquote>
<p>Spring 源码阅读注意事项：try catch 和 do开头的方法 重点阅读</p>
</blockquote>
<h2 id="BeanFactory-基本的类体系结构。"><a href="#BeanFactory-基本的类体系结构。" class="headerlink" title="BeanFactory 基本的类体系结构。"></a>BeanFactory 基本的类体系结构。</h2><p>四级接口继承体系：</p>
<ol>
<li>BeanFactory 作为一个主接口不继承任何接口，暂且称为一级接口 <strong>获取 bean，是否包含bean，是否单例与原型，获取bean类型，bean别名 api</strong>。</li>
<li>AutowireCapableBeanFactory<strong>提供工厂的装配功能</strong>、HierarchicalBeanFactory<strong>提供父容器的访问功能</strong>、ListableBeanFactory<strong>容器内 bean 实例的枚举功能</strong> 3个子接口继承它，进行功能上的增强，这3个子接口称为二级接口。</li>
<li>ConfigurableBeanFactory 称为三级接口，对二级接口 HierarchicalBeanFactory 进行了再次增强，还继承了一个外来的接口 SingletonBeanRegistry</li>
<li>ConfigurableListableBeanFactory 是一个更强大的接口，继承了上述所有的接口，四级接口<strong>解析，修改bean定义，并初始化单例</strong></li>
</ol>
<p>接口隔离原则。</p>
<h3 id="抽象类和实现类"><a href="#抽象类和实现类" class="headerlink" title="抽象类和实现类"></a>抽象类和实现类</h3><ol>
<li><code>AbstractBeanFactory</code> 作为一个抽象类，实现了三级接口 <code>ConfigurableBeanFactory</code></li>
<li><code>AbstractAutowireCapableBeanFactory</code> 同样是抽象类，继承自 <code>AbstractBeanFactory</code> ，并额外实现了二级接口 <code>AutowireCapableBeanFactory</code> 大部分功能。</li>
<li><code>DefaultListableBeanFactory</code> 继承自 <code>AbstractAutowireCapableBeanFactory</code> ，实现了最强大的四级接口 <code>ConfigurableListableBeanFactory</code> ，并实现了一个外来接口 <code>BeanDefinitionRegistry</code> ，它并非抽象类。</li>
<li>最后是最强大的 <code>XmlBeanFactory</code> ，继承自 <code>DefaultListableBeanFactory</code> ，重写了一些功能，使自己更强大</li>
</ol>
<blockquote>
<p>为什么要定义这么多层次的接口？<br>每个接口都有适用场合，主要是为了区分在 Spring 内部在操作过程中对象的传递和转化过程，对对象的数据访问所做的限制。例如：<code>ListableBeanFactory</code> 接口表示这些 Bean 是可列表的，而 HierarchicalBeanFactory 表示的是这些 Bean 是有继承关系的，也就是每个 Bean 有可能有父 Bean。<code>AutowireCapableBeanFactory</code> 接口定义 Bean 的自动装配规则。这四个接口共同定义了 Bean 的集合、Bean 之间的关系、以及 Bean 行为。</p>
</blockquote>
<h3 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用来引用一个实例，或把它和工厂产生的Bean区分开</span></span><br><span class="line">    <span class="comment">// 就是说，如果一个FactoryBean的名字为a，</span></span><br><span class="line">    <span class="comment">// 那么，&amp;a会得到那个Factory String FACTORY_BEAN_PREFIX = "&amp;";</span></span><br><span class="line">    <span class="comment">/* * 四个不同形式的getBean方法，获取实例 */</span></span><br><span class="line">    <span class="function">Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">    <span class="function">Object <span class="title">getBean</span><span class="params">(String name, Object... args)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">    <span class="comment">// 是否存在 </span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">containsBean</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="comment">// 是否为单实例 </span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line">    <span class="comment">// 是否为原型（多实例） </span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isPrototype</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line">    <span class="comment">// 名称、类型是否匹配 </span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isTypeMatch</span><span class="params">(String name, Class&lt;?&gt; targetType)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line">    <span class="comment">// 获取类型 </span></span><br><span class="line">    Class&lt;?&gt; getType(String name) <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line">    <span class="comment">// 根据实例的名字获取实例的别名 </span></span><br><span class="line">    String[] getAliases(String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BeanFactory 中只对 IOC 容器的基本行为作了定义，根本不关心 Bean 是如何定义怎样加载的，只关心工厂里得到什么产品对象，至于怎样生产这些对象，这个接口不关心。</p>
<h3 id="ListableBeanFactory"><a href="#ListableBeanFactory" class="headerlink" title="ListableBeanFactory"></a>ListableBeanFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ListableBeanFactory</span> <span class="keyword">extends</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 对于给定的名字是否含有</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">containsBeanDefinition</span><span class="params">(String beanName)</span></span>;</span><br><span class="line">    <span class="comment">// 返回工厂的BeanDefinition总数</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getBeanDefinitionCount</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 返回工厂中所有Bean的名字</span></span><br><span class="line">    String[] getBeanDefinitionNames();</span><br><span class="line">    <span class="comment">// 返回对于指定类型Bean（包括子类）的所有名字</span></span><br><span class="line">    String[] getBeanNamesForType(Class&lt;?&gt; type);,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回指定类型的名字</span></span><br><span class="line"><span class="comment">     * includeNonSingletons为false表示只取单例Bean，true则不是</span></span><br><span class="line"><span class="comment">     * allowEagerInit为true表示立刻加载，false表示延迟加载。</span></span><br><span class="line"><span class="comment">     * 注意：FactoryBeans都是立刻加载的。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] getBeanNamesForType(Class&lt;?&gt; type, <span class="keyword">boolean</span> includeNonSingletons, <span class="keyword">boolean</span> allowEagerInit);</span><br><span class="line">    <span class="comment">// 根据类型（包括子类）返回指定Bean名和Bean的Map</span></span><br><span class="line">    &lt;T&gt; <span class="function">Map&lt;String, T&gt; <span class="title">getBeansOfType</span><span class="params">(Class&lt;T&gt; type)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">    &lt;T&gt; <span class="function">Map&lt;String, T&gt; <span class="title">getBeansOfType</span><span class="params">(Class&lt;T&gt; type,)</span><span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">    <span class="comment">// 根据注解类型，查找所有有这个注解的Bean名和Bean的Map</span></span><br><span class="line">    <span class="function">Map&lt;String, Object&gt; <span class="title">getBeansWithAnnotation</span><span class="params">(Class&lt;? extends Annotation&gt; annotationType)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">    <span class="comment">// 根据指定Bean名和注解类型查找指定的Bean</span></span><br><span class="line">    &lt;A extends Annotation&gt; <span class="function">A <span class="title">findAnnotationOnBean</span><span class="params">(String beanName, Class&lt;A&gt; annotationType)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ListableBeanFactory 3个跟BeanDefinition 有关的总体操作，包括 BeanDefinition 的总数、名字的集合、指定类型的名字的集合。</p>
<blockquote>
<p>BeanDefinition 是 Spring 中非常重要的一个类，每个 BeanDefinition 实例都包含一个类在 Spring 工厂中的所有属性。</p>
</blockquote>
<ul>
<li><p>两个 getBeanNamesForType 重载方法，根据指定类型(包括子类)获取其对应的所有 Bean 名字</p>
</li>
<li><p>两个 getBeansOfType 重载方法，根据类型(包括子类) 返回指定 Bean 名和 Bean 的Map</p>
</li>
<li><p>2个跟注解查找有关的方法，根据注解类型，查找 Bean 名和 Bean 的 Map，根据指定 Bean 名和注解类型查找指定 Bean</p>
</li>
</ul>
<p>这个工厂的最大特点就是可以列出工厂可以生产的所有实例。工厂并不能直接生产，但是可以返回指定类型的所有实例。</p>
<h3 id="HierarchicalBeanFactory"><a href="#HierarchicalBeanFactory" class="headerlink" title="HierarchicalBeanFactory"></a>HierarchicalBeanFactory</h3><p>分层的Bean工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HierarchicalBeanFactory</span> <span class="keyword">extends</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 返回本Bean工厂的父工厂</span></span><br><span class="line">    <span class="function">BeanFactory <span class="title">getParentBeanFactory</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 本地工厂是否包含这个Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">containsLocalBean</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个方法返回 Bean 工厂的父工厂，这个方法实现了工厂的分级<br>第二个方法判断本地工厂是否包含这个 Bean(忽略其他所有父工厂)</p>
<h3 id="AutowireCapableBeanFactory"><a href="#AutowireCapableBeanFactory" class="headerlink" title="AutowireCapableBeanFactory"></a>AutowireCapableBeanFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 表明工厂没有自动装配的 Bean</span></span><br><span class="line">	<span class="keyword">int</span> AUTOWIRE_NO = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 根据名称自动装配</span></span><br><span class="line">	<span class="keyword">int</span> AUTOWIRE_BY_NAME = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// 根据类型自动装配</span></span><br><span class="line">	<span class="keyword">int</span> AUTOWIRE_BY_TYPE = <span class="number">2</span>;</span><br><span class="line">	<span class="comment">// 根据构造方法快速装配</span></span><br><span class="line">	<span class="keyword">int</span> AUTOWIRE_CONSTRUCTOR = <span class="number">3</span>;</span><br><span class="line">	<span class="comment">// 根据指定 Class 创建一个全新的 Bean 实例</span></span><br><span class="line">	&lt;T&gt; <span class="function">T <span class="title">createBean</span><span class="params">(Class&lt;T&gt; beanClass)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	<span class="comment">// 给定对象，根据注解、后处理器等，进行自动装配</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">autowireBean</span><span class="params">(Object existingBean)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	<span class="comment">// 根据Bean名的BeanDefinition装配这个未加工的Object，执行回调和各种后处理器。</span></span><br><span class="line">	<span class="function">Object <span class="title">configureBean</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 根据给定的类型和指定的装配策略，创建一个新的Bean实例</span></span><br><span class="line">	<span class="function">Object <span class="title">createBean</span><span class="params">(Class&lt;?&gt; beanClass, <span class="keyword">int</span> autowireMode, <span class="keyword">boolean</span> dependencyCheck)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	<span class="comment">// 	与上面类似，不过稍有不同。</span></span><br><span class="line">	<span class="function">Object <span class="title">autowire</span><span class="params">(Class&lt;?&gt; beanClass, <span class="keyword">int</span> autowireMode, <span class="keyword">boolean</span> dependencyCheck)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	<span class="comment">// 根据名称或类型自动装配</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">autowireBeanProperties</span><span class="params">(Object existingBean, <span class="keyword">int</span> autowireMode, <span class="keyword">boolean</span> dependencyCheck)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	<span class="comment">// 也是自动装配</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">applyBeanPropertyValues</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	<span class="comment">// 初始化一个 Bean...</span></span><br><span class="line">	<span class="function">Object <span class="title">initializeBean</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	<span class="comment">// 初始化之前执行BeanPostProcessors</span></span><br><span class="line">	<span class="function">Object <span class="title">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	<span class="comment">// 初始化之后执行BeanPostProcessors</span></span><br><span class="line">	<span class="function">Object <span class="title">applyBeanPostProcessorsAfterInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">destroyBean</span><span class="params">(Object existingBean)</span></span>;</span><br><span class="line">	&lt;T&gt; <span class="function">NamedBeanHolder&lt;T&gt; <span class="title">resolveNamedBean</span><span class="params">(Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 分解指定的依赖</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">Object <span class="title">resolveDependency</span><span class="params">(DependencyDescriptor descriptor, @Nullable String requestingBeanName)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">	<span class="comment">// 分解指定的依赖</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">Object <span class="title">resolveDependency</span><span class="params">(DependencyDescriptor descriptor, @Nullable String requestingBeanName, @Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5个静态不可变常量指明装配策略。8个跟自动装配有关的方法，2个执行 BeanPostProcessors 方法，2个分解指定依赖的方法。</p>
<blockquote>
<p>根据定义 BeanDefinition 装配 Bean。执行前、后处理器等。</p>
</blockquote>
<h3 id="ConfigurableBeanFactory"><a href="#ConfigurableBeanFactory" class="headerlink" title="ConfigurableBeanFactory"></a>ConfigurableBeanFactory</h3><p>复杂的配置Bean工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableBeanFactory</span> <span class="keyword">extends</span> <span class="title">HierarchicalBeanFactory</span>, <span class="title">SingletonBeanRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String SCOPE_SINGLETON = <span class="string">"singleton"</span>;</span><br><span class="line"></span><br><span class="line">	String SCOPE_PROTOTYPE = <span class="string">"prototype"</span>;</span><br><span class="line">	<span class="comment">// 搭配HierarchicalBeanFactory接口的getParentBeanFactory方法</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setParentBeanFactory</span><span class="params">(BeanFactory parentBeanFactory)</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">	<span class="comment">// 设置、返回工厂的类加载器</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(@Nullable ClassLoader beanClassLoader)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">ClassLoader <span class="title">getBeanClassLoader</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 设置、返回一个临时的类加载器</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setTempClassLoader</span><span class="params">(@Nullable ClassLoader tempClassLoader)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">ClassLoader <span class="title">getTempClassLoader</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 设置、是否缓存元数据，如果false，那么每次请求实例，都会从类加载器重新加载（热加载）</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setCacheBeanMetadata</span><span class="params">(<span class="keyword">boolean</span> cacheBeanMetadata)</span></span>;</span><br><span class="line">	<span class="comment">// 是否缓存元数据</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isCacheBeanMetadata</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// Bean表达式分解器</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setBeanExpressionResolver</span><span class="params">(@Nullable BeanExpressionResolver resolver)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">BeanExpressionResolver <span class="title">getBeanExpressionResolver</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 设置、返回一个转换服务</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setConversionService</span><span class="params">(@Nullable ConversionService conversionService)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">ConversionService <span class="title">getConversionService</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 设置属性编辑登记员...</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addPropertyEditorRegistrar</span><span class="params">(PropertyEditorRegistrar registrar)</span></span>;</span><br><span class="line">	<span class="comment">// 注册常用属性编辑器</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">registerCustomEditor</span><span class="params">(Class&lt;?&gt; requiredType, Class&lt;? extends PropertyEditor&gt; propertyEditorClass)</span></span>;</span><br><span class="line">	<span class="comment">// 用工厂中注册的通用的编辑器初始化指定的属性编辑注册器</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">copyRegisteredEditorsTo</span><span class="params">(PropertyEditorRegistry registry)</span></span>;</span><br><span class="line">	<span class="comment">// 设置、得到一个类型转换器</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setTypeConverter</span><span class="params">(TypeConverter typeConverter)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">TypeConverter <span class="title">getTypeConverter</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 增加一个嵌入式的StringValueResolver</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addEmbeddedValueResolver</span><span class="params">(StringValueResolver valueResolver)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">hasEmbeddedValueResolver</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 分解指定的嵌入式的值</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">String <span class="title">resolveEmbeddedValue</span><span class="params">(String value)</span></span>;</span><br><span class="line">	<span class="comment">// 设置一个Bean后处理器</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addBeanPostProcessor</span><span class="params">(BeanPostProcessor beanPostProcessor)</span></span>;</span><br><span class="line">	<span class="comment">// 返回Bean后处理器的数量</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getBeanPostProcessorCount</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 注册范围</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">registerScope</span><span class="params">(String scopeName, Scope scope)</span></span>;</span><br><span class="line">	<span class="comment">// 返回注册的范围名</span></span><br><span class="line">	String[] getRegisteredScopeNames();</span><br><span class="line">	<span class="comment">// 返回指定的范围</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">Scope <span class="title">getRegisteredScope</span><span class="params">(String scopeName)</span></span>;</span><br><span class="line">	<span class="comment">// 返回本工厂的一个安全访问上下文</span></span><br><span class="line">	<span class="function">AccessControlContext <span class="title">getAccessControlContext</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 从其他的工厂复制 相关的所有配置</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">copyConfigurationFrom</span><span class="params">(ConfigurableBeanFactory otherFactory)</span></span>;</span><br><span class="line">	<span class="comment">// 给指定的Bean注册别名</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String beanName, String alias)</span> <span class="keyword">throws</span> BeanDefinitionStoreException</span>;</span><br><span class="line">	<span class="comment">// 根据指定的 StringValueResolver移除所有的别名</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">resolveAliases</span><span class="params">(StringValueResolver valueResolver)</span></span>;</span><br><span class="line">	<span class="comment">// 返回指定Bean合并后的Bean定义</span></span><br><span class="line">	<span class="function">BeanDefinition <span class="title">getMergedBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line">	<span class="comment">// /判断指 定Bean是否为一个工厂Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isFactoryBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line">	<span class="comment">// 设置一个Bean是 否正在创建</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setCurrentlyInCreation</span><span class="params">(String beanName, <span class="keyword">boolean</span> inCreation)</span></span>;</span><br><span class="line">	<span class="comment">// 返回指定Bean是否已经成功创建</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isCurrentlyInCreation</span><span class="params">(String beanName)</span></span>;</span><br><span class="line">	<span class="comment">// 注册一个 依赖于指定bean的Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">registerDependentBean</span><span class="params">(String beanName, String dependentBeanName)</span></span>;</span><br><span class="line">	<span class="comment">// 返回依赖于指定Bean的所欲Bean名</span></span><br><span class="line">	String[] getDependentBeans(String beanName);</span><br><span class="line">	<span class="comment">// 返回指定Bean依赖的所有Bean名</span></span><br><span class="line">	String[] getDependenciesForBean(String beanName);</span><br><span class="line">	<span class="comment">// 销毁指定的Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">destroyBean</span><span class="params">(String beanName, Object beanInstance)</span></span>;</span><br><span class="line">	<span class="comment">// 销毁指定范围Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">destroyScopedBean</span><span class="params">(String beanName)</span></span>;</span><br><span class="line">	<span class="comment">// 销毁所有单例类</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">destroySingletons</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConfigurableListableBeanFactory"><a href="#ConfigurableListableBeanFactory" class="headerlink" title="ConfigurableListableBeanFactory"></a>ConfigurableListableBeanFactory</h3><p>BeanFactory的集大成者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableListableBeanFactory</span></span></span><br><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">ListableBeanFactory</span>, <span class="title">AutowireCapableBeanFactory</span>, <span class="title">ConfigurableBeanFactory</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ignoreDependencyType</span><span class="params">(Class&lt;?&gt; type)</span></span>; <span class="comment">// 忽略自动装配的依赖类型</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ignoreDependencyInterface</span><span class="params">(Class&lt;?&gt; ifc)</span></span>; <span class="comment">// 忽略自动装配的接口</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">registerResolvableDependency</span><span class="params">(Class&lt;?&gt; dependencyType, @Nullable Object autowiredValue)</span></span>; <span class="comment">// 注册一个可分解的依赖</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isAutowireCandidate</span><span class="params">(String beanName, DependencyDescriptor descriptor)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> NoSuchBeanDefinitionException</span>; <span class="comment">// 判断指定的Bean是否有资格作为自动装配的候选者</span></span><br><span class="line">	<span class="comment">// 返回注册的Bean定义</span></span><br><span class="line">	<span class="function">BeanDefinition <span class="title">getBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line">	<span class="function">Iterator&lt;String&gt; <span class="title">getBeanNamesIterator</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clearMetadataCache</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 暂时冻结所有的Bean配置</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">freezeConfiguration</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 判断本工厂配置是否被冻结</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isConfigurationFrozen</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 使所有的非延迟加载的单例类都实例化。</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>工厂接口 <code>ConfigurableListableBeanFactory</code> 同时继承了3个接口， <code>ListableBeanFactory</code> 、<code>AutowireCapableBeanFactory</code> 和 <code>ConfigurableBeanFactory</code> ，扩展之后，加上自有的这8个方法，这个工厂接口总共有83个方法，实在是巨大到不行了。这个工厂接口的自有方法总体上只是对父类接口功能的补 充，包含了 BeanFactory 体系目前的所有方法，可以说是接口的集大成者。</p>
<h3 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h3><p><img src="https://www.lizhaoloveit.cn/blogimages/java/sourcecode/spring/15852758596039-spring.jpg" alt=""></p>
<h2 id="手写-IOC-框架思路"><a href="#手写-IOC-框架思路" class="headerlink" title="手写 IOC 框架思路"></a>手写 IOC 框架思路</h2><hr>
<ol>
<li>读取配置文件的 bean 信息</li>
<li>将 bean 信息封装到 BeanDefinition 集合对象中</li>
<li>根据传递过来的 beanName 参数去 BeanDefinition 集合中查找对应的 BeanDefinition 信息</li>
<li>根据 BeanDefinition 中的信息去创建 Bean 的实例。<ul>
<li>a.根据 class 信息包括里面的 constructor-arg 通过反射进行实例化</li>
<li>b.根据 BeanDefinition 中封装的属性信息集合去挨个给对象赋值</li>
<li>c.根据 initMethod 方法区调用对象的初始化操作</li>
</ul>
</li>
</ol>
<blockquote>
<p>如果 singletonObjects 中已经包含了我们要找的对象，就不需要再创建了。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">	Map&lt;String, BeanDefination&gt; beanDefinations = <span class="keyword">new</span> HashMap&lt;&gt;;</span><br><span class="line">	Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">	BeanFactory() &#123;</span><br><span class="line">		<span class="comment">// 读取配置文件的 bean 信息</span></span><br><span class="line">		<span class="comment">// 将 bean 信息封装到 BeanDefinition 对象中</span></span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * 对 bean 标签解析</span></span><br><span class="line"><span class="comment">			 * class</span></span><br><span class="line"><span class="comment">			 * id</span></span><br><span class="line"><span class="comment">			 * init-method</span></span><br><span class="line"><span class="comment">			 * property 标签信息---PropertyValue 对象</span></span><br><span class="line"><span class="comment">			 * name 信息</span></span><br><span class="line"><span class="comment">			 * value 信息 value 属性---属性值、属性类型(属性赋值的时候，需要进行类型转换) TypeStringValue</span></span><br><span class="line"><span class="comment">			 * 				ref 属性 RuntimeBeanReference(bean 的名称) 根据 bean 的名称获取</span></span><br><span class="line"><span class="comment">			 * 			 			bean实例再赋值</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">		<span class="comment">// 将 BeanDefinition 放入合集对象中</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 1. 如果 singletonObjects 中已经包含了我们要找的对象，就不需要再创建了。</span></span><br><span class="line">		<span class="comment">// 2. 读取配置文件的 bean 信息</span></span><br><span class="line">		<span class="comment">// 3. 将 bean 信息封装到 BeanDefinition 集合对象中</span></span><br><span class="line">		<span class="comment">// 4. 根据传递过来的 beanName 参数去 BeanDefinition 集合中查找对应的 BeanDefinition 信息</span></span><br><span class="line">		<span class="comment">// 5. 根据 BeanDefinition 中的信息去创建 Bean 的实例。</span></span><br><span class="line">				<span class="comment">// - a.根据 class 信息包括里面的 constructor-arg 通过反射进行实例化</span></span><br><span class="line">				<span class="comment">// - b.根据 BeanDefinition 中封装的属性信息集合去挨个给对象赋值</span></span><br><span class="line">				<span class="comment">// - c.根据 initMethod 方法区调用对象的初始化操作</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><hr>
<p>在阅读源码时，需要抓住主线，在手写框架时也一样，先写使用。再写实现</p>
<p>pom.xml中引入自己的框架</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.lizhaoloveit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-framework-custom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>bean.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"student"</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.spring.po.Student"</span> <span class="attr">init-method</span>=<span class="string">"initMethod"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- String类型 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"zengkeyan"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 引用类型 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"course"</span> <span class="attr">ref</span>=<span class="string">"course"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 该类有一个初始化方法 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"course"</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.spring.po.Course"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">init-method</span>=<span class="string">"init"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- String类型 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"spring"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- Integer类型 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">"18"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> Course course;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"初始化方法"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"销毁方法"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Course</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> Integer age;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"我是对象初始化方法"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String location = <span class="string">"classpath:beans.xml"</span>;</span><br><span class="line">    <span class="comment">// 创建工厂</span></span><br><span class="line">    BeanFactory beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory(location);</span><br><span class="line">    <span class="comment">// 从工厂中获取指定对象</span></span><br><span class="line">    Student student = beanFactory.getBeans(Student.class);</span><br><span class="line">    <span class="comment">// 从工厂中获取指定对象</span></span><br><span class="line">    Student student1 = (Student) beanFactory.getBeans(<span class="string">"student"</span>);</span><br><span class="line">    <span class="comment">// 测试对象是否可用</span></span><br><span class="line">    System.out.println(student);</span><br><span class="line">    System.out.println(student1);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 运行结果如下：</span></span><br><span class="line">我是对象初始化方法</span><br><span class="line">初始化方法</span><br><span class="line">初始化方法</span><br><span class="line">Student(name=zengkeyan, course=Course(name=spring, age=<span class="number">18</span>))</span><br><span class="line">Student(name=zengkeyan, course=Course(name=spring, age=<span class="number">18</span>))</span><br></pre></td></tr></table></figure>

<h2 id="初始化工厂-beanFactory"><a href="#初始化工厂-beanFactory" class="headerlink" title="初始化工厂 beanFactory"></a>初始化工厂 beanFactory</h2><hr>
<p>根据源码分析，先定义顶层逻辑：</p>
<p>BeanFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">getBeans</span><span class="params">(String beanName)</span></span>;</span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getBeans</span><span class="params">(Class&lt;T&gt; clazz)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据分析，为了避免循环引用导致对象创建失败，我们需要先将xml中的文本中的信息封装在BeanDefinition类中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanDefinition</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String beanName;        <span class="comment">// bean的标识(可能是id，也可能是根据类型命名)</span></span><br><span class="line">    <span class="keyword">private</span> String beanClassName;   <span class="comment">// bean的Class权限名</span></span><br><span class="line">    <span class="keyword">private</span> String initMethod;      <span class="comment">// 初始化方法</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;PropertyValue&gt; propertyValues = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// bean 中包含哪些属性</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BeanDefinition</span><span class="params">(String clzName, String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanClassName = clzName;</span><br><span class="line">        <span class="keyword">this</span>.beanName = beanName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPropertyValue</span><span class="params">(PropertyValue propertyValue)</span> </span>&#123;</span><br><span class="line">        propertyValues.add(propertyValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>抽象类：AbstractBeanFactory，完成其他实现方便扩展。拆分接口，使其可以有更多的功能拆分，结构更明确。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanFactory</span> <span class="keyword">implements</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBeans</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBeans</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitionClz</span><span class="params">(String simpleName, BeanDefinition beanDefinition)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>new DefaultListableBeanFactory(location);</code>根据 location 初始化beanFactory。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultListableBeanFactory</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//注册资源类(从哪里获取资源)</span></span><br><span class="line">    registResource();</span><br><span class="line">    <span class="comment">// 注册类型转换器</span></span><br><span class="line">    registConverters();</span><br><span class="line">    <span class="comment">// 不清楚 location 字符串到底代表的类路径下的 xml 或者是 绝对路径下的 xml 或者网络中的 xml</span></span><br><span class="line">    Resource resource = getResource(location);</span><br><span class="line">    <span class="comment">// 获取了资源对象，根据资源对象创建 BeanDefinitions，此时需要个解析器</span></span><br><span class="line">    XmlBeanDefinitionParser parser = <span class="keyword">new</span> XmlBeanDefinitionParser();</span><br><span class="line">    parser.loadBeanDefinations(<span class="keyword">this</span>, resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Resource 接口用于根据不同的方式来获取资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCanRead</span><span class="params">(String location)</span></span>;</span><br><span class="line">    <span class="function">InputStream <span class="title">getInputStream</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现类 ClassPathResource</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassPathResource</span> <span class="keyword">implements</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String location;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCanRead</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (location == <span class="keyword">null</span> || <span class="string">""</span>.equals(location)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (location.startsWith(<span class="string">"classpath:"</span>)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.location = location;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (location == <span class="keyword">null</span> || <span class="string">""</span>.equals(location)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        String replace = location.replace(<span class="string">"classpath:"</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(replace);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将资源实现类，加入 DefaultListableBeanFactory 的资源列表，如果有更多途经，可以添加更多的类，本着对修改关闭，对扩展开放的开闭原则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    resources.add(<span class="keyword">new</span> ClassPathResource());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拿到资源流后，根据资源创建 BeanDefinitions，此时需要一个解析器，将xml中的内容解析为 BeanDefinition 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBeanDefinitionParser</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBeanDefinations</span><span class="params">(DefaultListableBeanFactory beanFactory, Resource resource)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 读取文件的配置信息</span></span><br><span class="line">        InputStream inputStream = resource.getInputStream();</span><br><span class="line">        Document document = DocumentReader.createDocument(inputStream);</span><br><span class="line">        XmlBeanDefinitionDocumentReader reader = <span class="keyword">new</span> XmlBeanDefinitionDocumentReader(beanFactory);</span><br><span class="line">        reader.loadBeanDefinitions(document.getRootElement());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在每一处有可能有扩展的地方，使用面向对象的思想，<code>XmlBeanDefinitionDocumentReader</code>专门解析 Document。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBeanDefinitionDocumentReader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> DefaultListableBeanFactory beanFactory;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XmlBeanDefinitionDocumentReader</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(Element rootElement)</span> </span>&#123;</span><br><span class="line">        List&lt;Element&gt; elements = rootElement.elements();</span><br><span class="line">        <span class="keyword">for</span> (Element element : elements) &#123;</span><br><span class="line">            <span class="comment">// 获取标签名称</span></span><br><span class="line">            String name = element.getName();</span><br><span class="line">            <span class="comment">// 判断是否为 bean标签</span></span><br><span class="line">            <span class="keyword">if</span> (name.equals(<span class="string">"bean"</span>)) &#123;</span><br><span class="line">                parseBeansElement(element);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parseCustomElement(element);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.将bean信息封装到BeanDefinition对象中</span></span><br><span class="line">        <span class="comment">// 对bean标签解析解析</span></span><br><span class="line">        <span class="comment">// class信息</span></span><br><span class="line">        <span class="comment">// id信息</span></span><br><span class="line">        <span class="comment">// init-method信息</span></span><br><span class="line">        <span class="comment">// property标签信息----PropertyValue对象（name和value）</span></span><br><span class="line">        <span class="comment">// name信息</span></span><br><span class="line">        <span class="comment">// value信息</span></span><br><span class="line">        <span class="comment">// value属性---属性值、属性类型（属性赋值的时候，需要进行类型转换）TypedStringValue</span></span><br><span class="line">        <span class="comment">// ref属性---RuntimeBeanReference(bean的名称)---根据bean的名称获取bean的实例，将获取到的实例赋值该对象</span></span><br><span class="line">        <span class="comment">// 3.再将BeanDefinition放入beanDefinations集合对象中</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * bean element</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> element beanElement</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBeansElement</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (element == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取 id class init-method</span></span><br><span class="line">            String id = element.attributeValue(<span class="string">"id"</span>);</span><br><span class="line">            String name = element.attributeValue(<span class="string">"name"</span>);</span><br><span class="line">            String clzName = element.attributeValue(<span class="string">"class"</span>);</span><br><span class="line">            Class&lt;?&gt; clzType = Class.forName(clzName);</span><br><span class="line">            String initMethod = element.attributeValue(<span class="string">"init-method"</span>);</span><br><span class="line">            <span class="comment">// 保存到 BeanDefinition 类中</span></span><br><span class="line">            String beanName = id == <span class="keyword">null</span> ? name : id;</span><br><span class="line">            beanName = beanName == <span class="keyword">null</span> ? clzType.getSimpleName() : beanName;</span><br><span class="line">            BeanDefinition beanDefinition = <span class="keyword">new</span> BeanDefinition(clzName, beanName);</span><br><span class="line">            beanDefinition.setInitMethod(initMethod);</span><br><span class="line">            <span class="comment">// 获取 property 标签</span></span><br><span class="line">            List&lt;Element&gt; propertyElements = element.elements();</span><br><span class="line">            <span class="keyword">for</span> (Element propertyElement : propertyElements) &#123;</span><br><span class="line">                parsePropertyElement(beanDefinition, propertyElement);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 注册 BeanDefinition 信息</span></span><br><span class="line">            registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line">            registerBeanDefinitionClass(clzType.getSimpleName(), beanDefinition);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parsePropertyElement</span><span class="params">(BeanDefinition beanDefinition, Element propertyElement)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (propertyElement == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 获取 name 属性</span></span><br><span class="line">        String name = propertyElement.attributeValue(<span class="string">"name"</span>);</span><br><span class="line">        String value = propertyElement.attributeValue(<span class="string">"value"</span>);</span><br><span class="line">        String ref = propertyElement.attributeValue(<span class="string">"ref"</span>);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; !value.equals(<span class="string">""</span>) &amp;&amp; ref != <span class="keyword">null</span> &amp;&amp; !ref.equals(<span class="string">""</span>)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        PropertyValue propertyValue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; !value.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            <span class="comment">// 不是引用类型，因为 xml 中的 value 是String 类型，而成员变量的类型可能是各种各样的，所以要存储类型</span></span><br><span class="line">            Class&lt;?&gt; classType = ReflectUtils.getTypeByFieldName(beanDefinition.getBeanClassName(), name);</span><br><span class="line">            TypeStringValue typeStringValue = <span class="keyword">new</span> TypeStringValue(value, classType);</span><br><span class="line">            propertyValue = <span class="keyword">new</span> PropertyValue(name, typeStringValue);</span><br><span class="line">            beanDefinition.addPropertyValue(propertyValue);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ref != <span class="keyword">null</span> &amp;&amp; !ref.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            RuntimeBeanReference reference = <span class="keyword">new</span> RuntimeBeanReference(ref);</span><br><span class="line">            propertyValue = <span class="keyword">new</span> PropertyValue(name, reference);</span><br><span class="line">            beanDefinition.addPropertyValue(propertyValue);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseCustomElement</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitionClass</span><span class="params">(String simpleName, BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanFactory.registerBeanDefinitionClz(simpleName, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanFactory.registerBeanDefinition(beanName, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line">解析的过程实际上就是把xml中的Bean标签中的内容填给 BeanDefinition 对象。</span><br><span class="line">值得一说的是 `property` 标签的解析，因为 property 可能有引用类型和数值类型的值。因此在赋值时，需要将两种类型分别创建对象</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyValue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Object value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// value 有可能是数值或者引用类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeStringValue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; classType;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 数值类型也有很多类型。</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeBeanReference</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String ref;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 引用类型实际上只需要从容器中寻找对应的值就行了。</span></span><br></pre></td></tr></table></figure>
<p>以上，初始化的过程就完结了。</p>
<h2 id="取值"><a href="#取值" class="headerlink" title="取值"></a>取值</h2><hr>
<p>取值的过程实际上就是把 BeanDefinition 中的信息通过反射创建对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getBeans</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">    Object instance = singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span> (instance != <span class="keyword">null</span>) <span class="keyword">return</span> instance;</span><br><span class="line">    <span class="comment">// 2.如果singletonObjects中已经没有包含我们要找的对象，那么根据传递过来的beanName参数去BeanDefinition集合中查找对应的BeanDefinition信息</span></span><br><span class="line">    BeanDefinition beanDefinition = getBeanDefinitionIds().get(beanName);</span><br><span class="line">    String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">    instance = createBeanInstance(beanClassName, <span class="keyword">null</span>);</span><br><span class="line">    setProperty(instance, beanDefinition);</span><br><span class="line">    initBean(instance, beanDefinition);</span><br><span class="line">    singletonObjects.put(beanName, instance);</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBeans</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 优化方案</span></span><br><span class="line">    <span class="comment">// 给对象起个名，在xml配置文件中，建立名称和对象的映射关系</span></span><br><span class="line">    <span class="comment">// 1.如果singletonObjects中已经包含了我们要找的对象，就不需要再创建了。</span></span><br><span class="line">    String clazzSimpleName = clazz.getSimpleName();</span><br><span class="line">    T instance = (T) singletonObjects.get(clazzSimpleName);</span><br><span class="line">    <span class="keyword">if</span> (instance != <span class="keyword">null</span>) <span class="keyword">return</span> instance;</span><br><span class="line">    <span class="comment">// 2.如果singletonObjects中已经没有包含我们要找的对象，那么根据传递过来的beanName参数去BeanDefinition集合中查找对应的BeanDefinition信息</span></span><br><span class="line">    BeanDefinition beanDefinition = getBeanDefinitionClzs().get(clazzSimpleName);</span><br><span class="line">    <span class="comment">// 3.根据BeanDefinition中的信息去创建Bean的实例。</span></span><br><span class="line">    String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">    <span class="comment">// a)根据class信息包括里面的constructor-arg通过反射进行实例化</span></span><br><span class="line">    instance = (T) createBeanInstance(beanClassName, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// b)根据BeanDefinition中封装的属性信息集合去挨个给对象赋值。</span></span><br><span class="line">    <span class="comment">// 设置参数</span></span><br><span class="line">    <span class="comment">// 类型转换</span></span><br><span class="line">    <span class="comment">// 反射赋值</span></span><br><span class="line">    setProperty(instance, beanDefinition);</span><br><span class="line">    <span class="comment">// c)根据initMethod方法去调用对象的初始化操作</span></span><br><span class="line">    initBean(instance, beanDefinition);</span><br><span class="line">    singletonObjects.put(clazzSimpleName, instance);</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">initBean</span><span class="params">(T instance, BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class="line">    String initMethod = beanDefinition.getInitMethod();</span><br><span class="line">    <span class="keyword">if</span> (initMethod == <span class="keyword">null</span> || initMethod.equals(<span class="string">""</span>)) <span class="keyword">return</span>;</span><br><span class="line">    ReflectUtils.invokeMethod(instance, initMethod, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">setProperty</span><span class="params">(T instance, BeanDefinition beanDefinition)</span> </span>&#123;</span><br><span class="line">    List&lt;PropertyValue&gt; propertyValues = beanDefinition.getPropertyValues();</span><br><span class="line">    <span class="keyword">for</span> (PropertyValue propertyValue : propertyValues) &#123;</span><br><span class="line">        String name = propertyValue.getName();</span><br><span class="line">        Object value = propertyValue.getValue();</span><br><span class="line"></span><br><span class="line">        Object trueValue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> TypeStringValue) &#123;</span><br><span class="line">            TypeStringValue typeStringValue = (TypeStringValue) value;</span><br><span class="line">            String stringValue = typeStringValue.getValue();</span><br><span class="line">            Class&lt;?&gt; clazz = typeStringValue.getClassType();</span><br><span class="line">            <span class="comment">// 使用类型转换器进行转换</span></span><br><span class="line">            <span class="keyword">for</span> (TypeConverter typeConverter : typeConverters) &#123;</span><br><span class="line">                <span class="keyword">if</span> (typeConverter.isType(clazz)) &#123;</span><br><span class="line">                    trueValue = typeConverter.convert(stringValue);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> RuntimeBeanReference) &#123;</span><br><span class="line">            RuntimeBeanReference reference = (RuntimeBeanReference) value;</span><br><span class="line">            String ref = reference.getRef();</span><br><span class="line">            trueValue = getBeans(ref);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 值类型转换完后 使用反射赋值</span></span><br><span class="line">        ReflectUtils.setProperty(instance, name, trueValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createBeanInstance</span><span class="params">(String beanClassName, Object... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ReflectUtils.createObject(beanClassName, args);</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">需要说明的是，在给属性 property 赋值时，如果值类型为数据类型，则需要进行类型转换，将字符串转换成对应的数据类型。这里就需要用到类型转换器，`TypeConverter` 的作用就是识别类型并且将字符串类型的数据转换为其他数据类型。</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isType</span><span class="params">(Class&lt;?&gt; clazz)</span></span>;</span><br><span class="line">    <span class="function">Object <span class="title">convert</span><span class="params">(String source)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerTypeConverter</span> <span class="keyword">implements</span> <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Integer <span class="title">convert</span><span class="params">(String source)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Integer.parseInt(source);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isType</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clazz == Integer.class;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTypeConverter</span> <span class="keyword">implements</span> <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isType</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clazz == String.class;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">convert</span><span class="params">(String source)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> source;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码还用到了两个工具类，将反射的操作进行了封装，封装了 dom4j 的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DocumentReader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Document <span class="title">createDocument</span><span class="params">(InputStream inputStream)</span> </span>&#123;</span><br><span class="line">        Document document = <span class="keyword">null</span>;</span><br><span class="line">        SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            document = reader.read(inputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DocumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> document;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectUtils</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createObject</span><span class="params">(String beanClassName, Object... args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Class&lt;?&gt; clazz = Class.forName(beanClassName);</span><br><span class="line">			Constructor&lt;?&gt; constructor = clazz.getConstructor();</span><br><span class="line">			<span class="comment">// 默认调用无参构造进行对象的创建</span></span><br><span class="line">			<span class="keyword">return</span> constructor.newInstance(args);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setProperty</span><span class="params">(Object beanInstance, String name, Object value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Class&lt;?&gt; clazz = beanInstance.getClass();</span><br><span class="line">			Field field = clazz.getDeclaredField(name);</span><br><span class="line">			field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">			field.set(beanInstance, value);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getTypeByFieldName(String beanClassName, String name) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Class&lt;?&gt; clazz = Class.forName(beanClassName);</span><br><span class="line">			Field field = clazz.getDeclaredField(name);</span><br><span class="line">			<span class="keyword">return</span> field.getType();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeMethod</span><span class="params">(Object beanInstance, String initMethod, Object... args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Class&lt;?&gt; clazz = beanInstance.getClass();</span><br><span class="line">			Method method = clazz.getDeclaredMethod(initMethod);</span><br><span class="line">			method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">			method.invoke(beanInstance, args);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此就是想了 spring 中的 IOC 功能。</p>
<h1 id="SpringIoc源码"><a href="#SpringIoc源码" class="headerlink" title="SpringIoc源码"></a>SpringIoc源码</h1><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完成IoC容器的创建及初始化工作</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">		<span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">        <span class="comment">// STEP 1： 刷新预处理</span></span><br><span class="line">		prepareRefresh();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">        <span class="comment">// STEP 2：</span></span><br><span class="line">        <span class="comment">// 		a） 创建IoC容器（DefaultListableBeanFactory）</span></span><br><span class="line">        <span class="comment">//		b） 加载解析XML文件（最终存储到Document对象中）</span></span><br><span class="line">        <span class="comment">//		c） 读取Document对象，并完成BeanDefinition的加载和注册工作</span></span><br><span class="line">		ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">        <span class="comment">// STEP 3： 对IoC容器进行一些预处理（设置一些公共属性）</span></span><br><span class="line">		prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">            <span class="comment">// STEP 4： </span></span><br><span class="line">			postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">			<span class="comment">// STEP 5： 调用BeanFactoryPostProcessor后置处理器对BeanDefinition处理</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">			<span class="comment">// STEP 6： 注册BeanPostProcessor后置处理器</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Initialize message source for this context.</span></span><br><span class="line">			<span class="comment">// STEP 7： 初始化一些消息源（比如处理国际化的i18n等消息源）</span></span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">			<span class="comment">// STEP 8： 初始化应用事件广播器</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">			<span class="comment">// STEP 9： 初始化一些特殊的bean</span></span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">			<span class="comment">// STEP 10： 注册一些监听器</span></span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">			<span class="comment">// STEP 11： 实例化剩余的单例bean（非懒加载方式）</span></span><br><span class="line">            <span class="comment">// 注意事项：Bean的IoC、DI和AOP都是发生在此步骤</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">			<span class="comment">// STEP 12： 完成刷新时，需要发布对应的事件</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">				logger.warn(<span class="string">"Exception encountered during context initialization - "</span> +</span><br><span class="line">						<span class="string">"cancelling refresh attempt: "</span> + ex);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">			destroyBeans();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Reset 'active' flag.</span></span><br><span class="line">			cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Propagate exception to caller.</span></span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// Reset common introspection caches in Spring's core, since we</span></span><br><span class="line">			<span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">			resetCommonCaches();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractApplicationContext#refresh: 刷新 spring 容器(删除原有容器，创建新容器)</p>
<ul>
<li>refresh 里面12个步骤，和IoC相关的是：step2  和  step11，在初始化时一次性创建所有单例<ul>
<li>obtainFreshBeanFactory<ul>
<li>refreshBeanFactory() 创建 BeanFactory 对象(DefaultListableBeanFactory) 加载 bean信息</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">	<span class="comment">// 如果之前有IoC容器，则销毁</span></span><br><span class="line">	<span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">		destroyBeans();</span><br><span class="line">		closeBeanFactory();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">   		<span class="comment">// 创建IoC容器，也就是DefaultListableBeanFactory</span></span><br><span class="line">		DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">		beanFactory.setSerializationId(getId());</span><br><span class="line">		<span class="comment">// 设置工厂的属性：是否允许BeanDefinition覆盖和是否允许循环依赖</span></span><br><span class="line">		customizeBeanFactory(beanFactory);</span><br><span class="line">        <span class="comment">// 调用载入BeanDefinition的方法，在当前类中只定义了抽象的loadBeanDefinitions方法，具体的实现调用子类容器</span></span><br><span class="line">		loadBeanDefinitions(beanFactory);<span class="comment">//钩子方法</span></span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">			<span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"I/O error parsing bean definition source for "</span> + getDisplayName(), ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里用到里模板方法，具体的加载方法在子类中实现。将相同部分的代码放在抽象的父类中，而将不同的代码放入不同的子类中。</p>
<p>从子类 AbstractRefreshableApplicationContext.java 开始就加载 beanDefinition。<br>XmlBeanDefinitionReader#loadBeanDefinitions:通过 resource 定位 xml 资源，进行加载读取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">	Assert.notNull(encodedResource, <span class="string">"EncodedResource must not be null"</span>);</span><br><span class="line">	<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">		logger.info(<span class="string">"Loading XML bean definitions from "</span> + encodedResource.getResource());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Set&lt;EncodedResource&gt; currentResources = <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.get();</span><br><span class="line">	<span class="keyword">if</span> (currentResources == <span class="keyword">null</span>) &#123;</span><br><span class="line">		currentResources = <span class="keyword">new</span> HashSet&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">		<span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.set(currentResources);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!currentResources.add(encodedResource)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">				<span class="string">"Detected cyclic loading of "</span> + encodedResource + <span class="string">" - check your import definitions!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 将资源文件转为InputStream的IO流</span></span><br><span class="line">		InputStream inputStream = encodedResource.getResource().getInputStream();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 从InputStream中得到XML的解析源</span></span><br><span class="line">			InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</span><br><span class="line">			<span class="keyword">if</span> (encodedResource.getEncoding() != <span class="keyword">null</span>) &#123;</span><br><span class="line">				inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 这里是具体的读取过程</span></span><br><span class="line">			<span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			inputStream.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">				<span class="string">"IOException parsing XML document from "</span> + encodedResource.getResource(), ex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">finally</span> &#123;</span><br><span class="line">		currentResources.remove(encodedResource);</span><br><span class="line">		<span class="keyword">if</span> (currentResources.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.remove();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>doLoadBeanDefinitions</code> 方法做具体工作，之前的步骤在堆 resource 进行编码工作。然后调用了下面的方法</p>
<ul>
<li>registerBeanDefinitions(document, resource)</li>
</ul>
<p>DefaultBeanDefinitionDocumentReader#registerBeanDefinition 中 调用doRegisterBeanDefinitions注册。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Any nested &lt;beans&gt; elements will cause recursion in this method. In</span></span><br><span class="line">	<span class="comment">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,</span></span><br><span class="line">	<span class="comment">// keep track of the current (parent) delegate, which may be null. Create</span></span><br><span class="line">	<span class="comment">// the new (child) delegate with a reference to the parent for fallback purposes,</span></span><br><span class="line">	<span class="comment">// then ultimately reset this.delegate back to its original (parent) reference.</span></span><br><span class="line">	<span class="comment">// this behavior emulates a stack of delegates without actually necessitating one.</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 这里使用了委托模式，将具体的BeanDefinition解析工作交给了BeanDefinitionParserDelegate去完成</span></span><br><span class="line">	BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</span><br><span class="line">	<span class="keyword">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断该根标签是否包含http://www.springframework.org/schema/beans默认命名空间</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">		String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">			String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</span><br><span class="line">					profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">			<span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">					logger.info(<span class="string">"Skipped XML bean definition file due to specified profiles ["</span> + profileSpec +</span><br><span class="line">							<span class="string">"] not matching: "</span> + getReaderContext().getResource());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 在解析Bean定义之前，进行自定义的解析，增强解析过程的可扩展性</span></span><br><span class="line">	preProcessXml(root);</span><br><span class="line">	<span class="comment">// 委托给BeanDefinitionParserDelegate,从Document的根元素开始进行BeanDefinition的解析</span></span><br><span class="line">	parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</span><br><span class="line">	<span class="comment">// 在解析Bean定义之后，进行自定义的解析，增加解析过程的可扩展性</span></span><br><span class="line">	postProcessXml(root);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>parseBeanDefinitions 从根标签开始解析。然后 parseDefaultElement 解析 bean 标签等默认子标签。</p>
<p>processBeanDefinition 解析Bean标签，初始化。还有其他子标签。分情况解析。</p>
<p>BeanDefinitionParserDelegate#parseBeanDefinitionElement 委托 BeanDefinitionParserDelegate 解析。创建 beanDefinition 信息。</p>
<h1 id="循环依赖问题"><a href="#循环依赖问题" class="headerlink" title="循环依赖问题"></a>循环依赖问题</h1><hr>
<p>Spring 中循环依赖的场景</p>
<ul>
<li>构造器的循环依赖，无法解决，只能将其转变为setter的循环依赖。</li>
</ul>
<p>解决方案：通过递归方法找出当前 Bean 所依赖的 Bean，然后提前缓存放入cache中，通过提前暴露，<code>exposedObject</code> 用于返回提前暴露的 bean。</p>
<p>Spring 先将 bean 对象实例化(依赖无参构造器)，再设置对象属性。Spring 先用构造器实例化 Bean 对象，将实例化结束的对象放到一个 Map 中，并且 Spring 提供获取这个未设置属性的对象的引用方法。如果 A 对象 引用B 对象，会直接从 Map 中获取 B 对象。就不会出现循环问题了。</p>
<p>三级缓存分别指：</p>
<ul>
<li>singletonFactories</li>
<li>earlySingletonObjects : 提前曝光的的单例对象的 Cache 用于检测循环引用，与 singletonFactories 互斥</li>
<li>singletonObject 单例对象的 Cache。</li>
</ul>
<p>在创建 bean 的时候，首先想到的是从 cache 中获取这个单例的 bean，如果对象为空或者正在创建中，(如果A在创建中依赖了B，就得先创建B，A就在处于创建中状态)，Spring 首先从一级缓存 singletonObjects 中获取，如果获取不到，并且对象正在创建，就再从二级缓存 earlySingletonObjects 中获取，如果还是取不到，则从 三级缓存 singletonFactory.getObject 获取，如果取到了，就将该对象从三级缓存中删除，移入二级缓存中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject); <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br></pre></td></tr></table></figure>

<p>创建对象三步：</p>
<ol>
<li>实例化对象，将当前的 beanName 和 一个 ObjectFactory 存储到三级缓存中，ObjectFactory 中的工作就是将第一步创建的空对象提前暴露</li>
<li>填充属性，填充属性B 需要先创建 B 对象，创建B对象，又需要A对象的属性注入(A 对象不会重新创建，而是从一二三级缓存中去取A对象，此时A对象在三级缓存中)</li>
<li>初始化对象。</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><hr>
<p>ClassPathXmlApplicationContext:可能是 ClassPath 也可能是 Context<br>AbstractApplicationContext<br>AbstractRefreshableApplicationContext<br>AbstractXmlApplicationContext : 可能是 Xml 也可能是注解，</p>
<p>不同的部分用不同的面向对象，相同的部分用共同对象，比如不管是从 Context 中还是 ClassPath 中创建 Context 创建时的部分是一样的。</p>
<p>AbstractBeanDefinitionReader<br>XmlBeanDefinitionReader</p>
<p>DefaultBeanDefinitionReader</p>
<p>BeanDefinitionParserDelegate 具体解析 Bean 标签成 BeanDefinition 对象是由该对象完成。</p>
<blockquote>
<p>为什么 XmlBeanDefinitionReader 要继承 AbstractBeanDefinitionReader？</p>
</blockquote>
<p>因为 AbstractXmlApplicationContext 想找阅读器，肯定是找一个通用的阅读器。具体阅读功能的实现是根据不同的情况来由子类实现。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ammar</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lizhaoloveit.cn/2020/04/01/Spring%E6%A1%86%E6%9E%B6IOC%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">http://lizhaoloveit.cn/2020/04/01/Spring%E6%A1%86%E6%9E%B6IOC%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lizhaoloveit.cn">Ammar's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring/">Spring    </a></div><div class="post_share"><div class="social-share" data-image="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/05/10/%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E5%92%8C%E9%85%8D%E7%BD%AE/"><img class="prev_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>服务器搭建和配置</span></div></a></div><div class="next-post pull-right"><a href="/2020/03/28/MyBatis%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/"><img class="next_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>MyBatis工作原理</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'http://lizhaoloveit.cn/2020/04/01/Spring%E6%A1%86%E6%9E%B6IOC%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/';
  this.page.identifier = '2020/04/01/Spring框架IOC源码分析/';
  this.page.title = 'Spring框架IOC源码分析';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'lizhao' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2023 By Ammar</div><div class="icp"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener"><span>浙ICP备19013619号-1</span></a></div><div class="bag"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010502006128" target="_blank" rel="noopener"><img src="/img/beian.png"><span>浙公网安备 33010502006128号</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="far fa-moon nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script async src="/js/search/algolia.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>