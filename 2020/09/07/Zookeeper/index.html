<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Zookeeper | Ammar's Blog</title><meta name="description" content="Zookeeper"><meta name="keywords" content="Zookeeper"><meta name="author" content="Ammar"><meta name="copyright" content="Ammar"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://lizhaoloveit.cn/2020/09/07/Zookeeper/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Zookeeper"><meta name="twitter:description" content="Zookeeper"><meta name="twitter:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Zookeeper"><meta property="og:url" content="http://lizhaoloveit.cn/2020/09/07/Zookeeper/"><meta property="og:site_name" content="Ammar's Blog"><meta property="og:description" content="Zookeeper"><meta property="og:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="Zookeeper的应用" href="http://lizhaoloveit.cn/2020/09/07/Zookeeper%E7%9A%84%E5%BA%94%E7%94%A8/"><link rel="next" title="MyBatis Generator" href="http://lizhaoloveit.cn/2020/07/28/MyBatis-Generator/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?162506e75ffd64287398566b2f5738c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"VRMKRAV9AT","apiKey":"bd7157400046d0f02396708a501a3480","indexName":"lizhaoloveit","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://lizhaoloveit.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Paxos-算法"><span class="toc-number">1.</span> <span class="toc-text">Paxos 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#算法描述"><span class="toc-number">1.1.</span> <span class="toc-text">算法描述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#prepare-阶段"><span class="toc-number">1.1.1.</span> <span class="toc-text">prepare 阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#accept-阶段"><span class="toc-number">1.1.2.</span> <span class="toc-text">accept 阶段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Paxos-算法存在活锁问题"><span class="toc-number">1.2.</span> <span class="toc-text">Paxos 算法存在活锁问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ZAB-协议"><span class="toc-number">2.</span> <span class="toc-text">ZAB 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#zk-集群的三类角色"><span class="toc-number">2.1.</span> <span class="toc-text">zk 集群的三类角色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zxid、epoch、xid"><span class="toc-number">2.2.</span> <span class="toc-text">zxid、epoch、xid</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zk-集群中的模式和状态"><span class="toc-number">2.3.</span> <span class="toc-text">zk 集群中的模式和状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#恢复模式"><span class="toc-number">2.3.1.</span> <span class="toc-text">恢复模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#广播模式"><span class="toc-number">2.3.2.</span> <span class="toc-text">广播模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Leader-选举"><span class="toc-number">2.4.</span> <span class="toc-text">Leader 选举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#集群启动时选举-Leader"><span class="toc-number">2.4.1.</span> <span class="toc-text">集群启动时选举 Leader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群宕机后的-Leader-选举"><span class="toc-number">2.4.2.</span> <span class="toc-text">集群宕机后的 Leader 选举</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CAP-定理"><span class="toc-number">3.</span> <span class="toc-text">CAP 定理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BASE"><span class="toc-number">3.1.</span> <span class="toc-text">BASE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#脑裂状态"><span class="toc-number">3.2.</span> <span class="toc-text">脑裂状态</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#容灾设计方案"><span class="toc-number">4.</span> <span class="toc-text">容灾设计方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#三机房部署"><span class="toc-number">4.1.</span> <span class="toc-text">三机房部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩容与缩容"><span class="toc-number">4.2.</span> <span class="toc-text">扩容与缩容</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#源码"><span class="toc-number">5.</span> <span class="toc-text">源码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#判断-zk-集群的某台服务器不可用"><span class="toc-number">5.1.</span> <span class="toc-text">判断 zk 集群的某台服务器不可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastLeaderElection-java"><span class="toc-number">5.2.</span> <span class="toc-text">FastLeaderElection.java</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#totalOrderPredicate"><span class="toc-number">5.2.1.</span> <span class="toc-text">totalOrderPredicate()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getVoteTracker"><span class="toc-number">5.2.2.</span> <span class="toc-text">getVoteTracker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lookForLeader"><span class="toc-number">5.2.3.</span> <span class="toc-text">lookForLeader()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Zookeeper-技术内幕"><span class="toc-number">6.</span> <span class="toc-text">Zookeeper 技术内幕</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#节点"><span class="toc-number">6.1.</span> <span class="toc-text">节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#会话"><span class="toc-number">6.2.</span> <span class="toc-text">会话</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#会话状态"><span class="toc-number">6.2.1.</span> <span class="toc-text">会话状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#会话连接事件"><span class="toc-number">6.2.2.</span> <span class="toc-text">会话连接事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#会话连接的超时管理-分桶策略"><span class="toc-number">6.2.3.</span> <span class="toc-text">会话连接的超时管理-分桶策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ACL-访问控制列表"><span class="toc-number">6.3.</span> <span class="toc-text">ACL 访问控制列表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#授权策略-scheme"><span class="toc-number">6.3.1.</span> <span class="toc-text">授权策略 scheme</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#授权对象id"><span class="toc-number">6.3.2.</span> <span class="toc-text">授权对象id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#权限-Permission"><span class="toc-number">6.3.3.</span> <span class="toc-text">权限 Permission</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Watcher-机制"><span class="toc-number">6.4.</span> <span class="toc-text">Watcher 机制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#客户端命令"><span class="toc-number">7.</span> <span class="toc-text">客户端命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#启动客户端"><span class="toc-number">7.1.</span> <span class="toc-text">启动客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查看子节点-ls"><span class="toc-number">7.2.</span> <span class="toc-text">查看子节点 -ls</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建节点"><span class="toc-number">7.3.</span> <span class="toc-text">创建节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取节点信息"><span class="toc-number">7.4.</span> <span class="toc-text">获取节点信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新节点数据内容"><span class="toc-number">7.5.</span> <span class="toc-text">更新节点数据内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#删除节点"><span class="toc-number">7.6.</span> <span class="toc-text">删除节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ACL-操作"><span class="toc-number">7.7.</span> <span class="toc-text">ACL 操作</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://lizhaoloveit.cn/blogimages/blog/top_img.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Ammar's Blog</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description">微信号：aicjaish</div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a><a class="site-page" href="/comment/"><i class="fa-fw fa fa-coffee"></i><span> 留言</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Zookeeper</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-09-07<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-09-21</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/">Java</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/%E6%A1%86%E6%9E%B6/">框架</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/%E6%A1%86%E6%9E%B6/Zookeeper/">Zookeeper</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">10k</span><span class="post-meta__separator">|</span><span>阅读时长: 36 分钟</span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="Paxos-算法"><a href="#Paxos-算法" class="headerlink" title="Paxos 算法"></a>Paxos 算法</h1><hr>
<p>基于消息传递、高容错性的一致性算法。<strong>算法就某个决议达成一致</strong>，要解决的问题是在分布式系统中就某个决议达成一致性。<br>有名的 Paxos 工程实现有 Google Chubby、ZAB、微信的 PhxPaxos</p>
<p>拜占庭将军问题，该问题要说明的含义是：在不可靠信道上试图通过消息传递的方式达到一致性是不可能的。<br>所以，Paxos 算法的前提是不存在拜占庭将军问题，即信道是安全的、可靠的、集群节点间传递的消息是不会被篡改的。</p>
<p>一般情况下，分布式系统中各个节点间采用两种通讯模型，共享内存、消息传递。Paxos 是基于消息传递通讯模型。</p>
<h2 id="算法描述"><a href="#算法描述" class="headerlink" title="算法描述"></a>算法描述</h2><p>在 Paxos 算法中有三种角色，分别具有三种不同的行为，很多时候一个进程可能同时充当多种角色。</p>
<p>Proposer 提议者<br>Accepter 表决者，同时也能提交提议。<br>Learner 同步者</p>
<p>每个提议者在提出提议时都会先获取到一个具有全局唯一性的、递增的提议编号 N，整个集群中是唯一编号，然后将该编号与提议对应。<br>每个表决者在 accept 某提议后，将该提议的编号 N 记录在本地，这样每个表决者中保存的已经被 accept 的提议会存在一个编号最大的提议，编号假设为 maxN，每个表决者仅会 accept 编号大于自己本地 maxN 的提议。</p>
<p>一旦一个提议被选定，其他服务器会主动同步该提议到本地。</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA4Nzg5Nzc5OA==&mid=2651666134&idx=1&sn=083bf7af1f2392f7a2e044fc3bc737a7&chksm=8bcbf57fbcbc7c69e9affa27167e089ce1b6583c20a7ab0e12cc52dc0af68fb75b43aaa19d3c&scene=21" target="_blank" rel="noopener">一个关于Paxos算法的故事</a></p>
<p>Paxos 算法执行过程分为两个阶段：准备阶段 prepare 与 接受阶段 accept</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16000912811115-zookeeper.jpg" alt=""></p>
<h3 id="prepare-阶段"><a href="#prepare-阶段" class="headerlink" title="prepare 阶段"></a>prepare 阶段</h3><ul>
<li>Proposer 准备提交一个编号为 N 的提议，于是其首先向所有 Accepter 发送 <code>prepare(N)</code> 请求，试探集群是否支持该编号提议</li>
<li>每个 Accepter 保存自己曾经 accept 过的提议中的最大编号 maxN。当一个 Accepter 接受到其他主机发送的 <code>prepare(N)</code> 请求时，比较 N 与 maxN 的值<ul>
<li>若 N 小于 maxN，说明该提议已经过时，当前 Accepter 采取不回应或回应 Error 的方式拒绝 prepare 请求</li>
<li>若 N 大于 maxN，则说明该提议时可以接受的，当前 Accepter 首先将 N 记录下来，并将其曾经已经 accept 的编号最大提议 <code>proposal(myid, maxN, value)</code> 反馈给 Proposer，表示自己支持该提议。<ul>
<li>myid Accepter 标识id，</li>
<li>maxN 曾接受的提议最大编号</li>
<li>提议的真正内容。</li>
</ul>
</li>
<li>若当前 Accepter 未曾 accept 过任何提议，返回 <code>proposal(myid, null, null)</code> 反馈给 Proposer</li>
</ul>
</li>
<li>prepare 阶段 N 不可能等于 maxN。这是由 N 的生成机制决定，要获取 N 的值，必定会在原来数值基础上采用同步锁的方式增一。</li>
</ul>
<h3 id="accept-阶段"><a href="#accept-阶段" class="headerlink" title="accept 阶段"></a>accept 阶段</h3><ol>
<li>当 Proposer 发出 prepare(N) 后，收到了超过半数的 Accepter 的反馈，那么该 Proposer 就会将提议 <code>proposal(myid, N, value)</code> 发送给所有的表决者</li>
<li>当 Accepter 接受到 Proposer 发送的 <code>proposal(myid, N, value)</code>，会再次拿出自己曾经 accept 过的 提议中最大的编号 maxN，或者曾记录下的 prepare 的最大编号，让 N 与它们比较，如果 N <strong>大于等于</strong> 这两个编号，则当前 Accepter accept 该提议，并反馈给 Proposer。如果小于，则 Accepter 采取不回应或者回应 Error 的方式拒绝该提议。</li>
<li>如果 Proposer 没有接受到超过半数的 Accepter 的 accept 反馈，则重新进入 prepare 阶段，递增提议编号，重新提出 prepare 请求，或者放弃该提议，不再提出。</li>
<li>若 Proposer 接受到的 Accepter 反馈数量超过半数，则会向外广播两类信息：a) 向曾 accept 其提议的 Accepter 发送<strong>可执行数据同步信号</strong>，即让它们执行曾接收到的提议。b) 向未曾向其发送 accept 反馈的 Accepter 发送 <strong>提议 + 可执行数据同步信号</strong>，让它们接受到该提议后马上执行，执行时，所有 Accepter 状态发生改变，由 Accepter 变为 Learner，不再接受 proposal。</li>
</ol>
<h2 id="Paxos-算法存在活锁问题"><a href="#Paxos-算法存在活锁问题" class="headerlink" title="Paxos 算法存在活锁问题"></a>Paxos 算法存在活锁问题</h2><p>死锁：由于线程A被阻塞，需要线程B才能执行，而线程B也被阻塞，需要线程A才能执行，无法自行解开。<br>活锁：没有阻塞，但由于某些条件不满足，导致一直重复尝试-失败-尝试-失败的过程，处于活锁的实体由于不断改变状态，有可能自行解开。</p>
<p>具体表现在，提议1 prepare(N1)后，新的提议2 prepare(N2) 刷新了每个 Accepter 的 maxN，导致 accept 阶段失败，于是提议1重新拿到编号 prepare，此时提议1的编号大于提议2，重新刷新了 Accepter 的 maxN 之后，导致提议2在 accept 阶段失败，于是如此循环往复。导致活锁。</p>
<blockquote>
<p>解决方案：Fast Paxos 算法对 Paxos 算法进行了改进：只允许一个进程提交提议，即该进程具有对 N 的唯一操作权。该方式解决了活锁问题。</p>
</blockquote>
<h1 id="ZAB-协议"><a href="#ZAB-协议" class="headerlink" title="ZAB 协议"></a>ZAB 协议</h1><hr>
<p>ZAB Zookeeper Atomic Broadcast  zk 原子消息广播协议，专为 Zookeeper 设计的一种支持<strong>崩溃恢复</strong>的<strong>原子</strong>广播协议，在 Zookeeper 中，主要依赖 ZAB 协议实现分布式数据一致性</p>
<p>Zookeeper 使用一个单一主进程来接收并处理客户端所有事务请求，当服务器数据状态发生变更，采用 ZAB 原子广播协议，以事务提议 Proposal 的形式广播到所有副本进程。ZAB 协议能够保证一个全局的变更序列，每一个事务分配一个全局的递增编号 xid。</p>
<p>Zookeeper 客户端连接到 Zookeeper 集群的一个节点后，若客户端提交的是读请求，当前节点就直接根据自己保存的数据对其响应，如果是写请求且当前节点不是 Leader，那么节点就会将该写请求转发给 Leader，Leader 会以提议的方式广播该写操作，只要超过半数节点同一该写操作，写操作请求就会被提交。然后 Leader 会再次广播给所有订阅者，即 Learner 通知它们同步数据。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16001423249730-zookeeper.jpg" alt=""></p>
<p>ZAB 协议是 Fast Paxos 算法的一种工业实现算法，两者设计目标不一样，ZAB协议用于构建一个高可用的分布式数据主从系统，Follower 是 Leader 的备用机，Leader 挂了，马上可以选举一个新的 Leader。而 Fast Paxos 算法则用于构建一个分布式一致性状态机系统，确保系统中各个节点的状态都一致。</p>
<p>ZAB 使用了 Google 的 Chubby 算法作为分布式锁的实现。</p>
<h2 id="zk-集群的三类角色"><a href="#zk-集群的三类角色" class="headerlink" title="zk 集群的三类角色"></a>zk 集群的三类角色</h2><ul>
<li>Leader 接收和处理客户端的读请求；zk 集群中事务请求的唯一处理者，负责发起决议和投票，然后将通过的事务请求在本地进行处理后，将处理结果同步给集群中的其他主机</li>
<li>Follower 接收和处理客户端的读请求；将事务请求转给 Leader；同步 Leader 中的数据；当 Leader 挂了，参与 Leader 的选举</li>
<li>Observer 没有选取和被选举权，没有投票权的 Follower。如果 zk 集群中的读压力很大，则需要增加 Observer，最好不要增加 Follower。因为增加 Follower 会增大投票与统计选票的压力，降低写操作效率，及 Leader 选举的效率。</li>
<li>Learner 当 Follower 进行数据同步时，只能接收和处理读请求，此时 Follower 状态为 Learner</li>
<li>QuorumServer Follower + Leader</li>
</ul>
<blockquote>
<p>Observer 的数量<br>Observer 数量一般与 Follower 数量相同。并不是越多越好，因为 Observer 增多虽然不会增加事务操作压力，但由于其需要从 Leader 同步数据，Observer 同步数据的时间是小于等于 Follower 同步数据时间的，当 Follower 同步数据完成，Leader 的 Observer 列表中的 Observer 主机将结束同步。完成同步的 Observer 会进入另一个对外提供服务的列表。其余的 Observer 会通过心跳包的形式连接 Leader 进行后续的数据同步。对于事务操作发生频繁的系统，不建议过多的Observer</p>
</blockquote>
<p>Leader 中有2个 Observer 列表，all(包含所有 Observer 主机)、service(每发生一次事务更新，service 列表就会发生一次变化)</p>
<p>在 Leader 中，Follower 也存在两个列表，all(包含所有 Follower 主机)、service(每发生一次事务更新，service 列表就会发生一次变化)，如果service &lt;= all/2 ，则说明同步失败，Leader 会重新广播，Follower 重新同步</p>
<h2 id="zxid、epoch、xid"><a href="#zxid、epoch、xid" class="headerlink" title="zxid、epoch、xid"></a>zxid、epoch、xid</h2><ul>
<li>zxid 长度为64位的 Long 类型数据，高32位表示 epoch，低32位表示 xid</li>
<li>epoch zk 集群中每个 Leader 都会有一个不同的 epoch，区分不同的 Leader 时期</li>
<li>xid 事务id，是一个流水号(递增)</li>
</ul>
<h2 id="zk-集群中的模式和状态"><a href="#zk-集群中的模式和状态" class="headerlink" title="zk 集群中的模式和状态"></a>zk 集群中的模式和状态</h2><p>ZAB 协议中对 zkServer 的状态描述有三种，</p>
<ul>
<li>恢复模式 当集群启动时，或者当 Leader 挂了进行选举时，系统需要进入恢复模式。Leader 的选举和初始化同步</li>
<li>广播模式 初始化广播和更新广播</li>
<li>同步模式 初始化同步与更新同步</li>
</ul>
<p>zk 集群中的每一台主机，在不同的阶段会处于不同的状态。每一台主机具有四种状态。</p>
<ul>
<li>Looking 选举状态</li>
<li>Following Follower 的正常工作状态，从 Leader 同步数据的状态</li>
<li>Observing Observer 的正常工作状态，从 Leader 同步数据</li>
<li>Leading Leader 的正常工作状态，Leader 广播数据更新的状态</li>
</ul>
<h3 id="恢复模式"><a href="#恢复模式" class="headerlink" title="恢复模式"></a>恢复模式</h3><p>恢复模式下有两个阶段，Leader 选举与初始化同步。当完成 Leader 选举后，此时 Leader 还是一个准 Leader，要经过初始化同步后才能变为真正的 Leader。</p>
<ol>
<li>为了保证 Leader 向  Learner 发送提议的有序，Leader 会为每一个 Learner 服务器准备一个队列</li>
<li>Leader 将没有被各个 Learner 同步的事务封装为一个 Proposal</li>
<li>Leader 将这些 Proposal 逐条发给各个 Learner，并在每一个 Proposal 后都紧跟一个 Commit 消息，表示该事务已经被提交，Learner 可以直接接收并执行</li>
<li>Learner 接收来自于 Learner 的 Proposal，并将其更新到本地</li>
<li>当 Learner 更新成功后，会向准 Learder 发送 ACK 信息</li>
<li>Leader 服务器收到来自 Learner 的 ACK 后就会将该 Learner 加入到真正可用的 Follower 列表或 Observer 列表中，没有反馈 ACK 或者 反馈了但 Leader 没有收到的 Learner，Leader 不会将其加入到相应列表。</li>
</ol>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16001661497428-zookeeper.jpg" alt=""></p>
<blockquote>
<p>Leanner-3 没有反馈，则不会被加入到 Learner 的同步队列中</p>
</blockquote>
<p>当集群正在启动过程中，或者 Leader 与超过半数的主机断连后，集群进入了恢复模式，对于要恢复的数据状态需要遵循两个原则，此时会比较 zxid 大小，zxid 打的 Follower 被选举为 Leader。</p>
<ul>
<li>已被处理过的消息不能丢</li>
</ul>
<p>当 Leader 收到超过半数 Follower 的 ACKs 后，广播 Commit 消息时，如果在非全部 Follower 收到 Commit 消息之前就挂了，导致一种后果：部分 Server 已经执行了该事务，而部分 Server 尚未收到 Commit 消息，没有执行。当新的 Leader 被选举出后，集群经过恢复模式后需要保证所有的 Server 上都执行了哪些已经被部分 Server 执行过的事务</p>
<ul>
<li>被丢弃的消息不能再现</li>
</ul>
<p>如果所有的 Follower 都没有收到 Commit 之前 Leader 就宕机了，所有 Follower 根本不知道该 Proposal 存在，当新的 Leader 选举出来，整个集群进入正常服务状态后，之前挂了的 Leader 主机重新启动并注册成为了 Follower。如果那个别人根本不知道的 Proposal 还保留在主机上，那么其数据就会比其他主机多出了内容，导致整个系统状态的不一致。此时，该 Proposal 应该被丢弃，类似这样应该被丢弃的事务，是不能再次出现在集群中的，应该被清除。</p>
<p>当一台新的 Follower 想连入 zk 集群，则需要将其的 zxid 与 Leader 的 zxid 递归比较，只要找到两个 zxid 相同并且 Proposal 也相同的事务，然后同步该 zxid 后面所有的事务，之前比较过不相等的事务会被丢弃。</p>
<h3 id="广播模式"><a href="#广播模式" class="headerlink" title="广播模式"></a>广播模式</h3><p>如果集群中的 Learner 节点收到客户端的事务请求，那么这些 Learner 会将请求转发给 Leader 服务器，然后执行如下具体过程：</p>
<ol>
<li>Learder 接收到事务请求后，为事务赋予一个全局唯一的 64 位自增 id，即 zxid，通过 zxid 的大小比较可实现事务的有序性管理，然后将事务封装为一个 Proposal。</li>
<li>Leader 根据 Follower 列表获取所有的 Follower，然后将 Proposal 通过这些 Follower 的队列将提议发送给各个 Follower</li>
<li>Follower 接收到提议后，将提议的 zxid 与本地记录的事务日志中最大的 zxid 比较(防止前面的事务的 Commit 由于网络原因指令晚到达造成事务数据错乱)，若当前提议的 zxid 大于最大 zxid，将当前提议记录到本地事务日志中，并向 Leader 返回一个 ACK。(很重要)</li>
<li>当 Leader 接收超过半数 ACKs 后，Leader 就会向所有 Follower 队列发送 Commit 消息，向所有 Observer 队列发送 Proposal</li>
<li>当 Follower 收到 Commit 消息后，会将日志中的事务正式更新到本地。当 Observer 收到 Proposal后，会直接将事务更新到本地</li>
<li>无论是 Follower 还是 Observer，在同步完成后都需要向 Leader 发送成功 ACK。</li>
</ol>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16001665639630-zookeeper.jpg" alt=""></p>
<h2 id="Leader-选举"><a href="#Leader-选举" class="headerlink" title="Leader 选举"></a>Leader 选举</h2><hr>
<ul>
<li>myid zk 集群中服务器的唯一标识</li>
<li>logicalclock 逻辑时钟，选举时称为 logicalclock，选举结束后称为 epoch。</li>
</ul>
<h3 id="集群启动时选举-Leader"><a href="#集群启动时选举-Leader" class="headerlink" title="集群启动时选举 Leader"></a>集群启动时选举 Leader</h3><p>如果要进行 Leader 选举，至少需要两台主机，这里以三台主机组成的集群为例。集群初始化阶段，Server1 启动时，会给自己投票，然后发布自己的投票结果。投票包含推举服务器的 myid 和 zxid，使用(myid, zxid)表示。此时 Server1 的投票为 (1, 0)。由于其他机器还未启动，所以收不到反馈信息，Server1 的状态便一直处于 Looking，非服务状态。</p>
<p>当第二台服务器 Server2 启动时，此时两台服务器可以相互通信，每台机器试图找到 Leader，选举过程如下：</p>
<ol>
<li>每个 Server 发出一个投票。此时 Server1 投票为 (1, 0) Server2 投票为 (2, 0)，然后各自将这个投票发送给集群其他服务器。</li>
<li>接受到来自各个服务器的投票后，集群的每个服务器首先判断该投票的有效性，如检查是否是本轮投票，是否来自 Looking 状态的服务器等。</li>
<li>针对每一个投票，服务器需要将别人的投票和自己的投票进行 PK，规则如下<ul>
<li>有限检查 zxid，zxid 比较大的服务器优先作为 Leader</li>
<li>如果 zxid 相同，比较 myid。myid 较大的服务器作为 Leader 服务器。</li>
</ul>
</li>
<li>每次投票后，服务器会统计投票信息，判断是否已经有半数以上机器接收到相同投票。对于 Server1、Server2 而言，集群中已经有两台主机接受了 (2, 0) 的投票信息，此时就选出了新的 Leader，Server2</li>
<li>一旦确定了 Leader，每个服务器会更新自己的状态，如果是 Follower，则会变更为 Following，如果是 Leader，则会变更为 Leading</li>
<li>新的 Leader 选举出来后 Server3 启动，其向发出新一轮选举，但由于当前集群各个主机的状态并不是 Looking，而是各司其职的正常服务，所以只能以 Follower 的身份加入到集群中。</li>
</ol>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16002363030413-zookeeper.jpg" alt=""></p>
<h3 id="集群宕机后的-Leader-选举"><a href="#集群宕机后的-Leader-选举" class="headerlink" title="集群宕机后的 Leader 选举"></a>集群宕机后的 Leader 选举</h3><p>如果 Leader 突然宕机，整个集群将暂停对外服务，进入新一轮 Leader 选举，其过程和启动时期的 Leader 选举过程基本一致。</p>
<p>假设正在运行的 Server1、Server2、Server3 三台服务器，当前 Leader 为 Server2，如果某一时间，Server2 挂了。选举过程如下：</p>
<ol>
<li>Leader 挂后，余下非 Observer 服务器都会将自己的服务器状态由 Following 变更为 Looking，然后进入 Leader 选举过程。</li>
<li>每个 Server 会发出一个投票，仍然会首先投自己。不过，运行期间每个服务器上的 zxid 可能是不同的，假定 Server1 产生投票 (1, 333)，Server3 产生投票 (3, 111)，然后各自将投票发送给集群中所有机器。</li>
<li>集群中的每个服务器收到投票后，首先判断该投票的有效性，如检查是否是本轮投票、是否来自 Looking 状态的服务器。</li>
<li>服务器都需要将别人的投票和自己的投票进行 PK，对于 Server1 而言，它的投票是 (1, 333)，接受 Server3 的投票为 (3, 111)。首先会比较两者的 zxid，Server1 的 zxid 大于 Server3 的，然后 Server3 更新自己的投票 (1, 333) ，然后广播重新投票。对于 Server1 而言，无需更新自己的投票，只是再次向所有主机发送上一次投票信息。</li>
<li>对于 Server1、Server3 而言，有两台主机接受了 (1, 333)，便认为已经选出了新的 Leader，即 Server3。</li>
<li>一旦确定了 Leader，每个服务器会更新状态。Server1 变为 Leading，Server3 变为 Following</li>
</ol>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16002517780613-zookeeper.jpg" alt=""></p>
<h1 id="CAP-定理"><a href="#CAP-定理" class="headerlink" title="CAP 定理"></a>CAP 定理</h1><hr>
<ul>
<li>Consistency 一致性</li>
<li>Availability 可用性</li>
<li>Partition tolerance 分区容错性</li>
</ul>
<p>C 分布式系统中过个主机之间是否能够保持数据一致的特性。当系统数据发生更新操作后，各个主机中的数据仍然处于一致的状态<br>A 系统提供的服务必须一直处于可用的状态，即对用户的每一个请求，系统总是可以在<strong>有限的时间内</strong>对用户做出<strong>响应</strong><br>P 分布式系统在遇到任何网络分区故障时，仍能够保证对外提供满足一致性和可用性服务。</p>
<p>对于分布式系统来说，网络环境相对是不可控的，出现了网络分区是不可避免的，因此系统必须具备分区容错性。但其并不能同时保证一致性与可用性。 CAP 原则即对一个分布式系统来说只可能满足两项，要么 CP 要么 AP。</p>
<blockquote>
<p><strong>理解：由于需要满足分区一致性，假设3台机器，每台机器不能放置大于n/2台参与选举的服务器，此时假设某一写事务操作需要，在决议通过后，Leader Commit当前机器的数据库后，其余机器需要同步更新，而同步更新期间则是不可用的。如果要保证服务一直是可用的，则在异步更新期间，Leader 数据与 Observer 数据便不一致。直到更新完毕</strong></p>
</blockquote>
<h2 id="BASE"><a href="#BASE" class="headerlink" title="BASE"></a>BASE</h2><p>Basically Available 基本可用、Soft state 软状态、Eventually consistent 最终一致性。BASE CP 与 AP 权衡的结果。</p>
<p>即使无法做到强一致性，但每个系统都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性。</p>
<p>zk 遵循的是 CP 原则，保证了一致性，但牺牲了可用性。当 Leader 宕机后，zk 集群会马上进行新的 Leader 选举，选举时长一般在200毫秒内，最长不超过60秒。整个选举期间 zk 集群不接受客户端的读写操作。处于瘫痪状态。不满足可用性。</p>
<h2 id="脑裂状态"><a href="#脑裂状态" class="headerlink" title="脑裂状态"></a>脑裂状态</h2><p>zk 可能会引发脑裂，在多机房部署中，如果出现了网络连接问题，形成多个分区，可能出现数据不一致。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16003258184442-zookeeper.jpg" alt=""></p>
<p>机房B 感知不到 Leader，其中的服务器会进入 Looking 状态，发送选举消息到机房C，但机房C的服务器都是 Following 状态可以感知 Leader。所以机房B选举失败。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16003262436721-zookeeper.jpg" alt=""></p>
<p>此时，如果B节点收到了数据更改请求，就会造成 A 与 BC 数据不一致的情况。脑裂现象。</p>
<h1 id="容灾设计方案"><a href="#容灾设计方案" class="headerlink" title="容灾设计方案"></a>容灾设计方案</h1><hr>
<p>设置多台主机部署一个集群避免单点问题，需要考虑集群部署在多个机房、多个楼宇。在多机房部署设计中，要充分考虑<code>过半原则</code>，尽量确保 zk 集群中有过半的机器能够正常运行。</p>
<h2 id="三机房部署"><a href="#三机房部署" class="headerlink" title="三机房部署"></a>三机房部署</h2><p>在生产环境下，三机房部署是最常见的、容灾性最好的部署方案。<br>假定 zk 集群中机器总数为 N ，三个机房中部署的机器数量分别为 N1、N2、N3</p>
<p>N1 = (N - 1) / 2。保证第一季芳中具有刚不到半数主机。<br>N2 = 1 ~ (N - N1) / 2<br>N3 = N - N1 - N2</p>
<h2 id="扩容与缩容"><a href="#扩容与缩容" class="headerlink" title="扩容与缩容"></a>扩容与缩容</h2><p>水平扩展对于提高系统服务能力，是一种非常重要的方式。但 zk 对于水平扩容和缩容做的不完美，主机数量的变化需要修改配置文件后整个集群进行重启。集群重启的方式：</p>
<p>整体重启，整个集群停止，然后更新所有主机的配置然后再重启集群。该方式会使集群停止对外服务，所以慎用。<br>部分重启，每次重启一小部分主机，不能多于半数，因为重启的主机过半，意味着剩余主机无法产生合法投票结果，如果宕机无法进行选举，不宕机无法提供写服务。</p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><hr>
<h2 id="判断-zk-集群的某台服务器不可用"><a href="#判断-zk-集群的某台服务器不可用" class="headerlink" title="判断 zk 集群的某台服务器不可用"></a>判断 zk 集群的某台服务器不可用</h2><p>每台服务器中都存在一个维护消息发送的 Map，Map 中的各个 Value(队列)是否为空，判断当前 Server 与与整个集群的连接状态：</p>
<p>规则：每个 Value 对应集群中的一台 Server，而队列中存放的是发送失败的消息。</p>
<p><strong>如果所有队列均为空</strong> 说明当前 Server 与集群的连接是没有任何问题的<br><strong>如果所有队列均不为空</strong> 说明当前 Server 与集群已经完全失联<br><strong>如果某一队列不为空</strong> 说明当前 Server 与该队列对应的 Server 的连接出现问题<br><strong>如果任意一个队列为空</strong> 说明当前 Server 与集群的连接是没有问题的。</p>
<p>在源码中在方法 <code>QuorumCnxManager.haveDelivered()</code> 中提现了上述规则</p>
<h2 id="FastLeaderElection-java"><a href="#FastLeaderElection-java" class="headerlink" title="FastLeaderElection.java"></a>FastLeaderElection.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implementation of leader election using TCP. It uses an object of the class</span></span><br><span class="line"><span class="comment"> * QuorumCnxManager to manage connections. Otherwise, the algorithm is push-based</span></span><br><span class="line"><span class="comment"> * as with the other UDP implementations.</span></span><br><span class="line"><span class="comment"> * 使用 TCP 实现了 Leader 的选举，这种方式使用 QuorumCnxManager 类的对象进行与其他 Server</span></span><br><span class="line"><span class="comment"> * 间的连接管理。如果不使用 QuorumCnxManager 对象的话，将使用 UDP 的基于推送的算法实现。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * There are a few parameters that can be tuned to change its behavior. First,</span></span><br><span class="line"><span class="comment"> * finalizeWait determines the amount of time to wait until deciding upon a leader.</span></span><br><span class="line"><span class="comment"> * This is part of the leader election algorithm.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastLeaderElection</span> <span class="keyword">implements</span> <span class="title">Election</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(FastLeaderElection.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine how much time a process has to wait</span></span><br><span class="line"><span class="comment">     * once it believes that it has reached the end of</span></span><br><span class="line"><span class="comment">     * leader election.</span></span><br><span class="line"><span class="comment">     * 决定一轮的选举过程需要等待的时间，如果超过该时间，当轮选举结束。等待其他 Server 发送通知的时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> finalizeWait = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upper bound on the amount of time between two consecutive</span></span><br><span class="line"><span class="comment">     * notification checks. This impacts the amount of time to get</span></span><br><span class="line"><span class="comment">     * the system up again after long partitions. Currently 60 seconds.</span></span><br><span class="line"><span class="comment">     * finalizeWait 的最大值，默认60秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> maxNotificationInterval = <span class="number">60000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Lower bound for notification check. The observer don't need to use</span></span><br><span class="line"><span class="comment">     * the same lower bound as participant members</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> minNotificationInterval = finalizeWait;</span><br><span class="line">    </span><br><span class="line">	 ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Notification</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Format version, introduced in 3.4.6</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CURRENTVERSION = <span class="number">0x2</span>;</span><br><span class="line">    <span class="keyword">int</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Proposed leader 当前推荐做 Leader 的 ServerId</span></span><br><span class="line"><span class="comment">     */</span> <span class="keyword">long</span> leader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * zxid of the proposed leader 当前推荐做 Leader 的最大的 zxid</span></span><br><span class="line"><span class="comment">     */</span> <span class="keyword">long</span> zxid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Epoch 当前轮选举的 逻辑时钟</span></span><br><span class="line"><span class="comment">     */</span> <span class="keyword">long</span> electionEpoch;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * current state of sender 当前通知发送者的状态</span></span><br><span class="line"><span class="comment">     */</span> QuorumPeer.ServerState state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Address of sender 当前通知发送者的 ServerId</span></span><br><span class="line"><span class="comment">     */</span> <span class="keyword">long</span> sid;</span><br><span class="line"></span><br><span class="line">    QuorumVerifier qv;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * epoch of the proposed leader 当前选票推荐做 Leader 的逻辑时钟</span></span><br><span class="line"><span class="comment">     */</span> <span class="keyword">long</span> peerEpoch;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="totalOrderPredicate"><a href="#totalOrderPredicate" class="headerlink" title="totalOrderPredicate()"></a>totalOrderPredicate()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check if a pair (server id, zxid) succeeds our</span></span><br><span class="line"><span class="comment"> * current vote.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">totalOrderPredicate</span><span class="params">(<span class="keyword">long</span> newId, <span class="keyword">long</span> newZxid, <span class="keyword">long</span> newEpoch, <span class="keyword">long</span> curId, <span class="keyword">long</span> curZxid, <span class="keyword">long</span> curEpoch)</span> </span>&#123;</span><br><span class="line">    LOG.debug(</span><br><span class="line">        <span class="string">"id: &#123;&#125;, proposed id: &#123;&#125;, zxid: 0x&#123;&#125;, proposed zxid: 0x&#123;&#125;"</span>,</span><br><span class="line">        newId,</span><br><span class="line">        curId,</span><br><span class="line">        Long.toHexString(newZxid),</span><br><span class="line">        Long.toHexString(curZxid));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于 Observer 来说，其权重 weight 为 0，没资格选举</span></span><br><span class="line">    <span class="keyword">if</span> (self.getQuorumVerifier().getWeight(newId) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We return true if one of the following three cases hold:</span></span><br><span class="line"><span class="comment">     * 1- New epoch is higher</span></span><br><span class="line"><span class="comment">     * 2- New epoch is the same as current epoch, but new zxid is higher</span></span><br><span class="line"><span class="comment">     * 3- New epoch is the same as current epoch, new zxid is the same</span></span><br><span class="line"><span class="comment">     *  as current zxid, but server id is higher.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// Leader 的比较逻辑</span></span><br><span class="line">    <span class="keyword">return</span> ((newEpoch &gt; curEpoch)</span><br><span class="line">            || ((newEpoch == curEpoch)</span><br><span class="line">                &amp;&amp; ((newZxid &gt; curZxid)</span><br><span class="line">                    || ((newZxid == curZxid)</span><br><span class="line">                        &amp;&amp; (newId &gt; curId)))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getVoteTracker"><a href="#getVoteTracker" class="headerlink" title="getVoteTracker"></a>getVoteTracker</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Given a set of votes, return the SyncedLearnerTracker which is used to</span></span><br><span class="line"><span class="comment"> * determines if have sufficient to declare the end of the election round.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> votes</span></span><br><span class="line"><span class="comment"> *            Set of votes</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> vote</span></span><br><span class="line"><span class="comment"> *            Identifier of the vote received last</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the SyncedLearnerTracker with vote details</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> SyncedLearnerTracker <span class="title">getVoteTracker</span><span class="params">(Map&lt;Long, Vote&gt; votes, Vote vote)</span> </span>&#123;</span><br><span class="line">    SyncedLearnerTracker voteSet = <span class="keyword">new</span> SyncedLearnerTracker();</span><br><span class="line">    voteSet.addQuorumVerifier(self.getQuorumVerifier());</span><br><span class="line">    <span class="keyword">if</span> (self.getLastSeenQuorumVerifier() != <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; self.getLastSeenQuorumVerifier().getVersion() &gt; self.getQuorumVerifier().getVersion()) &#123;</span><br><span class="line">        voteSet.addQuorumVerifier(self.getLastSeenQuorumVerifier());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * First make the views consistent. Sometimes peers will have different</span></span><br><span class="line"><span class="comment">     * zxids for a server depending on timing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, Vote&gt; entry : votes.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vote.equals(entry.getValue())) &#123;</span><br><span class="line">            voteSet.addAck(entry.getKey());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> voteSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="lookForLeader"><a href="#lookForLeader" class="headerlink" title="lookForLeader()"></a>lookForLeader()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Starts a new round of leader election. Whenever our QuorumPeer</span></span><br><span class="line"><span class="comment"> * changes its state to LOOKING, this method is invoked, and it</span></span><br><span class="line"><span class="comment"> * sends notifications to all other peers.</span></span><br><span class="line"><span class="comment"> * 开启新一轮的 Leader 选举，无论何时，只要 QuorumPeer 的状态变为 looking，这个方法</span></span><br><span class="line"><span class="comment"> * 就会被调用，发送 notifications 给所有其他同级服务器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Vote <span class="title">lookForLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1.创建选举对象，选举前的初始化</span></span><br><span class="line">        <span class="comment">// jmx Java Management Extensions Oracle 提供的分布式应用程序监控技术</span></span><br><span class="line">        self.jmxLeaderElectionBean = <span class="keyword">new</span> LeaderElectionBean();</span><br><span class="line">        MBeanRegistry.getInstance().register(self.jmxLeaderElectionBean, self.jmxLocalPeerBean);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</span><br><span class="line">        self.jmxLeaderElectionBean = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取与当前 JVM 高分辨率时间源相对应的时间，单位毫秒，</span></span><br><span class="line">    <span class="comment">// 防止启动 JVM 之后有人改动时间</span></span><br><span class="line">    self.start_fle = Time.currentElapsedTime();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * The votes from the current leader election are stored in recvset. In other words, a vote v is in recvset</span></span><br><span class="line"><span class="comment">         * if v.electionEpoch == logicalclock. The current participant uses recvset to deduce on whether a majority</span></span><br><span class="line"><span class="comment">         * of participants has voted for it.</span></span><br><span class="line"><span class="comment">         * 记录当前 Server 收到来自其他 Server 的本轮投票信息</span></span><br><span class="line"><span class="comment">         * key 为投票者的 ServerId value 为选票</span></span><br><span class="line"><span class="comment">         * recvset 集合就相当于票箱</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Map&lt;Long, Vote&gt; recvset = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * The votes from previous leader elections, as well as the votes from the current leader election are</span></span><br><span class="line"><span class="comment">         * stored in outofelection. Note that notifications in a LOOKING state are not stored in outofelection.</span></span><br><span class="line"><span class="comment">         * Only FOLLOWING or LEADING notifications are stored in outofelection. The current participant could use</span></span><br><span class="line"><span class="comment">         * outofelection to learn which participant is the leader if it arrives late (i.e., higher logicalclock than</span></span><br><span class="line"><span class="comment">         * the electionEpoch of the received notifications) in a leader election.</span></span><br><span class="line"><span class="comment">         * 用于记录所有不合法的选票</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Map&lt;Long, Vote&gt; outofelection = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> notTimeout = minNotificationInterval;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.将自己作为新的 Leader 广播出去</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// 新一轮选举，逻辑时钟+1</span></span><br><span class="line">            logicalclock.incrementAndGet();</span><br><span class="line">            <span class="comment">// 选举自己，修改当前 Server 的推荐信息</span></span><br><span class="line">            updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOG.info(</span><br><span class="line">            <span class="string">"New election. My id = &#123;&#125;, proposed zxid=0x&#123;&#125;"</span>,</span><br><span class="line">            self.getId(),</span><br><span class="line">            Long.toHexString(proposedZxid));</span><br><span class="line">        sendNotifications();</span><br><span class="line"></span><br><span class="line">        SyncedLearnerTracker voteSet;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Loop in which we exchange notifications until we find a leader</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 3. 验证当前自己的选票与大家的选票谁更适合做 Leader</span></span><br><span class="line">        <span class="keyword">while</span> ((self.getPeerState() == ServerState.LOOKING) &amp;&amp; (!stop)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Remove next notification from queue, times out after 2 times</span></span><br><span class="line"><span class="comment">             * the termination time</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Notification n = recvqueue.poll(notTimeout, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Sends more notifications if haven't received enough.</span></span><br><span class="line"><span class="comment">             * Otherwise processes new notification.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 判断当前服务器在集群中的连接是否正常</span></span><br><span class="line">                <span class="keyword">if</span> (manager.haveDelivered()) &#123;</span><br><span class="line">                    <span class="comment">// 重新发送通知。目的是为了接受其他 Server 再次发送通知</span></span><br><span class="line">                    sendNotifications();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 说明当前 Server 与集群已经失联</span></span><br><span class="line">                    <span class="comment">// 连接所有其他 Server</span></span><br><span class="line">                    <span class="comment">// 当前 Server 如果与集群失联，则其他 Server 一定不可能收到当前 Server 发送的通知</span></span><br><span class="line">                    <span class="comment">// 所以就会执行 sendNotifications()，只需要连接上所有其他 Server 即可，不用重新发送通知</span></span><br><span class="line">                    <span class="comment">// 也会收到其他所有 Server 所发送的通知</span></span><br><span class="line">                    manager.connectAll();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Exponential backoff</span></span><br><span class="line"><span class="comment">                 * 延长选举时长，但是最长不会超过60秒</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">int</span> tmpTimeOut = notTimeout * <span class="number">2</span>;</span><br><span class="line">                notTimeout = Math.min(tmpTimeOut, maxNotificationInterval);</span><br><span class="line">                LOG.info(<span class="string">"Notification time out: &#123;&#125;"</span>, notTimeout);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validVoter(n.sid) &amp;&amp; validVoter(n.leader)) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Only proceed if the vote comes from a replica in the current or next</span></span><br><span class="line"><span class="comment">                 * voting view for a replica in the current or next voting view.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">switch</span> (n.state) &#123;</span><br><span class="line">                <span class="keyword">case</span> LOOKING:</span><br><span class="line">                    <span class="keyword">if</span> (getInitLastLoggedZxid() == -<span class="number">1</span>) &#123;</span><br><span class="line">                        LOG.debug(<span class="string">"Ignoring notification as our zxid is -1"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (n.zxid == -<span class="number">1</span>) &#123;</span><br><span class="line">                        LOG.debug(<span class="string">"Ignoring notification from member with -1 zxid &#123;&#125;"</span>, n.sid);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// If notification &gt; current, replace and send messages out</span></span><br><span class="line">                    <span class="comment">// 外来通知 n 的 epoch 大于 本轮选举的逻辑时钟，说明本轮选举已经过时</span></span><br><span class="line">                    <span class="keyword">if</span> (n.electionEpoch &gt; logicalclock.get()) &#123;</span><br><span class="line">                        <span class="comment">// 更新本轮选举的逻辑时钟，使已经过时的本轮选举变为了当下选举</span></span><br><span class="line">                        logicalclock.set(n.electionEpoch);</span><br><span class="line">                        <span class="comment">// 清空票箱</span></span><br><span class="line">                        recvset.clear();</span><br><span class="line">                        <span class="comment">// 比较当前提议，谁更适合做 Leader</span></span><br><span class="line">                        <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) &#123;</span><br><span class="line">                            <span class="comment">// 无论是谁更适合做 Leader 都要更新提议</span></span><br><span class="line">                            updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">                        &#125;</span><br><span class="line">                        sendNotifications();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n.electionEpoch &lt; logicalclock.get()) &#123;</span><br><span class="line">                            LOG.debug(</span><br><span class="line">                                <span class="string">"Notification election epoch is smaller than logicalclock. n.electionEpoch = 0x&#123;&#125;, logicalclock=0x&#123;&#125;"</span>,</span><br><span class="line">                                Long.toHexString(n.electionEpoch),</span><br><span class="line">                                Long.toHexString(logicalclock.get()));</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, proposedLeader, proposedZxid, proposedEpoch)) &#123;</span><br><span class="line">                        updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                        sendNotifications();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    LOG.debug(</span><br><span class="line">                        <span class="string">"Adding vote: from=&#123;&#125;, proposed leader=&#123;&#125;, proposed zxid=0x&#123;&#125;, proposed election epoch=0x&#123;&#125;"</span>,</span><br><span class="line">                        n.sid,</span><br><span class="line">                        n.leader,</span><br><span class="line">                        Long.toHexString(n.zxid),</span><br><span class="line">                        Long.toHexString(n.electionEpoch));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// don't care about the version if it's in LOOKING state</span></span><br><span class="line">                    recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line"></span><br><span class="line">                    voteSet = getVoteTracker(recvset, <span class="keyword">new</span> Vote(proposedLeader, proposedZxid, logicalclock.get(), proposedEpoch));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 4. 判断本轮选举是否所有服务器都投票了</span></span><br><span class="line">                    <span class="keyword">if</span> (voteSet.hasAllQuorums()) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Verify if there is any change in the proposed leader</span></span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                         * 当前 while 有两个出口</span></span><br><span class="line"><span class="comment">                         * 1：循环条件结束，这个出口说明剩余通知中没有找到比任何当前(过半的选票)更适合的通知，出去时 n = null</span></span><br><span class="line"><span class="comment">                         * 2：break 这里出去，说明剩余的通知中找到了一个比当前(过半选票)更适合的通知，n 不为 null</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        <span class="keyword">while</span> ((n = recvqueue.poll(finalizeWait, TimeUnit.MILLISECONDS)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, proposedLeader, proposedZxid, proposedEpoch)) &#123;</span><br><span class="line">                                recvqueue.put(n);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         * This predicate is true once we don't read any new</span></span><br><span class="line"><span class="comment">                         * relevant message from the reception queue</span></span><br><span class="line"><span class="comment">                         * 结束选举、发送结束选举的通知，当前的选票过半的服务器就是最终的 Leader 了</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 判断自己是不是 leader，如果是就修改状态</span></span><br><span class="line">                            setPeerState(proposedLeader, voteSet);</span><br><span class="line">                            Vote endVote = <span class="keyword">new</span> Vote(proposedLeader, proposedZxid, logicalclock.get(), proposedEpoch);</span><br><span class="line">                            leaveInstance(endVote);</span><br><span class="line">                            <span class="keyword">return</span> endVote;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">// 5. 无需选举的情况</span></span><br><span class="line">                <span class="keyword">case</span> OBSERVING:</span><br><span class="line">                    LOG.debug(<span class="string">"Notification from observer: &#123;&#125;"</span>, n.sid);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">// 1.新的 Server(非 Observer) 加入到正常运行的集群</span></span><br><span class="line">                    <span class="comment">// 2.当 Leader 挂了，并不是所有 Follower 都同时能够感知到 Leader 挂了。</span></span><br><span class="line">                    <span class="comment">// 先感知到的 Server 会发送通知发送给其他 Server，但由于其他 Server 还未感知到</span></span><br><span class="line">                    <span class="comment">// 所以发送给这个 Server 的通知状态就是 Following</span></span><br><span class="line">                    <span class="comment">// 3.本轮选举中，其他 Server 已经选举出了新的 Leader，但还没有通知到当前 Server</span></span><br><span class="line">                    <span class="comment">// 这些已经知道了 Leader 选举完毕的 Server 向该 Server 发送的通知就是 Leading 或 </span></span><br><span class="line">                    <span class="comment">// Following</span></span><br><span class="line">                <span class="keyword">case</span> FOLLOWING:</span><br><span class="line">                <span class="keyword">case</span> LEADING:</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * Consider all notifications from the same epoch</span></span><br><span class="line"><span class="comment">                     * 外来通知的逻辑时钟与本轮选举的逻辑时钟相同，上述第三种情况</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> (n.electionEpoch == logicalclock.get()) &#123;</span><br><span class="line">                        recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch, n.state));</span><br><span class="line">                        voteSet = getVoteTracker(recvset, <span class="keyword">new</span> Vote(n.version, n.leader, n.zxid, n.electionEpoch, n.peerEpoch, n.state));</span><br><span class="line">                        <span class="keyword">if</span> (voteSet.hasAllQuorums() &amp;&amp; checkLeader(recvset, n.leader, n.electionEpoch)) &#123;</span><br><span class="line">                            setPeerState(n.leader, voteSet);</span><br><span class="line">                            Vote endVote = <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch);</span><br><span class="line">                            leaveInstance(endVote);</span><br><span class="line">                            <span class="keyword">return</span> endVote;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * Before joining an established ensemble, verify that</span></span><br><span class="line"><span class="comment">                     * a majority are following the same leader.</span></span><br><span class="line"><span class="comment">                     * Note that the outofelection map also stores votes from the current leader election.</span></span><br><span class="line"><span class="comment">                     * See ZOOKEEPER-1732 for more information.</span></span><br><span class="line"><span class="comment">                     * 以下代码用于处理一个 Server 加入到一个已经选举出 Leader 的集群中的 情况</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    outofelection.put(n.sid, <span class="keyword">new</span> Vote(n.version, n.leader, n.zxid, n.electionEpoch, n.peerEpoch, n.state));</span><br><span class="line">                    voteSet = getVoteTracker(outofelection, <span class="keyword">new</span> Vote(n.version, n.leader, n.zxid, n.electionEpoch, n.peerEpoch, n.state));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (voteSet.hasAllQuorums() &amp;&amp; checkLeader(outofelection, n.leader, n.electionEpoch)) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                            logicalclock.set(n.electionEpoch);</span><br><span class="line">                            setPeerState(n.leader, voteSet);</span><br><span class="line">                        &#125;</span><br><span class="line">                        Vote endVote = <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch);</span><br><span class="line">                        leaveInstance(endVote);</span><br><span class="line">                        <span class="keyword">return</span> endVote;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    LOG.warn(<span class="string">"Notification state unrecoginized: &#123;&#125; (n.state), &#123;&#125;(n.sid)"</span>, n.state, n.sid);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!validVoter(n.leader)) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Ignoring notification for non-cluster member sid &#123;&#125; from sid &#123;&#125;"</span>, n.leader, n.sid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!validVoter(n.sid)) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">"Ignoring notification for sid &#123;&#125; from non-quorum member sid &#123;&#125;"</span>, n.leader, n.sid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (self.jmxLeaderElectionBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">                MBeanRegistry.getInstance().unregister(self.jmxLeaderElectionBean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">"Failed to unregister with JMX"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        self.jmxLeaderElectionBean = <span class="keyword">null</span>;</span><br><span class="line">        LOG.debug(<span class="string">"Number of connection processing threads: &#123;&#125;"</span>, manager.getConnectionThreadCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Zookeeper-技术内幕"><a href="#Zookeeper-技术内幕" class="headerlink" title="Zookeeper 技术内幕"></a>Zookeeper 技术内幕</h1><hr>
<h2 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h2><p> zk 数据存储结构，与 Unix 文件系统非常相似，都是在根节点下挂很多子节点。zk 中没有引入传统文件系统中目录与文件的概念，而是使用 znode 的数据节点概念。znode 是 zk 中数据的最小单元，每个 znode 上都可以保存数据，同时还可以挂载子节点，形成一个树形化命名空间。</p>
<p>节点分为：持久节点，持久顺序节点、临时节点(生命周期与客户端的会话绑定在一起，不能有子节点)、临时顺序节点<br>节点状态：</p>
<ul>
<li>cZxid 当前 znode 被创建时的事务id</li>
<li>ctime 当前 znode 被创建的时间</li>
<li>mZxid 当前 znode 最后一次被修改时的事务id</li>
<li>mtime 当前 znode 最后一次被修改时的时间</li>
<li>pZxid 表示当前 znode 的子节点列表最后一次被修改时的事务 id，只能是其子节点列表变更了才会引起 pZxid 的变更，子节点内容的修改不会影响 pZxid</li>
<li>cversion 子节点的版本号，该版本号用于充当乐观锁</li>
<li>dataVersion 当前 znode 数据的版本号。该版本号用于充当乐观锁</li>
<li>aclVertsion 当前 znode 的权限 ACL 的版本号。该版本号用于充当乐观锁</li>
<li>ephemeralOwner 若当前 znode 是持久节点，则其值为0，若为临时节点，其值为创建该节点的会话的 sessionId，会话消失后，会根据 sessionId 来查找与会话相关的临时节点进行删除</li>
<li>dataLength 当前 znode 中存放的数据长度</li>
<li>numChildren 当前 znode 所包含的子节点的个数</li>
</ul>
<h2 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h2><h3 id="会话状态"><a href="#会话状态" class="headerlink" title="会话状态"></a>会话状态</h3><p>常见的会话状态三种：</p>
<p>Connecting 连接中，客户端要创建连接，其首先会在客户端创建一个 zk 对象，代表服务器。采用轮询的方式对服务器列表逐个尝试连接，知道成功。为了对 Server 进行负载均衡，会首先对服务器列表进行打散操作，然后再轮询</p>
<p>Connected 已经连接</p>
<p>Closed 连接关闭</p>
<h3 id="会话连接事件"><a href="#会话连接事件" class="headerlink" title="会话连接事件"></a>会话连接事件</h3><p>客户端与服务端的长连接失效后，客户端将进行重连。重连过程中，客户端会产生三种会话连接事件</p>
<ul>
<li>Connection_loss 连接丢失，因为网络抖动等原因导致连接中断，在客户端会引发连接丢失，该事件会触发客户端逐个尝试连接服务器，直到连接成功</li>
<li>session_moved 会话转移，当连接丢失后，在 SessionTimeout 内重连成功，则 SessionId 是不变的，若两次连接上的 Server 不是同一个，则会引发会话转移事件。会引发客户端更新本地 zk 对象的相关信息。</li>
<li>session_expired 会话失效。若客户端在 SessionTimeout 时间内没有连接成功，则服务器会将该会话清除，并向 Client 发送通知，但在 Client 收到通知之前，又连上了 Server，此时这个会话是失效的，会引发会话失效事件。该事件会触发客户端重新生成新的 SessionId 重新连接 Server</li>
</ul>
<h3 id="会话连接的超时管理-分桶策略"><a href="#会话连接的超时管理-分桶策略" class="headerlink" title="会话连接的超时管理-分桶策略"></a>会话连接的超时管理-分桶策略</h3><p>将时间相近的会话放在一个块中管理，减少管理的复杂度。表示，只需要在某一个时间点，检查当前桶中剩下的会话即可，因为没有超时的会话已经被移出了桶，桶中存在的会话就是超时会话。</p>
<p>分桶计算依据：<br><code>ExpirationTime = CurrentTime(连接时间点) + SessionTimeout</code><br><code>Bucket = ExpirationTime / ExpirationInterval + 1</code> –&gt; 第几个桶</p>
<p>一个桶的时长为 ExpirationInterval，只要 ExpirationTime 落入到同一个桶中，系统就会对其中的超时会话进行统一管理。</p>
<h2 id="ACL-访问控制列表"><a href="#ACL-访问控制列表" class="headerlink" title="ACL 访问控制列表"></a>ACL 访问控制列表</h2><p>Access Control List，细粒度的权限管理策略。可以对任意用户与组进行细粒度的权限控制。zk 利用 ACL 控制 znode 节点的访问权限，如 节点数据读写、节点创建、删除、读取子节点列表、设置节点权限等。</p>
<p>UGO，粗粒度权限管理，Linux 2.4 以后支持 ACL。User Group Other。无法单独管理 Other 下的用户</p>
<p>Unix/Linux 系统的 ACL 分为两个维度：组与权限，且目录的子目录或文件能够继承父目录的 ACL。<br>Zookeeper 的 ACL 分为三个维度：授权策略scheme、授权对象id、用户权限 permission，<strong>子znode 不会继承父 znode 的权限</strong></p>
<h3 id="授权策略-scheme"><a href="#授权策略-scheme" class="headerlink" title="授权策略 scheme"></a>授权策略 scheme</h3><p>通过什么来验证权限，即一个用户要访问某个 znode，如何验证其身份，在 zk 中最常用的有四种</p>
<ul>
<li>ip 根据ip进行验证</li>
<li>digest 根据用户名密码进行验证</li>
<li>world 对所有用户不做任何验证</li>
<li>super 超级用户对任意节点具有任意操作权限</li>
</ul>
<h3 id="授权对象id"><a href="#授权对象id" class="headerlink" title="授权对象id"></a>授权对象id</h3><p>权限赋予的用户</p>
<ul>
<li>ip 将权限授予某个指定 ip</li>
<li>digest 将权限授予具有指定用户名与密码的用户</li>
<li>world 将权限授予某一个用户 anyone</li>
<li>super 将权限授予具有指定用户名密码的用户</li>
</ul>
<h3 id="权限-Permission"><a href="#权限-Permission" class="headerlink" title="权限 Permission"></a>权限 Permission</h3><p>通过验证的用户可以对 znode 做出的操作行为，一共五种权限，zk 支持自定义权限</p>
<ul>
<li>c Create，允许授权对象在当前节点创建子节点</li>
<li>d Delete，允许授权对象删除当前节点</li>
<li>r Read 允许授权对象读取当前节点的数据内容及子节点列表</li>
<li>w Write 允许授权对象修改当前节点数据内容及子节点列表(可以为当前节点增/删子节点)</li>
<li>a ACL，允许授权对象对当前节点进行 ACL 设置</li>
</ul>
<h2 id="Watcher-机制"><a href="#Watcher-机制" class="headerlink" title="Watcher 机制"></a>Watcher 机制</h2><p>zk 的 watcher 机制有以下特性</p>
<ul>
<li>watcher 不适合监听变化非常频繁的场景</li>
<li>只有当当前的 watcher 回调执行完毕了，才会向 Server 注册新的 watcher(这里的新的 watcher 是对同一个节点相同事件类型的监听)</li>
<li>Client 向 Server 发送的 watcher 不是一个完整的，是一个简易版 watcher，回调逻辑不是 Server 端的，而是 Client。所以服务端较轻量。</li>
</ul>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006277569430-zookeeper.jpg" alt=""></p>
<h1 id="客户端命令"><a href="#客户端命令" class="headerlink" title="客户端命令"></a>客户端命令</h1><hr>
<h2 id="启动客户端"><a href="#启动客户端" class="headerlink" title="启动客户端"></a>启动客户端</h2><ol>
<li>连接本机 zk 服务器 <code>zkcli.sh</code></li>
<li>连接其他 zk 服务器 <code>zkcli.sh -server 192.168.59.117:2181</code></li>
</ol>
<h2 id="查看子节点-ls"><a href="#查看子节点-ls" class="headerlink" title="查看子节点 -ls"></a>查看子节点 -ls</h2><p>查看根节点及 <code>/brokers</code> 节点下所包含的所有子节点列表</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006283545390-zookeeper.jpg" alt=""></p>
<h2 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h2><ul>
<li>创建永久节点</li>
</ul>
<p>创建一个名称为 china 的 znode，值为 999</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006284439721-zookeeper.jpg" alt=""></p>
<ul>
<li>创建顺序节点</li>
</ul>
<p>在 <code>/china</code> 节点下创建了顺序子节点 beijing、shanghai、guangzhou，他们数据分别为 bj、sh、gz。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006285092323-zookeeper.jpg" alt=""></p>
<ul>
<li>创建临时节点</li>
</ul>
<p>临时节点与持久节点的区别，在后面 get 命令中可以看到。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006285787218-zookeeper.jpg" alt=""></p>
<h2 id="获取节点信息"><a href="#获取节点信息" class="headerlink" title="获取节点信息"></a>获取节点信息</h2><ul>
<li>获取持久节点数据</li>
</ul>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006286665151-zookeeper.jpg" alt=""></p>
<ul>
<li>获取顺序节点信息</li>
</ul>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006286908632-zookeeper.jpg" alt=""></p>
<ul>
<li>获取临时节点信息</li>
</ul>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006287240693-zookeeper.jpg" alt=""></p>
<h2 id="更新节点数据内容"><a href="#更新节点数据内容" class="headerlink" title="更新节点数据内容"></a>更新节点数据内容</h2><p>更新前：</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006287748683-zookeeper.jpg" alt=""></p>
<p>更新后：</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006288104555-zookeeper.jpg" alt=""></p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006288486330-zookeeper.jpg" alt=""></p>
<h2 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h2><p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006288760314-zookeeper.jpg" alt=""></p>
<p>若要删除具有子节点的节点会报错</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006289119563-zookeeper.jpg" alt=""></p>
<h2 id="ACL-操作"><a href="#ACL-操作" class="headerlink" title="ACL 操作"></a>ACL 操作</h2><ul>
<li>查看权限</li>
</ul>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006289675139-zookeeper.jpg" alt=""></p>
<ul>
<li>设置权限</li>
</ul>
<p>下面的命令是，首先增加了一个认证用户 zs，密码为123，然后为 <code>/china</code> 节点指定只有 zs 用户才可访问该节点，而访问权限为所有权限。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/zookeeper/16006290389224-zookeeper.jpg" alt=""></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ammar</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lizhaoloveit.cn/2020/09/07/Zookeeper/">http://lizhaoloveit.cn/2020/09/07/Zookeeper/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lizhaoloveit.cn">Ammar's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Zookeeper/">Zookeeper    </a></div><div class="post_share"><div class="social-share" data-image="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/07/Zookeeper%E7%9A%84%E5%BA%94%E7%94%A8/"><img class="prev_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Zookeeper的应用</span></div></a></div><div class="next-post pull-right"><a href="/2020/07/28/MyBatis-Generator/"><img class="next_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>MyBatis Generator</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'http://lizhaoloveit.cn/2020/09/07/Zookeeper/';
  this.page.identifier = '2020/09/07/Zookeeper/';
  this.page.title = 'Zookeeper';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'lizhao' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2023 By Ammar</div><div class="icp"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener"><span>浙ICP备19013619号-1</span></a></div><div class="bag"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010502006128" target="_blank" rel="noopener"><img src="/img/beian.png"><span>浙公网安备 33010502006128号</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="far fa-moon nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script async src="/js/search/algolia.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>