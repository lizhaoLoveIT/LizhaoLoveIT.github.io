<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>MySQL进阶 | Ammar's Blog</title><meta name="description" content="MySQL进阶"><meta name="keywords" content="数据库"><meta name="author" content="Ammar"><meta name="copyright" content="Ammar"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://lizhaoloveit.cn/2020/06/20/MySQL%E8%BF%9B%E9%98%B6/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="MySQL进阶"><meta name="twitter:description" content="MySQL进阶"><meta name="twitter:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta property="og:type" content="article"><meta property="og:title" content="MySQL进阶"><meta property="og:url" content="http://lizhaoloveit.cn/2020/06/20/MySQL%E8%BF%9B%E9%98%B6/"><meta property="og:site_name" content="Ammar's Blog"><meta property="og:description" content="MySQL进阶"><meta property="og:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="Redis进阶" href="http://lizhaoloveit.cn/2020/07/09/Redis%E8%BF%9B%E9%98%B6/"><link rel="next" title="SpringMVC源码分析" href="http://lizhaoloveit.cn/2020/06/12/SpringMVC%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?162506e75ffd64287398566b2f5738c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"VRMKRAV9AT","apiKey":"bd7157400046d0f02396708a501a3480","indexName":"lizhaoloveit","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://lizhaoloveit.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script><meta name="generator" content="Hexo 4.2.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql的结构图"><span class="toc-number">1.</span> <span class="toc-text">Mysql的结构图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#逻辑结构"><span class="toc-number">1.1.</span> <span class="toc-text">逻辑结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#系统层"><span class="toc-number">1.1.1.</span> <span class="toc-text">系统层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#业务层"><span class="toc-number">1.1.2.</span> <span class="toc-text">业务层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#存储引擎-Pluggable-Storage-Engines"><span class="toc-number">1.1.3.</span> <span class="toc-text">存储引擎(Pluggable Storage Engines)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一条-sql-语句的执行流程"><span class="toc-number">1.1.4.</span> <span class="toc-text">一条 sql 语句的执行流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#物理结构"><span class="toc-number">1.2.</span> <span class="toc-text">物理结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#日志文件"><span class="toc-number">1.3.</span> <span class="toc-text">日志文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#错误日志-Error-Log"><span class="toc-number">1.3.1.</span> <span class="toc-text">错误日志 Error Log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二进制日志-bin-log"><span class="toc-number">1.3.2.</span> <span class="toc-text">二进制日志 bin log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通用查询日志-general-query-log"><span class="toc-number">1.3.3.</span> <span class="toc-text">通用查询日志 general query log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#慢查询日志-slow-query-log"><span class="toc-number">1.3.4.</span> <span class="toc-text">慢查询日志 slow_query_log</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据文件"><span class="toc-number">1.4.</span> <span class="toc-text">数据文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB-数据文件"><span class="toc-number">1.4.1.</span> <span class="toc-text">InnoDB 数据文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyIsam-数据文件"><span class="toc-number">1.4.2.</span> <span class="toc-text">MyIsam 数据文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-索引"><span class="toc-number">2.</span> <span class="toc-text">MySQL 索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#索引的存储结构-B-B-TREE"><span class="toc-number">2.1.</span> <span class="toc-text">索引的存储结构 B B+ TREE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#非聚集索引-MyISAM"><span class="toc-number">2.1.1.</span> <span class="toc-text">非聚集索引 MyISAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#聚集索引-InnoDB"><span class="toc-number">2.1.2.</span> <span class="toc-text">聚集索引 InnoDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回表和索引覆盖"><span class="toc-number">2.1.3.</span> <span class="toc-text">回表和索引覆盖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引使用场景"><span class="toc-number">2.2.</span> <span class="toc-text">索引使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#组合索引"><span class="toc-number">2.3.</span> <span class="toc-text">组合索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引失效"><span class="toc-number">2.4.</span> <span class="toc-text">索引失效</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#id"><span class="toc-number">2.4.1.</span> <span class="toc-text">id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select-type"><span class="toc-number">2.4.2.</span> <span class="toc-text">select_type</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#simple-简单类型"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">simple 简单类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#primary-amp-subquery-主从类型"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">primary&amp;subquery 主从类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DEPENDENT-SUBQUERY-主从有字段关联"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">DEPENDENT SUBQUERY 主从有字段关联</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#union-集合"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">union 集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dependent-union-这个查询受外部查询的影响"><span class="toc-number">2.4.2.5.</span> <span class="toc-text">dependent union 这个查询受外部查询的影响</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#union-result-包含-union-的结果集"><span class="toc-number">2.4.2.6.</span> <span class="toc-text">union result 包含 union 的结果集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#derived-派生表"><span class="toc-number">2.4.2.7.</span> <span class="toc-text">derived 派生表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#type"><span class="toc-number">2.4.3.</span> <span class="toc-text">type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小-tips"><span class="toc-number">2.4.4.</span> <span class="toc-text">小 tips</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#组合索引-1"><span class="toc-number">2.4.5.</span> <span class="toc-text">组合索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#possible-keys-amp-key-amp-key-len"><span class="toc-number">2.4.6.</span> <span class="toc-text">possible_keys &amp; key &amp; key_len</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#extra"><span class="toc-number">2.4.7.</span> <span class="toc-text">extra</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#distinct-效率低"><span class="toc-number">2.4.7.1.</span> <span class="toc-text">distinct(效率低)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#using-filesort"><span class="toc-number">2.4.7.2.</span> <span class="toc-text">using filesort</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#using-index"><span class="toc-number">2.4.7.3.</span> <span class="toc-text">using index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#using-where"><span class="toc-number">2.4.7.4.</span> <span class="toc-text">using where</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引失效分析"><span class="toc-number">2.5.</span> <span class="toc-text">索引失效分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql锁"><span class="toc-number">3.</span> <span class="toc-text">Mysql锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#表锁"><span class="toc-number">3.1.</span> <span class="toc-text">表锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Table-Read-Lock-表共享读"><span class="toc-number">3.1.1.</span> <span class="toc-text">Table Read Lock 表共享读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Table-Write-Lock-表独占写"><span class="toc-number">3.1.2.</span> <span class="toc-text">Table Write Lock 表独占写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#元数据锁"><span class="toc-number">3.2.</span> <span class="toc-text">元数据锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#行级锁"><span class="toc-number">3.3.</span> <span class="toc-text">行级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#共享读锁"><span class="toc-number">3.3.1.</span> <span class="toc-text">共享读锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#排他写锁"><span class="toc-number">3.3.2.</span> <span class="toc-text">排他写锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#行锁演示"><span class="toc-number">3.4.</span> <span class="toc-text">行锁演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#行读锁"><span class="toc-number">3.4.1.</span> <span class="toc-text">行读锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#行写锁"><span class="toc-number">3.4.2.</span> <span class="toc-text">行写锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#间隙锁"><span class="toc-number">3.4.3.</span> <span class="toc-text">间隙锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#死锁"><span class="toc-number">3.4.4.</span> <span class="toc-text">死锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#事务"><span class="toc-number">4.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB-架构图"><span class="toc-number">4.1.</span> <span class="toc-text">InnoDB 架构图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#插入缓冲-Insert-Buffer"><span class="toc-number">4.1.1.</span> <span class="toc-text">插入缓冲(Insert Buffer)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自适应哈希-Adaptive-Hash-Index"><span class="toc-number">4.1.2.</span> <span class="toc-text">自适应哈希(Adaptive Hash Index)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lock-info-锁信息"><span class="toc-number">4.1.3.</span> <span class="toc-text">lock info 锁信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-Dictionary-数据字典信息"><span class="toc-number">4.1.4.</span> <span class="toc-text">Data Dictionary 数据字典信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redo-log-Buffer-重做日志缓冲"><span class="toc-number">4.1.5.</span> <span class="toc-text">Redo log Buffer 重做日志缓冲</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#重做日志落盘机制"><span class="toc-number">4.1.5.1.</span> <span class="toc-text">重做日志落盘机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查点-checkPoint"><span class="toc-number">4.1.6.</span> <span class="toc-text">检查点 checkPoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sharp-checkpoint"><span class="toc-number">4.1.6.1.</span> <span class="toc-text">sharp checkpoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fuzzy-checkpoint"><span class="toc-number">4.1.6.2.</span> <span class="toc-text">fuzzy checkpoint</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Double-Write-双写"><span class="toc-number">4.1.7.</span> <span class="toc-text">Double Write 双写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UndoLog"><span class="toc-number">4.1.8.</span> <span class="toc-text">UndoLog</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事务的隔离级别"><span class="toc-number">4.2.</span> <span class="toc-text">事务的隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MVCC-机制"><span class="toc-number">4.2.1.</span> <span class="toc-text">MVCC 机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MVCC-的实现"><span class="toc-number">4.2.2.</span> <span class="toc-text">MVCC 的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一致性非锁定读-consistent-nonlocking-read"><span class="toc-number">4.2.3.</span> <span class="toc-text">一致性非锁定读(consistent nonlocking read)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Undo-Log"><span class="toc-number">4.2.4.</span> <span class="toc-text">Undo Log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务链表"><span class="toc-number">4.2.5.</span> <span class="toc-text">事务链表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReadView"><span class="toc-number">4.2.6.</span> <span class="toc-text">ReadView</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql-性能分析和优化"><span class="toc-number">5.</span> <span class="toc-text">Mysql 性能分析和优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-锁分析"><span class="toc-number">5.1.</span> <span class="toc-text">SQL 锁分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RC"><span class="toc-number">5.1.1.</span> <span class="toc-text">RC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RR"><span class="toc-number">5.1.2.</span> <span class="toc-text">RR</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用慢查询日志查询耗时比较长的-sql"><span class="toc-number">5.2.</span> <span class="toc-text">利用慢查询日志查询耗时比较长的 sql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mysqldumpslow"><span class="toc-number">5.2.1.</span> <span class="toc-text">mysqldumpslow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#percana-toolkit"><span class="toc-number">5.2.2.</span> <span class="toc-text">percana-toolkit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务器层面优化"><span class="toc-number">5.3.</span> <span class="toc-text">服务器层面优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#减少-IO-次数，扩大-buffer-pool"><span class="toc-number">5.3.1.</span> <span class="toc-text">减少 IO 次数，扩大 buffer pool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#降低磁盘写入次数"><span class="toc-number">5.3.2.</span> <span class="toc-text">降低磁盘写入次数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提高磁盘读写速度-SSD"><span class="toc-number">5.3.3.</span> <span class="toc-text">提高磁盘读写速度 SSD</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-设计优化"><span class="toc-number">5.4.</span> <span class="toc-text">SQL 设计优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-语句优化"><span class="toc-number">5.5.</span> <span class="toc-text">SQL 语句优化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#大厂面试题"><span class="toc-number">6.</span> <span class="toc-text">大厂面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#存储引擎-InnoDB-与-MyISAM-的区别，优缺点，使用场景"><span class="toc-number">6.1.</span> <span class="toc-text">存储引擎 InnoDB 与 MyISAM 的区别，优缺点，使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#说说-MySQL-优化之道"><span class="toc-number">6.2.</span> <span class="toc-text">说说 MySQL 优化之道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UndoLog-和-RedoLog-的区别和联系"><span class="toc-number">6.3.</span> <span class="toc-text">UndoLog 和 RedoLog 的区别和联系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL-索引的数据结构是什么？为什么使用这种数据结构"><span class="toc-number">6.4.</span> <span class="toc-text">MySQL 索引的数据结构是什么？为什么使用这种数据结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引失效的场景有哪些"><span class="toc-number">6.5.</span> <span class="toc-text">索引失效的场景有哪些</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是死锁和死锁的排查和解决"><span class="toc-number">6.6.</span> <span class="toc-text">什么是死锁和死锁的排查和解决</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RC和RR的实现原理及区别和使用场景"><span class="toc-number">6.7.</span> <span class="toc-text">RC和RR的实现原理及区别和使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分库与分表带来的分布式困境与应对之策"><span class="toc-number">6.8.</span> <span class="toc-text">分库与分表带来的分布式困境与应对之策</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://lizhaoloveit.cn/blogimages/blog/top_img.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Ammar's Blog</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description">微信号：aicjaish</div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a><a class="site-page" href="/comment/"><i class="fa-fw fa fa-coffee"></i><span> 留言</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">MySQL进阶</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-06-20<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-07-06</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/">Java</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">9.7k</span><span class="post-meta__separator">|</span><span>阅读时长: 35 分钟</span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="Mysql的结构图"><a href="#Mysql的结构图" class="headerlink" title="Mysql的结构图"></a>Mysql的结构图</h1><hr>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 id="逻辑结构"><a href="#逻辑结构" class="headerlink" title="逻辑结构"></a>逻辑结构</h2><hr>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15921115621639-mysql1.jpg"></p>
<h3 id="系统层"><a href="#系统层" class="headerlink" title="系统层"></a>系统层</h3><hr>
<ul>
<li>连接器(Connectors)</li>
<li>系统管理工具 Management Services &amp; Utillities</li>
<li>连接池</li>
</ul>
<h3 id="业务层"><a href="#业务层" class="headerlink" title="业务层"></a>业务层</h3><hr>
<ul>
<li>SQL Interface<ul>
<li>接收  SQL DML DDL</li>
</ul>
</li>
<li>解析器 Parser<ul>
<li>select * from t1</li>
<li>词法分析 分词 语法树</li>
<li>语法分析 ：符合 SQL 的语法，SQL 92(标准语法) limit MYSQL 自己的语法</li>
</ul>
</li>
<li>查询优化器(Optimizer)<ul>
<li>mysql 认为你写的 SQL 不够完美</li>
<li>优化：索引，只使用最优索引，</li>
<li>多表关联：</li>
<li>where 从左到右 mysql  从右到左 Oracel，过滤力度最大先执行。通过 explain 分析谁的过滤力度比较大。</li>
</ul>
</li>
<li>查询缓存(Cache 和 buffer)<ul>
<li>把查询结果存起来， SQL -&gt; hash 后的值 唯一 则表示缓存中有。</li>
<li>当数据库的数据发生改变时，新增、删除、更新后清除缓存。<strong>mysql8 以后就没有了。</strong></li>
</ul>
</li>
</ul>
<h3 id="存储引擎-Pluggable-Storage-Engines"><a href="#存储引擎-Pluggable-Storage-Engines" class="headerlink" title="存储引擎(Pluggable Storage Engines)"></a>存储引擎(Pluggable Storage Engines)</h3><hr>
<p>以表为单位，默认 InnoDB，InnoDB&#x2F;Memory&#x2F;MyISAM</p>
<table>
<thead>
<tr>
<th>存储引擎</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>MyISAM</strong></td>
<td>高速引擎，拥有较高的插入，查询速度，但不支持事务、不支持行锁、支持3种不同的存储格式。包括静态型、动态型和压缩型。</td>
</tr>
<tr>
<td><strong>InnoDB</strong></td>
<td>5.5版本后MySQL的默认数据库，<strong>支持事务和行级锁定，事务处理、回滚、崩溃修复能力和多版本并发控制的事务安全</strong>，比 MyISAM 处理速度稍慢。</td>
</tr>
<tr>
<td><strong>Memory</strong></td>
<td>内存存储引擎，拥有极高的插入，更新和查询效率，但是会占用和数据量成正比的存储空间，只在内存上保存数据，意味着数据可能会丢失。</td>
</tr>
</tbody></table>
<p>Memory 的使用场景：存储报表，临时表时 用到 memory。</p>
<blockquote>
<p>xtraDB 存储引擎是由 Percona 公司提供的存储引擎，该公司还出品了 Percona Server 这个产品，它是基于 MySQL 开源代码进行修改之后的产品，阿里对于 Percona Server 服务器进行修改，衍生了自己的数据库 alisql。</p>
</blockquote>
<h3 id="一条-sql-语句的执行流程"><a href="#一条-sql-语句的执行流程" class="headerlink" title="一条 sql 语句的执行流程"></a>一条 sql 语句的执行流程</h3><hr>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15921248268034-mysql1.jpg"><br><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15921248359329-mysql1.jpg"></p>
<p>连接模块校验连接是否正确，用户模块校验连接用户是否有表操作权限，访问控制模块校验用户是否有命令执行权限。</p>
<h2 id="物理结构"><a href="#物理结构" class="headerlink" title="物理结构"></a>物理结构</h2><hr>
<p>MySQL 通过文件存储数据和索引的。<br>MySQL 从物理上分为日志文件和数据索引文件<br>日志文件采用顺序 IO 方式存储、数据文件采用随机 IO 方式存储。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15921254977227-mysql1.jpg"></p>
<h2 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h2><hr>
<h3 id="错误日志-Error-Log"><a href="#错误日志-Error-Log" class="headerlink" title="错误日志 Error Log"></a>错误日志 Error Log</h3><p>默认开启，且 5.5.7 以后无法关闭，记录运行过程中遇到的所有严重的错误信息，一级 MySQL 每次启动和关闭的详细信息。 </p>
<p>mysql8.0.2 中文件夹为：<code>/usr/local/mysql/data/mysqld.local.err</code></p>
<h3 id="二进制日志-bin-log"><a href="#二进制日志-bin-log" class="headerlink" title="二进制日志 bin log"></a>二进制日志 bin log</h3><p>记录数据变化，bin log 记录了数据库所有 ddl 语句和 dml 语句，但不包括 select 语句内容，语句以事件的形式保存，描述了数据的变更顺序，bin log 还包括每个更新语句的执行时间信息。如果是 ddl 语句，则直接记录到 bin log 日志，dml 语句 必须通过事务提交才能记录到 bin log 日志中。生产中开启，数据备份、恢复、主从。</p>
<h3 id="通用查询日志-general-query-log"><a href="#通用查询日志-general-query-log" class="headerlink" title="通用查询日志 general query log"></a>通用查询日志 general query log</h3><p>啥都记录，耗性能，生产中不建议开启。</p>
<h3 id="慢查询日志-slow-query-log"><a href="#慢查询日志-slow-query-log" class="headerlink" title="慢查询日志 slow_query_log"></a>慢查询日志 slow_query_log</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%slow_query%'</span>; <span class="comment">-- 可以用这个查询所有的变量</span></span><br><span class="line"></span><br><span class="line">//第一步</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_output=<span class="string">'TABLE'</span>; <span class="comment">-- 开启慢日志,纪录到 mysql.slow_log 表</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> long_query_time=<span class="number">2</span>; <span class="comment">-- 设置超过2秒的查询为慢查询</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log=<span class="string">'ON'</span>;<span class="comment">-- 打开慢日志记录</span></span><br><span class="line"></span><br><span class="line">//第二步 运行一下比较慢的功能,执行下面的语句</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">convert</span>(sql_text <span class="keyword">using</span> utf8) sql_text <span class="keyword">from</span> mysql.slow_log <span class="comment">-- 查询慢sql的 日志</span></span><br><span class="line">//第三步 记得关上日志</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log=<span class="string">'OFF'</span>; <span class="comment">-- 如果不用了记得关上日志</span></span><br></pre></td></tr></table></figure>

<p>下面是清除日志的方法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log = <span class="string">'OFF'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> mysql.slow_log <span class="keyword">RENAME</span> mysql.slow_log_drop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`mysql`</span>.<span class="string">`slow_log`</span> (</span><br><span class="line">  <span class="string">`start_time`</span> <span class="built_in">timestamp</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>(<span class="number">6</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>(<span class="number">6</span>),</span><br><span class="line">  <span class="string">`user_host`</span> mediumtext <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`query_time`</span> <span class="built_in">time</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`lock_time`</span> <span class="built_in">time</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`rows_sent`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`rows_examined`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`db`</span> <span class="built_in">varchar</span>(<span class="number">512</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`last_insert_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`insert_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`server_id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`sql_text`</span> mediumblob <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`thread_id`</span> <span class="built_in">bigint</span>(<span class="number">21</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=CSV <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'Slow log'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log = <span class="string">'ON'</span>;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> mysql.slow_log_drop;</span><br></pre></td></tr></table></figure>

<p>重做日志 redo log、回滚日志 undo log 中继日志 relay log</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'log_%';</span><br><span class="line">+<span class="comment">----------------------------------------+----------------------------------------+</span></span><br><span class="line">| Variable_name                          | Value                                  |</span><br><span class="line">+<span class="comment">----------------------------------------+----------------------------------------+</span></span><br><span class="line">| log_bin                                | ON                                     |</span><br><span class="line">| log_bin_basename                       | /usr/local/mysql/data/binlog           |</span><br><span class="line">| log_bin_index                          | /usr/local/mysql/data/binlog.index     |</span><br><span class="line">| log_bin_trust_function_creators        | OFF                                    |</span><br><span class="line">| log_bin_use_v1_row_events              | OFF                                    |</span><br><span class="line">| log_error                              | /usr/local/mysql/data/mysqld.local.err |</span><br><span class="line">| log_error_services                     | log_filter_internal; log_sink_internal |</span><br><span class="line">| log_error_suppression_list             |                                        |</span><br><span class="line">| log_error_verbosity                    | 2                                      |</span><br><span class="line">| log_output                             | FILE                                   |</span><br><span class="line">| log_queries_not_using_indexes          | OFF                                    |</span><br><span class="line">| log_raw                                | OFF                                    |</span><br><span class="line">| log_slave_updates                      | ON                                     |</span><br><span class="line">| log_slow_admin_statements              | OFF                                    |</span><br><span class="line">| log_slow_extra                         | OFF                                    |</span><br><span class="line">| log_slow_slave_statements              | OFF                                    |</span><br><span class="line">| log_statements_unsafe_for_binlog       | ON                                     |</span><br><span class="line">| log_throttle_queries_not_using_indexes | 0                                      |</span><br><span class="line">| log_timestamps                         | UTC                                    |</span><br><span class="line">+<span class="comment">----------------------------------------+----------------------------------------+</span></span><br></pre></td></tr></table></figure>

<h2 id="数据文件"><a href="#数据文件" class="headerlink" title="数据文件"></a>数据文件</h2><hr>
<h3 id="InnoDB-数据文件"><a href="#InnoDB-数据文件" class="headerlink" title="InnoDB 数据文件"></a>InnoDB 数据文件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE '%datadir%';</span><br><span class="line">+<span class="comment">---------------+------------------------+</span></span><br><span class="line">| Variable_name | Value                  |</span><br><span class="line">+<span class="comment">---------------+------------------------+</span></span><br><span class="line">| datadir       | /usr/local/mysql/data/ |</span><br><span class="line">+<span class="comment">---------------+------------------------+</span></span><br></pre></td></tr></table></figure>
<ul>
<li>.frm 文件：存放与表相关的数据信息，包括表结构的定义信息</li>
<li>.ibd 使用独享表空间存储表数据和索引信息，一张表对应一个ibd文件</li>
<li>ibdata文件：使用共享表空间存储表数据和索引信息，所有表共同使用一个或者多个ibdata文件。</li>
</ul>
<h3 id="MyIsam-数据文件"><a href="#MyIsam-数据文件" class="headerlink" title="MyIsam 数据文件"></a>MyIsam 数据文件</h3><ul>
<li>.frm 主要存放表结构定义信息</li>
<li>.myd文件 存储表数据信息</li>
<li>.myi文件 主要存储表数据文件中任何索引的数据树</li>
</ul>
<h1 id="MySQL-索引"><a href="#MySQL-索引" class="headerlink" title="MySQL 索引"></a>MySQL 索引</h1><hr>
<p>优势：提高数据检索效率，降低IO成本。通过索引列队数据进行排序，降低CPU消耗。<br>劣势：占据磁盘空间，降低更新表的效率。</p>
<h2 id="索引的存储结构-B-B-TREE"><a href="#索引的存储结构-B-B-TREE" class="headerlink" title="索引的存储结构 B B+ TREE"></a>索引的存储结构 B B+ TREE</h2><hr>
<ul>
<li>不同的存储引擎，会使用不同的索引</li>
<li>MyISAM 和 InnoDB 存储引擎：只支持 B+ TREE 索引，默认使用BTREE，不能更换</li>
<li>Memory&#x2F;Heap 存储引擎：支持HASH和BTREE索引</li>
</ul>
<p>B 树高度一般在2-4这个高度，树的高度直接影响IO读写的次数。如果是三层树结构，支撑的数据可以达到20G，如果是四层树结构，支撑的数据可以达到几十T</p>
<p>B树和B+树最大的区别在于非叶子节点是否会存储数据。<br>B树是非叶子节点和叶子节点都会存储数据。B+树只有叶子节点才会存储数据，而且存储的数据都是在一行上，这些数据都是有指针指向的，也就是有顺序的。</p>
<h3 id="非聚集索引-MyISAM"><a href="#非聚集索引-MyISAM" class="headerlink" title="非聚集索引 MyISAM"></a>非聚集索引 MyISAM</h3><p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15921431475096-mysql1.jpg"></p>
<h3 id="聚集索引-InnoDB"><a href="#聚集索引-InnoDB" class="headerlink" title="聚集索引 InnoDB"></a>聚集索引 InnoDB</h3><p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15921435914361-mysql1.jpg"></p>
<h3 id="回表和索引覆盖"><a href="#回表和索引覆盖" class="headerlink" title="回表和索引覆盖"></a>回表和索引覆盖</h3><blockquote>
<p>如果查询条件为主键，则只需要扫描一次 B+ 树即可通过聚集索引定位到要查找的行记录数据。<br>如果查询条件为普通索引，需要扫描两次 B+ 树，第一次扫描通过普通索引定位到聚集索引的值，然后第二次扫描通过聚集索引的值定位到要查找的行记录数据。这种就是回表查询。它的性能较扫描一遍索引树更低。<br>索引覆盖： 只需要在一棵索引树上就能获取 SQL 所需的所有列数据，无需回表，速度更快。<br>如何实现索引覆盖？</p>
</blockquote>
<p>常见的方法：将被查询的字段，建立到联合索引里去。</p>
<h2 id="索引使用场景"><a href="#索引使用场景" class="headerlink" title="索引使用场景"></a>索引使用场景</h2><hr>
<p>需要创建索引：</p>
<ol>
<li>主键自动创建唯一索引</li>
<li>频繁作为查询条件的字段应该创建索引</li>
<li>多表关联查询中，关联字段应该创建索引 on 两边都要创建索引</li>
<li>查询中排序的字段，应该创建索引 B + tree 有顺序</li>
<li>覆盖索引 好处是不需要回表。组合索引达到覆盖索引</li>
<li>统计或者分组字段，应该创建索引</li>
</ol>
<p>不需要创建索引：</p>
<ol>
<li>表记录太少，索引是要有存储的开销</li>
<li>频繁更新 索引要维护</li>
<li>查询使用频率不高</li>
</ol>
<h2 id="组合索引"><a href="#组合索引" class="headerlink" title="组合索引"></a>组合索引</h2><hr>
<p>由多个字段组成的索引，组合索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`table_name`</span> <span class="keyword">ADD</span> <span class="keyword">INDEX</span> index_name(<span class="string">`col1`</span>, <span class="string">`col2`</span>, <span class="string">'col3'</span>);</span><br></pre></td></tr></table></figure>

<p>由3个字段创建的组合索引。组合索引的结构：</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15921456313967-mysql1.jpg"></p>
<blockquote>
<p>组合索引的使用顺序就是创建顺序，一棵树上有多个字段。<br>优势：省空间、容易形成覆盖索引(不回表查询)<br>当使用 like 常量% 使用索引， like %常量 不使用索引<br>从左到右匹配直到遇到范围查询 &gt; &lt; between 索引失效。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> t1 <span class="keyword">ADD</span> <span class="keyword">INDEX</span> idx_a_b_c_D(a, b, c, d);</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">index</span> <span class="keyword">from</span> t1;</span><br><span class="line"></span><br><span class="line">+<span class="comment">----------+----------+--------+------+------------+---------+---------------+ </span></span><br><span class="line">| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | </span><br><span class="line">Cardinality | Sub_part | Packed | Null | Index_type | <span class="keyword">Comment</span> | Index_comment | </span><br><span class="line">+<span class="comment">-------+----------+----------+--------+------+------------+---------+</span></span><br><span class="line">| t1 | <span class="number">0</span> | PRIMARY | <span class="number">1</span> | <span class="keyword">id</span> | A | <span class="number">1</span> | <span class="literal">NULL</span> | <span class="literal">NULL</span> | | BTREE | | | </span><br><span class="line">| t1 | <span class="number">1</span> | idx_a_b_c_d | <span class="number">1</span> | a | A | <span class="number">1</span> | <span class="literal">NULL</span> | <span class="literal">NULL</span> | YES | BTREE | | | </span><br><span class="line">| t1 | <span class="number">1</span> | idx_a_b_c_d | <span class="number">2</span> | b | A | <span class="number">1</span> | <span class="literal">NULL</span> | <span class="literal">NULL</span> | YES | BTREE | | | </span><br><span class="line">| t1 | <span class="number">1</span> | idx_a_b_c_d | <span class="number">3</span> | c | A | <span class="number">1</span> | <span class="literal">NULL</span> | <span class="literal">NULL</span> | YES | BTREE | | | </span><br><span class="line">| t1 | <span class="number">1</span> | idx_a_b_c_d | <span class="number">4</span> | d | A | <span class="number">1</span> | <span class="literal">NULL</span> | <span class="literal">NULL</span> | YES | BTREE | | | </span><br><span class="line">+<span class="comment">-------+------------+-------------+--------------+-------------+-----------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 上面的表表示一个索引，idx_a_b_c_d，上面有4个列，顺序为 abcd。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> t1 <span class="keyword">where</span> a=<span class="number">1</span> <span class="keyword">and</span> b=<span class="number">1</span> <span class="keyword">and</span> c=<span class="number">1</span> <span class="keyword">and</span> d=<span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line">+<span class="comment">----+-------------+-------+------+---------------+-------------+---------+</span></span><br><span class="line">| id | select_type | table | type | possible_keys | key | key_len | ref | rows | Extra | </span><br><span class="line">+<span class="comment">----+-------------+-------+------+---------------+-------------+---------+</span></span><br><span class="line">| 1 | SIMPLE | t1 | ref | idx_a_b_c_d | idx_a_b_c_d | 20 | const,const,const,const | 1 | Using index | </span><br><span class="line">+<span class="comment">----+-------------+-------+------+---------------+-------------+---------+</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>只要 type &#x3D; ref 就表示使用了索引。</strong></p>
</blockquote>
<h2 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h2><hr>
<p>explain 出来的信息有10列，分别是<br>id、select_type、table、type、possible_keys、key、key_len、ref、rows、Extra</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tuser(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">loginname <span class="built_in">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">age <span class="built_in">INT</span>,</span><br><span class="line">sex <span class="built_in">char</span>(<span class="number">1</span>),</span><br><span class="line">dep <span class="built_in">INT</span>,</span><br><span class="line">address <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 部门表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tdep(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 地址表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> taddr(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">	addr <span class="built_in">VARCHAR</span>(<span class="number">100</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建普通索引</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tuser <span class="keyword">ADD</span> <span class="keyword">INDEX</span> idx_dep(dep);</span><br><span class="line"><span class="comment">-- 创建唯一索引</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tuser <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> idx_loginname(loginname);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建组合索引</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tuser <span class="keyword">ADD</span> <span class="keyword">INDEX</span> idx_name_age_sex(<span class="keyword">name</span>, age, sex);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建全文索引</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> taddr <span class="keyword">ADD</span> FULLTEXT ft_addr(addr);</span><br></pre></td></tr></table></figure>

<h3 id="id"><a href="#id" class="headerlink" title="id"></a>id</h3><p>每个 select 语句都会自动分配一个唯一标识符。<br>表示查询中操作表的顺序，id越大，优先级越高。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> (<span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> tuser) <span class="keyword">from</span> tuser ;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------------------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key              | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------------------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | PRIMARY     | tuser | NULL       | index | NULL          | idx_dep          | 5       | NULL |    1 |   100.00 | Using index |</span><br><span class="line">|  2 | SUBQUERY    | tuser | NULL       | index | NULL          | idx_name_age_sex | 312     | NULL |    1 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------------------+---------+------+------+----------+-------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="select-type"><a href="#select-type" class="headerlink" title="select_type"></a>select_type</h3><p>表明查询类型。</p>
<h4 id="simple-简单类型"><a href="#simple-简单类型" class="headerlink" title="simple 简单类型"></a>simple 简单类型</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | tuser | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+</span></span><br></pre></td></tr></table></figure>

<h4 id="primary-amp-subquery-主从类型"><a href="#primary-amp-subquery-主从类型" class="headerlink" title="primary&amp;subquery 主从类型"></a>primary&amp;subquery 主从类型</h4><p>一个需要union操作或者含有子查询的select，位于最外层的单位查询的select_type即为primary。且只 有一个<br>除了from字句中包含的子查询外，其他地方出现的子查询都可能是subquery</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> (<span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> tuser) <span class="keyword">from</span> tuser ;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------------------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key              | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------------------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | PRIMARY     | tuser | NULL       | index | NULL          | idx_dep          | 5       | NULL |    1 |   100.00 | Using index |</span><br><span class="line">|  2 | SUBQUERY    | tuser | NULL       | index | NULL          | idx_name_age_sex | 312     | NULL |    1 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------------------+---------+------+------+----------+-------------+</span></span><br></pre></td></tr></table></figure>

<h4 id="DEPENDENT-SUBQUERY-主从有字段关联"><a href="#DEPENDENT-SUBQUERY-主从有字段关联" class="headerlink" title="DEPENDENT SUBQUERY 主从有字段关联"></a>DEPENDENT SUBQUERY 主从有字段关联</h4><p>与dependent union类似，表示这个subquery的查询要受到外部表查询的影响</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,(<span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> tdep a <span class="keyword">where</span> a.id=b.dep) <span class="keyword">from</span> tuser b;</span><br><span class="line">+<span class="comment">----+--------------------+-------+------------+--------+---------------+---------+---------+---------------+------+----------+-------+</span></span><br><span class="line">| id | select_type        | table | partitions | type   | possible_keys | key     | key_len | ref           | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+--------------------+-------+------------+--------+---------------+---------+---------+---------------+------+----------+-------+</span></span><br><span class="line">|  1 | PRIMARY            | b     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL          |    1 |   100.00 | NULL  |</span><br><span class="line">|  2 | DEPENDENT SUBQUERY | a     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | javaweb.b.dep |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+--------------------+-------+------------+--------+---------------+---------+---------+---------------+------+----------+-------+</span></span><br></pre></td></tr></table></figure>

<h4 id="union-集合"><a href="#union-集合" class="headerlink" title="union 集合"></a>union 集合</h4><p>union 连接两个 select 查询，第一个查询是 primary，除了第一个表外，第二个以后的表都是 union</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tuser <span class="keyword">where</span> sex=<span class="string">'1'</span> <span class="keyword">union</span> <span class="keyword">select</span> * <span class="keyword">from</span> tuser <span class="keyword">where</span> sex=<span class="string">'2'</span>;</span><br><span class="line">+<span class="comment">------+--------------+------------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span></span><br><span class="line">| id   | select_type  | table      | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra           |</span><br><span class="line">+<span class="comment">------+--------------+------------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span></span><br><span class="line">|    1 | PRIMARY      | tuser      | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    1 |   100.00 | Using where     |</span><br><span class="line">|    2 | UNION        | tuser      | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    1 |   100.00 | Using where     |</span><br><span class="line">| NULL | UNION RESULT | &lt;union1,2&gt; | NULL       | ALL  | NULL          | NULL | NULL    | NULL | NULL | NULL     | Using temporary |</span><br><span class="line">+<span class="comment">------+--------------+------------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span></span><br></pre></td></tr></table></figure>

<h4 id="dependent-union-这个查询受外部查询的影响"><a href="#dependent-union-这个查询受外部查询的影响" class="headerlink" title="dependent union 这个查询受外部查询的影响"></a>dependent union 这个查询受外部查询的影响</h4><h4 id="union-result-包含-union-的结果集"><a href="#union-result-包含-union-的结果集" class="headerlink" title="union result 包含 union 的结果集"></a>union result 包含 union 的结果集</h4><p>因为其不需要参与查询，所以 id 字段为 null</p>
<h4 id="derived-派生表"><a href="#derived-派生表" class="headerlink" title="derived 派生表"></a>derived 派生表</h4><p>只出现在一种情况， from 后面带 select</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> (<span class="keyword">select</span> * <span class="keyword">from</span> tuser <span class="keyword">where</span> sex=<span class="string">'1'</span>) b;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | PRIMARY      | &lt;derived2&gt; | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    2 |   100.00 | NULL |</span><br><span class="line">|  2 | DERIVED      | tuser | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    1 |   100.00 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p><strong>好-&gt;差：system &gt; const &gt; eq_ref, ref, fulltext, ref_or_null, unique_subquery, index_subquery, range, index_merge, index, ALL</strong></p>
<p>除了 all 之外，其他的 type 都可以使用到索引，除了 index_merge 之外，其的 type 只可以用到一个索引。优化器会选用最优索引。</p>
<blockquote>
<p><strong>至少要使用到 range 级别</strong></p>
</blockquote>
<ul>
<li>system 表中只有一行数据或者是空表。</li>
<li>const <strong>使用唯一索引或者主键，返回记录一定是1行记录的等值where条件时</strong>，通常type是const。其他数据库 也叫做唯一索引扫描</li>
<li>eq_ref **主键关联或者唯一性索引关联(&#x3D;号两边都要建立索引)**，此类型通常出现在多表的 join 查询, 表示对于前表的每一个结果, 都只能匹配到后表的一行结果. 并且查 询的比较操作通常是 ‘&#x3D;’, 查询效率较高。</li>
<li>ref 针对非唯一性索引，使用等值（&#x3D;）非主键查询。或者是使用了最左前缀规则索引的查询。</li>
<li>fulltext 全文索引检索，要注意，全文索引的优先级很高，若全文索引和普通索引同时存在时，mysql不管代 价，优先选择使用全文索引</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> taddr <span class="keyword">where</span> <span class="keyword">match</span>(addr) against(<span class="string">'bei'</span>);</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+----------+---------------+---------+---------+-------+------+----------+-------------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type     | possible_keys | key     | key_len | ref   | rows | filtered | Extra                         |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+----------+---------------+---------+---------+-------+------+----------+-------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | taddr | NULL       | fulltext | ft_addr       | ft_addr | 0       | const |    1 |   100.00 | Using where; Ft_hints: sorted |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+----------+---------------+---------+---------+-------+------+----------+-------------------------------+</span></span><br></pre></td></tr></table></figure>

<ul>
<li>fulltext 全文索引检索，要注意，全文索引的优先级很高，若全文索引和普通索引同时存在时，mysql不管代 价，优先选择使用全文索引</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> taddr <span class="keyword">where</span> <span class="keyword">match</span>(addr) against(<span class="string">'bei'</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>range 范围查询、前缀索引</li>
<li>index 索引覆盖，不回表。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> loginname <span class="keyword">from</span> tuser;</span><br><span class="line">type = index</span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> loginname, <span class="keyword">name</span> <span class="keyword">from</span> tuser;</span><br><span class="line">type = all</span><br><span class="line"></span><br><span class="line"><span class="comment">-- name 和 loginname 不在同一棵索引树上，说明需要回表查询。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ALL</li>
</ul>
<p>全表扫描数据文件，然后再 server 层进行过滤，返回符合要求的记录。如果有索引，则会在存储引擎层 storage engines 层中去过滤。</p>
<h3 id="小-tips"><a href="#小-tips" class="headerlink" title="小 tips"></a>小 tips</h3><blockquote>
<p>所以在查询时，一定不要写 selct * from tuser，肯定需要回表。<br>如果需求是 select * ，select * from tuser order by id;  全表扫描，+ order by id ， type &#x3D; index 了。</p>
</blockquote>
<p>索引不光是走查询用的，还可以减少回表，减少索引扫描。</p>
<h3 id="组合索引-1"><a href="#组合索引-1" class="headerlink" title="组合索引"></a>组合索引</h3><p>在创建组合索引时，会从创建组合索引的第一个字段开始找，如果检索时发现组合索引第一个字段都没有，则直接检索后面的字段查询时不会用到索引。type &#x3D; ALL</p>
<h3 id="possible-keys-amp-key-amp-key-len"><a href="#possible-keys-amp-key-amp-key-len" class="headerlink" title="possible_keys &amp; key &amp; key_len"></a>possible_keys &amp; key &amp; key_len</h3><ul>
<li>possible_keys: 此次查询可能选用的索引，一个或多个</li>
<li>key: 使用的索引</li>
<li>key_len: 看组合索引的使用情况，索引长度</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tuser <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="number">1</span> <span class="keyword">and</span> loginname=<span class="string">'zhy'</span> <span class="keyword">and</span> <span class="keyword">name</span> = <span class="string">'zhaoyun'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------------------------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys                          | key     | key_len | ref   | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------------------------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | tuser | NULL       | const | PRIMARY,idx_loginname,idx_name_age_sex | PRIMARY | 4       | const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------------------------------+---------+---------+-------+------+----------+-------+</span></span><br></pre></td></tr></table></figure>

<h3 id="extra"><a href="#extra" class="headerlink" title="extra"></a>extra</h3><p>额外信息</p>
<ul>
<li>NULL :效率最高</li>
</ul>
<h4 id="distinct-效率低"><a href="#distinct-效率低" class="headerlink" title="distinct(效率低)"></a>distinct(效率低)</h4><p>会生成一张原表的临时表，然后一个一个比对。如果一定要用的话，需要在条件查询完后使用</p>
<h4 id="using-filesort"><a href="#using-filesort" class="headerlink" title="using filesort"></a>using filesort</h4><p>排序时无法使用索引，常见于 order by，group by 语句。MySQL 中无法利用索引排序的操作称为 文件排序。</p>
<h4 id="using-index"><a href="#using-index" class="headerlink" title="using index"></a>using index</h4><p>查询时不需要回表查询，通过索引就可以获得查询的数据</p>
<ul>
<li>表示相应的 select 查询中使用到了 覆盖索引(Covering Index)，效率不错。</li>
<li>如果同时出现 using where，说明索引被用来执行查找索引键值。</li>
</ul>
<h4 id="using-where"><a href="#using-where" class="headerlink" title="using where"></a>using where</h4><p>表示索引引擎返回的记录并不是所有的都满足查询条件，需要在 server 层进行过滤。</p>
<ul>
<li>查询条件无索引</li>
<li>索引失效</li>
</ul>
<blockquote>
<p>查询条件中分为限制条件和检查条件，5.6之前，存储引擎只能根据限制条件扫描数据并返回，然后 server 层根据检查条件进行过滤再返回真正符合的数据。 5.6.x之后，支持ICP特性(查询条件下推到存储引擎层)，可以把检查条件也下推到存储引擎层，不符合检查条件和限制条件的数据，直接不读取，这样就减少了存储引擎扫描的记录数量。 extra 显示 using index condition</p>
</blockquote>
<h2 id="索引失效分析"><a href="#索引失效分析" class="headerlink" title="索引失效分析"></a>索引失效分析</h2><hr>
<ol>
<li>全值匹配：组合所有所有条件都有，效率最高</li>
<li>最左前缀法则：组合索引，带头索引不能没有，中间索引页不能断，如果中间索引中断，则只有带头的索引生效，其他索引失效。</li>
<li>不在索引上做计算</li>
<li>范围条件查询后面的条件 索引失效</li>
<li>减少 select *  尽量使用索引覆盖</li>
<li>索引字段上不要使用 不等 <code>!=</code> 或 <code>&lt;&gt;</code></li>
<li>主键索引字段上不能判断 null</li>
<li>索引字段使用 like 不以通配符开头，如果一定要用 like ‘%字符串%’，则 select (组合索引，索引覆盖) 提高查询性能</li>
<li>索引字段字符串不能省略单引号</li>
<li>索引字段不要使用 or</li>
</ol>
<h1 id="Mysql锁"><a href="#Mysql锁" class="headerlink" title="Mysql锁"></a>Mysql锁</h1><hr>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15927994083744-mysql1.jpg"></p>
<h2 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h2><hr>
<p>由 MySQL SQL layer 层实现</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'table%'</span>; </span><br><span class="line"><span class="comment">-- 查询表使用锁的状态</span></span><br></pre></td></tr></table></figure>

<ul>
<li>table_locks_im<a href="https://www.lizhaoloveit.cn/blogimages/java/database/mysqlte%EF%BC%9A%E4%BA%A7%E7%94%9F%E8%A1%A8%E7%BA%A7%E9%94%81%E5%AE%9A%E7%9A%84%E6%AC%A1%E6%95%B0%EF%BC%9B" target="_blank" rel="noopener">https://www.lizhaoloveit.cn/blogimages/java/database/mysqlte：产生表级锁定的次数；</a></li>
<li>table_locks_waited：出现表级锁定争用而发生等待的次数；</li>
</ul>
<h3 id="Table-Read-Lock-表共享读"><a href="#Table-Read-Lock-表共享读" class="headerlink" title="Table Read Lock 表共享读"></a>Table Read Lock 表共享读</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lock</span> <span class="keyword">table</span> 表名 <span class="keyword">read</span>, 表名<span class="number">2</span> <span class="keyword">read</span>, 其他;</span><br></pre></td></tr></table></figure>

<h3 id="Table-Write-Lock-表独占写"><a href="#Table-Write-Lock-表独占写" class="headerlink" title="Table Write Lock 表独占写"></a>Table Write Lock 表独占写</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lock</span> <span class="keyword">table</span> 表名 write, 表名<span class="number">2</span> write, 其他;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">open</span> <span class="keyword">tables</span>; 查看表锁情况</span><br><span class="line"><span class="keyword">unlock</span> <span class="keyword">tables</span>; 删除表锁</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">session1: <span class="keyword">lock</span> <span class="keyword">table</span> mylock <span class="keyword">read</span>; <span class="comment">-- 给mylock表加读锁 </span></span><br><span class="line">session1: <span class="keyword">select</span> * <span class="keyword">from</span> mylock; <span class="comment">-- 可以查询 </span></span><br><span class="line">session1：<span class="keyword">select</span> * <span class="keyword">from</span> tdep; <span class="comment">--不能访问非锁定表 </span></span><br><span class="line">session2：<span class="keyword">select</span> * <span class="keyword">from</span> mylock; <span class="comment">-- 可以查询 没有锁 </span></span><br><span class="line">session2：<span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'x'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">2</span>; <span class="comment">-- 修改阻塞,自动加行写锁 </span></span><br><span class="line">session1：<span class="keyword">unlock</span> <span class="keyword">tables</span>; <span class="comment">-- 释放表锁 </span></span><br><span class="line">session2：Rows matched: 1 Changed: 1 Warnings: 0 <span class="comment">-- 修改执行完成 </span></span><br><span class="line">session1：<span class="keyword">select</span> * <span class="keyword">from</span> tdep; <span class="comment">--可以访问</span></span><br></pre></td></tr></table></figure>

<h2 id="元数据锁"><a href="#元数据锁" class="headerlink" title="元数据锁"></a>元数据锁</h2><hr>
<p>MDL (metaDataLock) 元数据：表结构<br>在 MySQL 5.5 版本中引入了 MDL，当对一个表做增删改查操作的时候，加 MDL 读锁；当要对表做结 构变更操作的时候，加 MDL 写锁。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">session1: <span class="keyword">begin</span>;<span class="comment">--开启事务 </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mylock;<span class="comment">--加MDL读锁 </span></span><br><span class="line"></span><br><span class="line">session2: <span class="keyword">alter</span> <span class="keyword">table</span> mylock <span class="keyword">add</span> f <span class="built_in">int</span>; <span class="comment">-- 修改阻塞 </span></span><br><span class="line">session1：<span class="keyword">commit</span>; <span class="comment">--提交事务 或者 rollback 释放读锁 </span></span><br><span class="line">session2：Query OK, 0 rows affected (38.67 sec) <span class="comment">--修改完成 </span></span><br><span class="line"></span><br><span class="line">Records: 0 Duplicates: 0 Warnings: 0</span><br></pre></td></tr></table></figure>

<h2 id="行级锁"><a href="#行级锁" class="headerlink" title="行级锁"></a>行级锁</h2><hr>
<p>InnoDB 存储引擎实现，分三种</p>
<ul>
<li>记录锁(Record Locks): 锁定索引中一条记录</li>
<li>间隙锁(Gap Locks): 锁定记录前、记录中、记录后的行</li>
<li>Next-Key 锁：记录锁 + 间隙锁</li>
</ul>
<h3 id="共享读锁"><a href="#共享读锁" class="headerlink" title="共享读锁"></a>共享读锁</h3><p>允许一个事务读一行，阻止其他事务获得相同数据集的排他锁。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table_name <span class="keyword">where</span> ... <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span> <span class="comment">-- 共享读锁 手动添加</span></span><br></pre></td></tr></table></figure>

<h3 id="排他写锁"><a href="#排他写锁" class="headerlink" title="排他写锁"></a>排他写锁</h3><p>允许获得排他写锁的事务更新数据，组织其他事务获得相同数据集的共享读锁和排他写锁。</p>
<ol>
<li>DML会自动加 对于 UPDATE、DELETE、和INSERT语句，InnDB会自动给涉及数据加排他锁</li>
<li>手动加</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table_name <span class="keyword">where</span> ... <span class="keyword">FOR</span> <span class="keyword">UPDATE</span></span><br></pre></td></tr></table></figure>

<h2 id="行锁演示"><a href="#行锁演示" class="headerlink" title="行锁演示"></a>行锁演示</h2><hr>
<p><strong>InnoDB行锁</strong>是通过给索引上的<strong>索引项加锁来实现的</strong>，因此InnoDB这种行锁实现特点意味着：只有通过 索引条件检索的数据，InnoDB才使用行级锁，否则，InnoDB将使用表锁！</p>
<h3 id="行读锁"><a href="#行读锁" class="headerlink" title="行读锁"></a>行读锁</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看行锁状态</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">STATUS</span> <span class="keyword">like</span> <span class="string">'innodb_row_lock%'</span>;</span><br><span class="line"></span><br><span class="line">session1: <span class="keyword">begin</span>; <span class="comment">--开启事务未提交 </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mylock <span class="keyword">where</span> <span class="keyword">ID</span> = <span class="number">1</span> <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>; <span class="comment">-- 手动加id=1的行锁,使用索引 </span></span><br><span class="line"></span><br><span class="line">session2：<span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'y'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">2</span>; <span class="comment">-- 未锁定该行可以修改 </span></span><br><span class="line">session2：<span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'y'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>; <span class="comment">-- 锁定该行修改阻塞 </span></span><br><span class="line">	ERROR 1205 (HY000): <span class="keyword">Lock</span> <span class="keyword">wait</span> <span class="keyword">timeout</span> exceeded; try restarting transaction <span class="comment">-- 锁定超时 </span></span><br><span class="line"></span><br><span class="line">session1: <span class="keyword">commit</span>; <span class="comment">--提交事务 或者 rollback 释放读锁 </span></span><br><span class="line">session2：<span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'y'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>; <span class="comment">--修改成功 </span></span><br><span class="line"></span><br><span class="line">Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0</span><br><span class="line"></span><br><span class="line">where ID=1 <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>; <span class="comment">--手动加id=1的行读</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注：使用索引加行锁 ，未锁定的行可以访问</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">session1: <span class="keyword">begin</span>;<span class="comment">--开启事务未提交 --手动加name='c'的行读锁,未使用索引 </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mylock <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'c'</span> <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>; </span><br><span class="line"></span><br><span class="line">session2：<span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'y'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">2</span>; <span class="comment">-- 修改阻塞 未用索引行锁升级为表锁 </span></span><br><span class="line">session1: <span class="keyword">commit</span>; <span class="comment">--提交事务 或者 rollback 释放读锁 </span></span><br><span class="line">session2：<span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'y'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">2</span>; <span class="comment">--修改成功 </span></span><br><span class="line"></span><br><span class="line">Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注：未使用索引行锁升级为表锁</span></span><br></pre></td></tr></table></figure>

<h3 id="行写锁"><a href="#行写锁" class="headerlink" title="行写锁"></a>行写锁</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">session1: <span class="keyword">begin</span>;<span class="comment">--开启事务未提交</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--手动加id=1的行写锁, </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mylock <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"></span><br><span class="line">session2：<span class="keyword">select</span> * <span class="keyword">from</span> mylock <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">2</span> ; <span class="comment">-- 可以访问 </span></span><br><span class="line">session2: <span class="keyword">select</span> * <span class="keyword">from</span> mylock <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span> ; <span class="comment">-- 可以读 不加锁 </span></span><br><span class="line">session2: <span class="keyword">select</span> * <span class="keyword">from</span> mylock <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span> <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span> ; <span class="comment">-- 加读锁 被阻塞 </span></span><br><span class="line">session1：<span class="keyword">commit</span>; <span class="comment">-- 提交事务 或者 rollback 释放写锁 </span></span><br><span class="line">session2：执行成功</span><br><span class="line"></span><br><span class="line">主键索引产生记录锁</span><br></pre></td></tr></table></figure>

<h3 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h3><blockquote>
<p>非主键索引产生间隙锁，主键范围产生间隙锁。</p>
</blockquote>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><hr>
<ul>
<li>Atomicity(原子性):构成事务的所有操作必须是一个逻辑单元，要么全部执行，要么全部不执行</li>
<li>Consistency(一致性):数据库在事务执行前后状态必须是稳定的或一致的</li>
<li>Isolation(隔离性):事务之间不会相互影响 由锁机制和 MVCC(多版本并发控制) 机制来实现:(读不加锁、读写不冲突) </li>
<li>Durability(持久性):事务执行成功后必须全部写入磁盘。</li>
</ul>
<p>BEGIN 或 START TRANSACTION；显式地开启一个事务；</p>
<p>COMMIT 也可以使用 COMMIT WORK ，不过二者是等价的。COMMIT会提交事务，并使已对数据库进行的 所有修改称为永久性的；<br>ROLLBACK 有可以使用 ROLLBACK WORK&#96;，不过二者是等价的。回滚会结束用户的事务，并撤销正在 进行的所有未提交的修改；</p>
<h2 id="InnoDB-架构图"><a href="#InnoDB-架构图" class="headerlink" title="InnoDB 架构图"></a>InnoDB 架构图</h2><hr>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15928031514354-mysql1.jpg"></p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15928031763578-mysql1.jpg"><br>InnoDB 存储引擎由内存池，后台线程池和磁盘文件三部分组成。</p>
<blockquote>
<p>为什么会有缓存(insert buffer) 存在?</p>
</blockquote>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15928035701075-mysql1.jpg"></p>
<p>InnoDB 会直将内存中的数据写入磁盘，就是执行 I&#x2F;O 操作，此操作比较耗时，在执行sql时，MySQL程序在线程A中将内存中进行数据修改，把在内存中修改后的数据页生成一个缓存页。然后用另一个线程B做 I&#x2F;O 操作。这是一个非常典型的生产者消费者模型。一条线程读，一条线程写。</p>
<p>Page 是 InnoDB 存储的最基本结构，也是 InnoDB 磁盘管理的最小单位。</p>
<h3 id="插入缓冲-Insert-Buffer"><a href="#插入缓冲-Insert-Buffer" class="headerlink" title="插入缓冲(Insert Buffer)"></a>插入缓冲(Insert Buffer)</h3><p>复杂：主键排序、索引、树、插入算法。所以需要单独使用线程</p>
<h3 id="自适应哈希-Adaptive-Hash-Index"><a href="#自适应哈希-Adaptive-Hash-Index" class="headerlink" title="自适应哈希(Adaptive Hash Index)"></a>自适应哈希(Adaptive Hash Index)</h3><p>hash 结构， key value。</p>
<p>InnoDB 会根据访问的频率和模式，为热点页建立哈希索引，来提高查询效率</p>
<h3 id="lock-info-锁信息"><a href="#lock-info-锁信息" class="headerlink" title="lock info 锁信息"></a>lock info 锁信息</h3><p>行锁、表锁</p>
<h3 id="Data-Dictionary-数据字典信息"><a href="#Data-Dictionary-数据字典信息" class="headerlink" title="Data Dictionary 数据字典信息"></a>Data Dictionary 数据字典信息</h3><p>元数据信息，表结构、数据库名或表名。字段的数据类型、视图、索引、表字段信息、存储过程、触发器等内容。</p>
<h3 id="Redo-log-Buffer-重做日志缓冲"><a href="#Redo-log-Buffer-重做日志缓冲" class="headerlink" title="Redo log Buffer 重做日志缓冲"></a>Redo log Buffer 重做日志缓冲</h3><p>Redo log: <code>ib_logfile0 ib_logfile1</code> 默认为8M innodb_log_buffer_size 控制大小</p>
<p>Redo log 重做日志：<br>数据以所及I&#x2F;O的形式存储，性能较低。利用日志存储，日志是顺序I&#x2F;O，性能就高了，所以要存储数据，则先存储数据的日志，一旦内存崩了，可以从日志找数据。</p>
<p>数据一旦被存入 Redo log 中就认为存储成功了。保证了数据的可靠性。<strong>预写机制</strong></p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15928065493786-mysql1.jpg"></p>
<p>Buffer Pool 先将数据存入 Redo log 中，存入后就认为成功了，然后再择时将数据存入文件系统。</p>
<h4 id="重做日志落盘机制"><a href="#重做日志落盘机制" class="headerlink" title="重做日志落盘机制"></a>重做日志落盘机制</h4><p>Force Log at Commit 实现事务的持久性，即当事务提交时，必须先将事务的所有日志写入到重做日志文件进行持久化，然后事务的提交操作才算完成。为了确保每次日志都写入到重做日志文件，每次重做日志后，必须调用操作系统的 <strong>fsync</strong> 方法，将缓冲文件写入磁盘。</p>
<p>可以通过参数 <code>innodb_flush_log_at_trx_commit</code> 参数来配置</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15928074410692-mysql1.jpg"></p>
<p>该参数默认值为1，表示事务提交必须进行一次 <code>fsync</code> 操作，1最安全。 0和2，虽然性能较高但是丧失事务的一致性。</p>
<h3 id="检查点-checkPoint"><a href="#检查点-checkPoint" class="headerlink" title="检查点 checkPoint"></a>检查点 checkPoint</h3><p>表示脏页写入到磁盘的时机，检查点也意味着脏页的写入。</p>
<h4 id="sharp-checkpoint"><a href="#sharp-checkpoint" class="headerlink" title="sharp checkpoint"></a>sharp checkpoint</h4><p>完全检查点：当数据库正常关闭时，会触发。把所有脏页都写入到磁盘上。</p>
<h4 id="fuzzy-checkpoint"><a href="#fuzzy-checkpoint" class="headerlink" title="fuzzy checkpoint"></a>fuzzy checkpoint</h4><p>正常使用时，模糊检查点，部分页写入磁盘。</p>
<p>master thread checkpoint:定时刷新，以每秒或者每十秒的速度从缓冲池的脏页列表中刷新一定比例的页回磁盘。这个过程是异步的</p>
<p>flush_Iru_list checkpoint: 读取 Iru(Least Recently Used) list，找到脏页，写入磁盘。最近最少使用的数据写入磁盘。</p>
<p>async&#x2F;sync flush checkpoint: Redo log Buffer 快满时(16M的两个文件)，会批量的触发数据页回写，这个事件触发的时候又分为异步和同步，不可覆盖的 redolog 占 log file的比值 75% -&gt; 异步  90% -&gt; 同步。</p>
<p>dirty page too much checkpoint: 默认是脏页占比 75%的时候就会触发落盘。</p>
<h3 id="Double-Write-双写"><a href="#Double-Write-双写" class="headerlink" title="Double Write 双写"></a>Double Write 双写</h3><p>该机制带来了数据的可靠性。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15928076756383-mysql1.jpg"></p>
<p>Double Write 由两部分组成，一部分是内存中的 double write buffer，大小为2MB，另一部分是物理磁盘上共享表空间连续的128个页，大小也为2MB。</p>
<p>对缓冲池的脏页刷新时，不直接写磁盘，而是通过 memcpy 函数将脏页先复制到内存中的 double write buffer 区域，之后通过 double write buffer 在分两次，每次 1M 顺序写入共享表空间的物理磁盘，然后马上调用 fsync 同步磁盘，避免操作系统缓冲写带来的问题。</p>
<p>完成 double write 页的写入后，再将 double write buffer 中的页写入各个表空间文件中。如果操作系统在将页写入磁盘的过程发生了崩溃，恢复过程中， InnoDB 存储引擎可以从共享表空间中的 double write 中找到该页的副本，复制到表空间文件中，再应用 redolog</p>
<h3 id="UndoLog"><a href="#UndoLog" class="headerlink" title="UndoLog"></a>UndoLog</h3><p>数据库崩溃重启后需要从 redo log 中把未落盘的脏页数据恢复出来，重新写入磁盘，保证用户的数据不丢失。在崩溃恢复中还需要回滚没有提交的事务。回滚操作需要 undo log 的支持，undo log 的完整性和可靠性需要 redo log 保证。崩溃恢复先做 redo 恢复数据，然后做 undo 回滚。</p>
<p>在事务进行的过程中，undo log 记录了每个操作前的状态。下图说明数据和回滚日志的逻辑存储结构</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15933877238952-mysql1.jpg"></p>
<p>undo log 存放在数据库内部的特殊的段，称为回滚段，在共享表空间中。redo log 是物理日志，记录数据库页的物理修改操作，所以 undo log 的写入也会产生 redo log，也就是 undo log 也需要持久性的保护。数据库事务的整个流程如下：</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15933878998633-mysql1.jpg"></p>
<p>事务进行过程中，每次sql语句执行，都会记录 undo log 和 redo log，然后更新数据形成脏页，然后 redo log 落盘，undo log 和脏页按照 checkpoint 进行落盘，落盘后相应的 redo log 就可以删除了。事务还未 COMMIT，如果发生崩溃，则首先检查 checkpoint 记录，使用相应的 redo log 进行数据和 undo log 的恢复，然后查看 undo log 的状态发现事务尚未提交，然后就使用 undo log 进行事务回滚。事务执行 COMMIT 操作时，会将本事务相关的所有 redo log 都进行落盘，只有所有 redo log 落盘成功，才算 COMMIT 成功。然后内存中的数据脏页继续按照 checkpoint 进行落盘。如果此时发生了崩溃，则只使用redo log恢复数据。</p>
<h2 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h2><hr>
<blockquote>
<p>原子性，持久性和一致性主要是通过redo log、undo log 和 Force Log at Commit 机制机制来完成 的。redo log用于在崩溃时恢复数据，undo log 用于对事务的影响进行撤销，也可以用于多版本控制。而 Force Log at Commit 机制保证事务提交后 redo log 日志都已经持久化。</p>
</blockquote>
<p>事务的隔离性由多版本控制机制和锁实现。</p>
<p>四大隔离级别</p>
<p>事务隔离级别</p>
<ol>
<li>Read uncommited 任何情况无法保证</li>
<li>Read committed RC 读已提交，可避免脏读</li>
<li>Repeatable read RR 可避免脏读、不可重复读的发生<ul>
<li>InnoDB 的 RR 还可以解决幻读，主要原因是  Next-Key 锁，只有 RR 才能使用 Next-Key锁</li>
</ul>
</li>
<li>Serializable 串行化：可避免脏读、不可重复读、幻读的发生。 MVCC 降级为 Locking-Base CC</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--创建账户表并初始化数据 </span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tacount(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> , </span><br><span class="line">aname <span class="built_in">varchar</span>(<span class="number">100</span>),</span><br><span class="line">acount <span class="built_in">int</span> , </span><br><span class="line">primary <span class="keyword">key</span>(<span class="keyword">id</span>)); </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tacount <span class="keyword">add</span> <span class="keyword">index</span> idx_name(aname); </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tacount <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'a'</span>,<span class="number">1000</span>); </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tacount <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'b'</span>,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--设置隔离级读未提交（read-uncommitted） </span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">session</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">read</span> uncommitted;</span><br><span class="line"></span><br><span class="line"><span class="comment">--session 1 </span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ; </span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'a'</span>; </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| id | aname | acount | </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| 1 | a | 1000 | </span><br><span class="line">+<span class="comment">----+-------+--------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--session 2 </span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>; </span><br><span class="line"><span class="keyword">update</span> tacount <span class="keyword">set</span> acount=<span class="number">1100</span> <span class="keyword">where</span> aname=<span class="string">'b'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--session 1 </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'b'</span>; </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| id | aname | acount | </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| 2 | b | 1100 | </span><br><span class="line">+<span class="comment">----+-------+--------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--设置隔离级别为串行化（serializable） 死锁演示 </span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">session</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">serializable</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--session 1 </span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'a'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--session 2 </span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">update</span> tacount <span class="keyword">set</span> acount=<span class="number">900</span> <span class="keyword">where</span> aname=<span class="string">'b'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1 </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'b'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 2 </span></span><br><span class="line"><span class="keyword">update</span> tacount <span class="keyword">set</span> acount=<span class="number">1100</span> <span class="keyword">where</span> aname=<span class="string">'a'</span>; </span><br><span class="line">ERROR 1213 (40001): Deadlock found when trying to get <span class="keyword">lock</span>; try restarting transaction</span><br></pre></td></tr></table></figure>
<h3 id="MVCC-机制"><a href="#MVCC-机制" class="headerlink" title="MVCC 机制"></a>MVCC 机制</h3><p>使用 MVCC 机制 RR 隔离级别下的演示：</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15933906228570-mysql1.jpg"></p>
<p>MVCC使得数据库读不会对数据加锁，普通的SELECT请求不会加锁，提高了数据库的并发处理能力。借助MVCC，数据库可以实现READ COMMITTED，REPEATABLE READ等隔离级别，用户可以查看当前数 据的前一个或者前几个历史版本，保证了ACID中的I特性（隔离性)。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 显示当前隔离级别为 REPEATABLE-READ </span></span><br><span class="line"><span class="keyword">select</span> @@tx_isolation;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- MySQL默认隔离级别</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1</span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ; </span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'a'</span>; </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| id | aname | acount | </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| 1 | a | 1000 | </span><br><span class="line">+<span class="comment">----+-------+--------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 2 </span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>; <span class="keyword">update</span> tacount <span class="keyword">set</span> acount=<span class="number">1100</span> <span class="keyword">where</span> aname=<span class="string">'a'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1 </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'a'</span>; </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| id | aname | acount | </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| 1 | a | 1000 | </span><br><span class="line">+<span class="comment">----+-------+--------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 2 提交事务 </span></span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1 显示在session 1 事务开始时的数据 </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'a'</span>; </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| id | aname | acount | </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| 1 | a | 1000 | </span><br><span class="line">+<span class="comment">----+-------+--------+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 设置事务隔离级别为REPEATABLE-COMMITTED</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 读已提交</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1 </span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">session</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">read</span> committed; </span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ; </span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'a'</span>; </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| id | aname | acount | </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| 1 | a | 1000 | </span><br><span class="line">+<span class="comment">----+-------+--------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 2 </span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">session</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">read</span> committed; </span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>; </span><br><span class="line"><span class="keyword">update</span> tacount <span class="keyword">set</span> acount=<span class="number">1100</span> <span class="keyword">where</span> aname=<span class="string">'a'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1 </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'a'</span>; </span><br><span class="line"></span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| id | aname | acount | </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| 1 | a | 1000 | </span><br><span class="line">+<span class="comment">----+-------+--------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 2 提交事务 </span></span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1 显示最新事务提交后的数据 </span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tacount <span class="keyword">where</span> aname=<span class="string">'a'</span>; </span><br><span class="line"></span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| id | aname | acount | </span><br><span class="line">+<span class="comment">----+-------+--------+ </span></span><br><span class="line">| 1 | a | 1100 | </span><br><span class="line">+<span class="comment">----+-------+--------+</span></span><br></pre></td></tr></table></figure>

<h3 id="MVCC-的实现"><a href="#MVCC-的实现" class="headerlink" title="MVCC 的实现"></a>MVCC 的实现</h3><p>在 MVCC 并发控制中，读操作可以分成两类：快照读与当前读<br>Multiversion concurrency control</p>
<p>快照读：简单的 select 操作，属于快照读，不加读锁，读历史版本<br>当前读：特殊的操作，插入、更新、删除操作，属于当前读，需要加锁，加行写锁，读当前版本</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15936895526019-mysql1.jpg"></p>
<h3 id="一致性非锁定读-consistent-nonlocking-read"><a href="#一致性非锁定读-consistent-nonlocking-read" class="headerlink" title="一致性非锁定读(consistent nonlocking read)"></a>一致性非锁定读(consistent nonlocking read)</h3><p>是指 InnoDB 存储引擎通过多版本控制 MVCC 读取当前数据库中行数据的方式<br>如果读取的行正在执行 DELETE 或 UPDATE 操作，这时读取操作不会因此去等待行上锁的释放。相反的 InnoDB 会去读取行的一个最新可见的快照。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15936898097694-mysql1.jpg"></p>
<p>如上图所示，当回话B提交事务后，回话A再次运行 select * from test where id &#x3D; 1，在不同的事务隔离级别下结构就不一样了。</p>
<p>MVCC 在 mysql 中的实现依赖 undo log 与 read view</p>
<h3 id="Undo-Log"><a href="#Undo-Log" class="headerlink" title="Undo Log"></a>Undo Log</h3><p>InnoDB 行记录有三个隐藏字段，分别是 rowid、事务号db_trx_id和回滚指针 db_roll_ptr，其中 db_trx_id 表示最近修改的事务的 id，db_roll_ptr 指向回滚段中的 undo log</p>
<p>根据行为，undo log 分为 insert undo log  和 update undo log</p>
<p>insert undo log，rollback 直接删除，不需要进行 purge 操作。</p>
<p>delete&#x2F;update undo log 不能再事务提交的时候进行删除&#x2F;更改，而是将事务提交时放入 history list 上，等待purge线程进行最后的操作。</p>
<p>purge线程会在没有其他人读该条数据时进行执行。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15936901212423-mysql1.jpg"></p>
<p>初始状态</p>
<p>当事务2使用 update 修改该行数据时，首先使用排他锁 锁定该行，将当前行的值复制到 undo log 中，再真正的修改当前行的值，最后填写事务 id，使用回滚指针指向 undo log 中修改前的行</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15936912627380-mysql1.jpg"></p>
<h3 id="事务链表"><a href="#事务链表" class="headerlink" title="事务链表"></a>事务链表</h3><p>MySQL 中的事务在开始到提交这段过程中，都会保存到 trx_sys 的事务链表中，</p>
<p>ct-trx -&gt; trx11 -&gt; trx9 -&gt; trx9 -&gt; trx5 -&gt; trx3 这是一个基本链表</p>
<p>事务链表存储的是未提交的事务，事务一旦提交，则会从事务链表中摘除。</p>
<p>RR 隔离级别下，每个<strong>事务</strong>开始的时候，会将当前系统的所有活跃事务拷贝到一个列表中 read view<br>RC 隔离级别下，每个<strong>语句</strong>开始的时候，会将当前系统中的所有活跃事务(最新版本)拷贝到一个列表中 read view</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">engine</span> <span class="keyword">innodb</span> <span class="keyword">status</span> <span class="comment">-- 事务列表</span></span><br></pre></td></tr></table></figure>

<h3 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h3><p>当前事务(读)能读哪个历史版本?</p>
<p>Read View 是事务开启时 当前所有事务的集合，存储了当前 Read View 中最大事务 ID 及 最小事务 ID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ct-trx --&gt; trx11 --&gt; trx9 --&gt; trx6 --&gt; trx5 --&gt; trx3;</span><br></pre></td></tr></table></figure>
<p>ct-trx 表示当前事务的id，对应上面的read_view数据结构如下。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">read_view-&gt;creator_trx_id = ct-trx; </span><br><span class="line">read_view-&gt;up_limit_id = trx3; 低水位 </span><br><span class="line">read_view-&gt;low_limit_id = trx11; 高水位 </span><br><span class="line">read_view-&gt;trx_ids = [trx11, trx9, trx6, trx5, trx3];</span><br></pre></td></tr></table></figure>
<p>low_limit_id 当前活跃的事务的最大id，此id之前的的数据都没有提交。这些数据在 RR 下都不可见</p>
<p>up_limit_id 当前活跃事务的最小id，如果 row 的 db_trx_id &lt; up_limit_id，事务已提交，数据可见。</p>
<p>ReadView 不同隔离级别的实现方式：</p>
<ul>
<li>read-commited</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (trx-&gt;isolation_level &lt;= TRX_ISO_READ_COMMITTED &amp;&amp; trx-&gt;global_read_view)</span><br><span class="line">&#123;</span><br><span class="line">	read_view_close_for_mysql(trx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次语句执行过程中，都关闭 read_view，重新再函数中创建当前的一份 read_view，这样就会将所有当前的事务获取到，可以获取到最新的提交。</p>
<ul>
<li>repeatable read:</li>
</ul>
<p>在 RR 级别下，创建事务 trx 结构时，会生成当前的 global read view，一直维持到事务结束，每一次查询都不会重新创建 read view，因此导致在事务中无法读到最新的提交。</p>
<h1 id="Mysql-性能分析和优化"><a href="#Mysql-性能分析和优化" class="headerlink" title="Mysql 性能分析和优化"></a>Mysql 性能分析和优化</h1><hr>
<h2 id="SQL-锁分析"><a href="#SQL-锁分析" class="headerlink" title="SQL 锁分析"></a>SQL 锁分析</h2><hr>
<h3 id="RC"><a href="#RC" class="headerlink" title="RC"></a>RC</h3><ul>
<li>id 主键，只需要将主键 id 的记录加上 X 锁</li>
<li>id 唯一索引，先在索引中找到符合记录，取出主键，然后去主键索引中查找记录，找到加 X 锁</li>
<li>id 非唯一索引，找到匹配的记录，在记录上加 X 锁</li>
<li>id 无索引，全表扫描做过滤，直接加表锁。</li>
</ul>
<h3 id="RR"><a href="#RR" class="headerlink" title="RR"></a>RR</h3><ul>
<li>id 主键，同 RC</li>
<li>id 唯一索引，同 RC</li>
<li>id 非唯一索引，在索引中加入间隙锁(GAP)，同时在表中字段加入 X 锁，可以排除幻读的发生</li>
</ul>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/database/mysql/15939947736025-mysql1.jpg"></p>
<ul>
<li>id 无索引 + RR，X锁 + 间隙锁</li>
</ul>
<p>复杂 SQL 分析</p>
<blockquote>
<p>RR 下，针对一个复杂的 SQL，首先需要提取 where 条件<br>Index Key 确定的范围，需要加上 GAP 锁<br>Index Filter 过滤条件，视  MySQL 版本是否支持 ICP，支持则不满足 Index Filter 的记录不加 X锁，不支持则加</p>
<ul>
<li>Table Filter 过滤条件，无论是否满足，都需要加 X 锁。</li>
</ul>
</blockquote>
<h2 id="利用慢查询日志查询耗时比较长的-sql"><a href="#利用慢查询日志查询耗时比较长的-sql" class="headerlink" title="利用慢查询日志查询耗时比较长的 sql"></a>利用慢查询日志查询耗时比较长的 sql</h2><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;var&#x2F;lib&#x2F;mysql</span><br><span class="line"># slow-log.log 就是慢查询日志，需要开启慢查询日志</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line"></span><br><span class="line"># 找到 slow_query_log&#x3D;ON</span><br><span class="line">slow_query_log&#x3D;ON</span><br><span class="line">long_query_time&#x3D;3 # 超过3秒算慢查询</span><br><span class="line">slow_query_log_file&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;slow-log.log</span><br></pre></td></tr></table></figure>

<h3 id="mysqldumpslow"><a href="#mysqldumpslow" class="headerlink" title="mysqldumpslow"></a>mysqldumpslow</h3><p>按照时间排序前10条里面含有左连接的查询语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s t -t 10 -g &quot;left join&quot; &#x2F;var&#x2F;log&#x2F;mysql&#x2F;slow.log</span><br></pre></td></tr></table></figure>

<p>常用参数说明</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-s:</td>
<td>表示按何种方式排序</td>
</tr>
<tr>
<td>c</td>
<td>访问计数</td>
</tr>
<tr>
<td>l</td>
<td>锁定时间</td>
</tr>
<tr>
<td>r</td>
<td>返回记录</td>
</tr>
<tr>
<td>t</td>
<td>查询时间</td>
</tr>
<tr>
<td>al</td>
<td>平均锁定时间</td>
</tr>
<tr>
<td>ar</td>
<td>平均返回记录数</td>
</tr>
<tr>
<td>at</td>
<td>平均查询时间</td>
</tr>
<tr>
<td>-t</td>
<td>是 top n 的意思，即为返回前面多少条数据</td>
</tr>
<tr>
<td>-g</td>
<td>后面可以写一个正则匹配模式，大小写不敏感</td>
</tr>
</tbody></table>
<h3 id="percana-toolkit"><a href="#percana-toolkit" class="headerlink" title="percana-toolkit"></a>percana-toolkit</h3><p><a href="https://www.percona.com/downloads/percona-toolkit/3.0.11/binary/tarball/percona-toolkit-3.0.11_x86_64.tar.gz" target="_blank" rel="noopener">percona-toolkit 工具</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;www.percona.com&#x2F;downloads&#x2F;percona-toolkit&#x2F;3.0.11&#x2F;binary&#x2F;tarball&#x2F;percona-toolkit-3.0.11_x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">tar -xf percona-toolkit-3.0.11_x86_64.tar.gz cd percona-toolkit-3.0.11</span><br><span class="line">perl Makefile.PL</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="服务器层面优化"><a href="#服务器层面优化" class="headerlink" title="服务器层面优化"></a>服务器层面优化</h2><hr>
<h3 id="减少-IO-次数，扩大-buffer-pool"><a href="#减少-IO-次数，扩大-buffer-pool" class="headerlink" title="减少 IO 次数，扩大 buffer pool"></a>减少 IO 次数，扩大 buffer pool</h3><p>buffer pool 默认是 128M，扩大 buffer pool 理论上可以为 内存 的 3&#x2F;4 或者 4&#x2F;5，将数据保存在内存中，从内存读取数据。如何确定 innodb_buffer_pool_size 足够大？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'innodb_buffer_pool_pages_%'</span>;</span><br><span class="line">+<span class="comment">----------------------------------+-------+</span></span><br><span class="line">| Variable_name                    | Value |</span><br><span class="line">| Innodb_buffer_pool_pages_data    | 8190  |</span><br><span class="line">| Innodb_buffer_pool_pages_dirty   | 0     |</span><br><span class="line">| Innodb_buffer_pool_pages_flushed | 12646 |</span><br><span class="line">| Innodb_buffer_pool_pages_free    | 0     |   <span class="comment">-- 0表示已经被用光了</span></span><br><span class="line">| Innodb_buffer_pool_pages_misc    | 1     |</span><br><span class="line">| Innodb_buffer_pool_pages_total   | 8191  |</span><br><span class="line">+<span class="comment">----------------------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p>修改 my.cnf<br>innodb_bufer_pool_size &#x3D; 750M</p>
<h3 id="降低磁盘写入次数"><a href="#降低磁盘写入次数" class="headerlink" title="降低磁盘写入次数"></a>降低磁盘写入次数</h3><ul>
<li>redo log 大则落盘次数少，innodb_log_file_size 设置成 innodb_buffer_pool_size * 0.25</li>
<li>通用查询日志、慢查询日志可以不开 bin-log 开(防止删库)</li>
<li>写 redo log 策略(一般不用)</li>
</ul>
<h3 id="提高磁盘读写速度-SSD"><a href="#提高磁盘读写速度-SSD" class="headerlink" title="提高磁盘读写速度 SSD"></a>提高磁盘读写速度 SSD</h3><h2 id="SQL-设计优化"><a href="#SQL-设计优化" class="headerlink" title="SQL 设计优化"></a>SQL 设计优化</h2><hr>
<p>根据业务需求。</p>
<ol>
<li>针对统计分析功能，报表等实时性不高的业务，设计中间表，或者设计定时器，将每日需要统计的数据插入中间表中，再做汇总。</li>
<li>为减少关联查询，创建合理的冗余字段，考虑数据库的三范式和查询性能的取舍，创建冗余字段需要注意数据一致性问题</li>
<li>如果字段太多的大表，考虑拆表</li>
<li>表中经常不使用的字段或者存储数据比较多的字段，考虑拆表，比如商品表中会存储商品介绍，此时可以将商品字少字段单独拆解到另一个表中，使用商品 di 关联</li>
<li>每张表都要有一个主键，主键类型最好是 int，建议自增主键(不考虑分布式)</li>
</ol>
<h2 id="SQL-语句优化"><a href="#SQL-语句优化" class="headerlink" title="SQL 语句优化"></a>SQL 语句优化</h2><hr>
<ol>
<li>where，组合索引，索引下推(非选择行，不加锁)，索引覆盖不会表</li>
<li>对排序 分组 on 两边字段加索引</li>
<li>不要使用 *</li>
<li>Limit 截断表，可用于停止全表扫描，适当使用可以提升速度</li>
<li>不使用 MySQL 内置的函数，因为内置函数不会建立查询缓存</li>
</ol>
<h1 id="大厂面试题"><a href="#大厂面试题" class="headerlink" title="大厂面试题"></a>大厂面试题</h1><hr>
<h2 id="存储引擎-InnoDB-与-MyISAM-的区别，优缺点，使用场景"><a href="#存储引擎-InnoDB-与-MyISAM-的区别，优缺点，使用场景" class="headerlink" title="存储引擎 InnoDB 与 MyISAM 的区别，优缺点，使用场景"></a>存储引擎 InnoDB 与 MyISAM 的区别，优缺点，使用场景</h2><h2 id="说说-MySQL-优化之道"><a href="#说说-MySQL-优化之道" class="headerlink" title="说说 MySQL 优化之道"></a>说说 MySQL 优化之道</h2><h2 id="UndoLog-和-RedoLog-的区别和联系"><a href="#UndoLog-和-RedoLog-的区别和联系" class="headerlink" title="UndoLog 和 RedoLog 的区别和联系"></a>UndoLog 和 RedoLog 的区别和联系</h2><h2 id="MySQL-索引的数据结构是什么？为什么使用这种数据结构"><a href="#MySQL-索引的数据结构是什么？为什么使用这种数据结构" class="headerlink" title="MySQL 索引的数据结构是什么？为什么使用这种数据结构"></a>MySQL 索引的数据结构是什么？为什么使用这种数据结构</h2><h2 id="索引失效的场景有哪些"><a href="#索引失效的场景有哪些" class="headerlink" title="索引失效的场景有哪些"></a>索引失效的场景有哪些</h2><h2 id="什么是死锁和死锁的排查和解决"><a href="#什么是死锁和死锁的排查和解决" class="headerlink" title="什么是死锁和死锁的排查和解决"></a>什么是死锁和死锁的排查和解决</h2><h2 id="RC和RR的实现原理及区别和使用场景"><a href="#RC和RR的实现原理及区别和使用场景" class="headerlink" title="RC和RR的实现原理及区别和使用场景"></a>RC和RR的实现原理及区别和使用场景</h2><h2 id="分库与分表带来的分布式困境与应对之策"><a href="#分库与分表带来的分布式困境与应对之策" class="headerlink" title="分库与分表带来的分布式困境与应对之策"></a>分库与分表带来的分布式困境与应对之策</h2></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ammar</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lizhaoloveit.cn/2020/06/20/MySQL%E8%BF%9B%E9%98%B6/">http://lizhaoloveit.cn/2020/06/20/MySQL%E8%BF%9B%E9%98%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lizhaoloveit.cn">Ammar's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库    </a></div><div class="post_share"><div class="social-share" data-image="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/07/09/Redis%E8%BF%9B%E9%98%B6/"><img class="prev_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Redis进阶</span></div></a></div><div class="next-post pull-right"><a href="/2020/06/12/SpringMVC%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><img class="next_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>SpringMVC源码分析</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'http://lizhaoloveit.cn/2020/06/20/MySQL%E8%BF%9B%E9%98%B6/';
  this.page.identifier = '2020/06/20/MySQL进阶/';
  this.page.title = 'MySQL进阶';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'lizhao' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2024 By Ammar</div><div class="icp"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener"><span>浙ICP备19013619号-1</span></a></div><div class="bag"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010502006128" target="_blank" rel="noopener"><img src="/img/beian.png"><span>浙公网安备 33010502006128号</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="far fa-moon nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script async src="/js/search/algolia.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>