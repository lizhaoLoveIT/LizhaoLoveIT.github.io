<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>SpringAOP | Ammar's Blog</title><meta name="description" content="SpringAOP"><meta name="keywords" content="Spring"><meta name="author" content="Ammar"><meta name="copyright" content="Ammar"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://lizhaoloveit.cn/2019/07/31/SpringAOP/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="SpringAOP"><meta name="twitter:description" content="SpringAOP"><meta name="twitter:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta property="og:type" content="article"><meta property="og:title" content="SpringAOP"><meta property="og:url" content="http://lizhaoloveit.cn/2019/07/31/SpringAOP/"><meta property="og:site_name" content="Ammar's Blog"><meta property="og:description" content="SpringAOP"><meta property="og:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="MapperFactoryBean" href="http://lizhaoloveit.cn/2019/08/01/MapperFactoryBean/"><link rel="next" title="Spring入门IoC、DI" href="http://lizhaoloveit.cn/2019/07/25/Spring%E5%85%A5%E9%97%A8IoC%E3%80%81DI/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?162506e75ffd64287398566b2f5738c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"VRMKRAV9AT","apiKey":"bd7157400046d0f02396708a501a3480","indexName":"lizhaoloveit","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://lizhaoloveit.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Advice"><span class="toc-number">1.</span> <span class="toc-text">Advice</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#责任分离和代理思想"><span class="toc-number">2.</span> <span class="toc-text">责任分离和代理思想</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#静态代理"><span class="toc-number">3.</span> <span class="toc-text">静态代理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JDK-动态代理-有接口"><span class="toc-number">4.</span> <span class="toc-text">JDK 动态代理(有接口)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JDK-动态代理操作步骤"><span class="toc-number">4.1.</span> <span class="toc-text">JDK 动态代理操作步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JDK-动态代理原理"><span class="toc-number">4.2.</span> <span class="toc-text">JDK 动态代理原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CGlib-动态代理"><span class="toc-number">5.</span> <span class="toc-text">CGlib 动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-CGlib"><span class="toc-number">5.1.</span> <span class="toc-text">使用 CGlib</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CGlib-原理"><span class="toc-number">5.2.</span> <span class="toc-text">CGlib 原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AOP"><span class="toc-number">6.</span> <span class="toc-text">AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AOP-思想"><span class="toc-number">6.1.</span> <span class="toc-text">AOP 思想</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#核心概念"><span class="toc-number">6.2.</span> <span class="toc-text">核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pointcut-语法"><span class="toc-number">6.3.</span> <span class="toc-text">Pointcut 语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#常见写法"><span class="toc-number">6.3.1.</span> <span class="toc-text">常见写法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开发中的配置"><span class="toc-number">6.4.</span> <span class="toc-text">开发中的配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#各种增强时机"><span class="toc-number">6.5.</span> <span class="toc-text">各种增强时机</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#案例"><span class="toc-number">7.</span> <span class="toc-text">案例</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://lizhaoloveit.cn/blogimages/blog/top_img.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Ammar's Blog</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description">微信号：aicjaish</div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a><a class="site-page" href="/comment/"><i class="fa-fw fa fa-coffee"></i><span> 留言</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">SpringAOP</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-07-31<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-08-09</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/">Java</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/%E6%A1%86%E6%9E%B6/">框架</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/%E6%A1%86%E6%9E%B6/Spring/">Spring</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">7.5k</span><span class="post-meta__separator">|</span><span>阅读时长: 31 分钟</span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="Advice"><a href="#Advice" class="headerlink" title="Advice"></a>Advice</h1><hr>
<p>在原方法基础之上，通过插入一段代码从而增强原方法的功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doWork</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = a / b;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增强原方法：在这个方法体的不同时机插入一段额外代码，让 doWork 方法的功能变得更强大，比如调用 doWork 方法前做日志记录。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/spring/15646434208790-springaop.jpg" alt=""></p>
<p>环绕增强=前置增强+后置增强+异常增强+最终增强，上图看成一个整体就是一个环绕增强代码案例。</p>
<p>假设一个应用场景：需要对系统中的某些业务方法做事务管理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">IAccountService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 保存操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加上事务之后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">IAccountService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 打开资源</span></span><br><span class="line">        <span class="comment">// 开启事务</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 保存操作</span></span><br><span class="line">            <span class="comment">// 提交事务</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 回滚事务</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 释放资源</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个业务方法都得处理事务管理操作。所以会出现问题，</p>
<ol>
<li>责任不分离：业务方法只需要关心如何完成该业务功能，不关心事务管理/日志管理/权限管理等</li>
<li>代码结构重复：在开发中不要重复代码，重复就意味着维护成本增大。</li>
</ol>
<h1 id="责任分离和代理思想"><a href="#责任分离和代理思想" class="headerlink" title="责任分离和代理思想"></a>责任分离和代理思想</h1><hr>
<p>代理的目的：不允许客户端直接访问真实对象，必须通过代理。客户端找代理，代理再找真实对象。</p>
<blockquote>
<p>代理的特点：</p>
<ol>
<li>代理对象完全包含真实对象，客户端使用的都是代理对象的方法，和真实对象没有直接关系。</li>
<li>代理模式的职责：把不是真实对象该做的事情从真实对象上撇开—职责清晰。</li>
</ol>
</blockquote>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/spring/15646458668749-springaop.png" alt="2019-08-01 at 4.20 P"></p>
<h1 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h1><hr>
<p>程序运行前，就能看到代理类的字节码。可以看到代理类的定义。所以代理对象和真实对象的关系在运行之前就确定了。</p>
<p>模拟事务管理器，包含了事务开启、提交和回滚操作</p>
<blockquote>
<p>这里的代码是基于文章 <a href="https://www.lizhaoloveit.cn/2019/07/25/Spring%E5%85%A5%E9%97%A8IoC%E3%80%81DI/#Spring%E9%9B%86%E6%88%90Mybatis" target="_blank" rel="noopener">Spring入门中Spring集成Mybatis</a>，我们需要在增删改查的基础上，增强 service，添加事务方法又不濡染业务代码。因此，在增加功能的同时，我们不能去修改 AccountServiceImpl 的代码。</p>
</blockquote>
<p>Test，我们的目的是调用代理的 gets 方法可以在完成以前 Service 功能的同事增加事务管理代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyApp</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> TransactionManagerProxy proxy;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStaticProxy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		 proxy.gets().forEach(System.out::println);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>事务管理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionManager</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"事务开始..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"提交事务..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"回滚..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"关闭资源..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TransactionManagerProxy 静态代理类，用于增强 service，这里的两个属性不能忘记写 set 方法，因为使用 DI 注入数据是通过 set 方法注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionManagerProxy</span> <span class="keyword">implements</span> <span class="title">IAccountService</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> IAccountService service; <span class="comment">// 真实对象</span></span><br><span class="line">	<span class="keyword">private</span> TransactionManager manager; <span class="comment">// 事务管理类</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Account&gt; <span class="title">gets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		manager.begin();</span><br><span class="line">		List&lt;Account&gt; gets = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			 gets = service.gets();</span><br><span class="line">			 manager.commit();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			manager.rollback();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			manager.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> gets;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只需要在 ProxyApp-context.xml 中配置 bean，让 Spring 注入数据即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:applicationContext.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.proxy.TransactionManager"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManagerProxy"</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.proxy.TransactionManagerProxy"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"service"</span> <span class="attr">ref</span>=<span class="string">"accountService"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"manager"</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>代理类 TransactionManagerProxy 需要被赋值2个属性</p>
<p>优点：业务类只需关注业务逻辑本身，保证了业务类的重用性，保护了真是对象<br>缺点：每一个真实对象都要创建一个代理对象，如果代理的方法很多则需要对每一种方法代理处理，如果接口增加一个方法，除了所有实现类要实现这个方法，代理类也要实现这个方法。</p>
<blockquote>
<p>如果有一个代理类能代理所有的 Service 实现类来处理事务控制就好了</p>
</blockquote>
<h1 id="JDK-动态代理-有接口"><a href="#JDK-动态代理-有接口" class="headerlink" title="JDK 动态代理(有接口)"></a>JDK 动态代理(有接口)</h1><hr>
<p>程序运行之后，通过反射等机制动态生成的，代理对象和真实对象的关系是在程序运行时期才确定的。</p>
<p>Java 是静态语言，需要编译，那么 Java 是如何实现动态的添加字节码并执行的呢。<br>我们编写的 Java 代码都是要被编译成字节码后才能放到 JVM 里执行，字节码(.class) 文件就是普通的二进制文件，它是通过 Java 编译器生成的。只要是文件就可以被改变，如果用特定的规则解析原有的字节码文件，对它进行修改或者干脆重新定义，就可以改变代码行为。</p>
<p><strong>遵循 Java 编译系统组织.class文件的格式和结构，生成相应的二进制数据，然后再把这个二进制数据加载转换成对应的类，如此就完成了在代码中动态创建一个类的能力</strong></p>
<p>JDK 动态代理 必须要求真实对象有接口</p>
<ul>
<li>java.lang.reflect.<strong>Proxy</strong> 类，</li>
</ul>
<p>反射包中有一个代理类，Java 动态代理机制生成的所有动态代理类的父类，提供了一组静态方法来为一组接口动态地创建代理类及其对象。主要方法：<br><code>public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces,InvocationHandler hanlder)</code></p>
<p>方法职责：未指定接口生成动态代理类对象并返回，参数列表如下：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>loader</td>
<td>类加载器，一般使用真实对象的类加载器即可</td>
</tr>
<tr>
<td>interfaces</td>
<td>代理类需要实现的接口</td>
</tr>
<tr>
<td>hanlder</td>
<td>代理对象如何做增强</td>
</tr>
</tbody></table>
<ul>
<li>java.lang.reflect.<strong>InvocationHandler</strong> 接口</li>
</ul>
<p>表示需要做功能增强的规范接口<br><code>public Object invoke(Object proxy, Method method, Object[] args)</code></p>
<p>方法职责：负责对动态代理类上的所有方法做增强(advice)操作，返回真是方法的执行结果，参数列表如下：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>proxy</td>
<td>生成的代理对象</td>
</tr>
<tr>
<td>method</td>
<td>当前调用的真实方法对象</td>
</tr>
<tr>
<td>args</td>
<td>当前调用方法的实参</td>
</tr>
</tbody></table>
<h2 id="JDK-动态代理操作步骤"><a href="#JDK-动态代理操作步骤" class="headerlink" title="JDK 动态代理操作步骤"></a>JDK 动态代理操作步骤</h2><hr>
<ol>
<li>实现 InvocationHandler 接口，创建自己增强功能的增强类。</li>
<li>给 Proxy 类提供 ClassLoader 对象和代理接口类型数组，创建动态代理对象。</li>
<li>在增强类中实现具体增强操作</li>
</ol>
<p>在使用时，需要与静态代理相同，在保护真实类型的前提下，增强真实类型的功能。因为需要动态获取 service 代理对象，因此会比静态多出一步获取代理对象的步骤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDKProxyApp</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> TransactionManagerAdvice advice;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGets</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		IAccountService proxy = advice.getProxyObject();</span><br><span class="line">		proxy.gets().forEach(System.out::println);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>事务管理类同静态代理，动态代理增强类代码如下：TransactionManagerAdvice.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionManagerAdvice</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Object target; <span class="comment">// 真实对象</span></span><br><span class="line">	<span class="keyword">private</span> TransactionManager manager; <span class="comment">// 事务管理类</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 创建代理对象</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxyObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (T)Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), <span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		Object res = <span class="keyword">null</span>;</span><br><span class="line">		<span class="comment">// 开启事务</span></span><br><span class="line">		manager.begin();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			res = method.invoke(target, args);</span><br><span class="line">			<span class="comment">// 提交事务</span></span><br><span class="line">			manager.commit();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="comment">// 回滚事务</span></span><br><span class="line">			manager.rollback();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			manager.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>java.lang.reflect.Proxy 工具类会帮我们通过代理类需要实现的接口、类加载器和功能增强类需要实现的接口 这三个参数来动态生成一个字节码对象并返回。</p>
<p>在调用这个动态代理对象的 代理真实类接口的方法时，会去<code>public Object invoke(Object proxy, Method method, Object[] args)</code> 方法中找到 真实对象的 method 方法，并调用。就相当于我们通过动态代理类拦截到真实对象调用接口的方法，并对方法进行增强处理。做更多的事情。但是真实类没有丝毫改变。</p>
<p>最后在 JDKProxyApp-context.xml 中去给 TransactionManagerAdvice 的属性赋值即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:applicationContext.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.jdkproxy.TransactionManager"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- tx 表示事务的意思 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.jdkproxy.TransactionManagerAdvice"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"target"</span> <span class="attr">ref</span>=<span class="string">"accountService"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"manager"</span> <span class="attr">ref</span>=<span class="string">"txManager"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="JDK-动态代理原理"><a href="#JDK-动态代理原理" class="headerlink" title="JDK 动态代理原理"></a>JDK 动态代理原理</h2><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">IAccountService</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Account&gt; <span class="title">gets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> accountMapper.gets();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountMapper</span><span class="params">(AccountMapper accountMapper)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.accountMapper = accountMapper;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述类生成动态代理类字节码经过反编译后会变成如下 java 代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceProxy</span>-2019-8-1 22-57-04 <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">IAccountService</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">private</span> <span class="title">static</span> <span class="title">Method</span> <span class="title">m1</span></span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object paramObject)</span> <span class="keyword">throws</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Boolean)<span class="keyword">this</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123; paramObject &#125;)).booleanValue();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException localRuntimeException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> localRuntimeException;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable localThrowable) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(localThrowable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">gets</span><span class="params">()</span> <span class="keyword">throws</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.h.invoke(<span class="keyword">this</span>, m4, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException localRuntimeException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> localRuntimeException;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable localThrowable) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(localThrowable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Integer)<span class="keyword">this</span>.h.invoke(<span class="keyword">this</span>, m0, <span class="keyword">null</span>)).intValue();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException localRuntimeException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> localRuntimeException;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable localThrowable) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(localThrowable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[]&#123;Class.forName(<span class="string">"java.lang.Object"</span>)&#125;);</span><br><span class="line">        m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">        m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">        m4 = Class.forName(<span class="string">"cn.lizhaoloveit.aop.service.IAccountService"</span>).getMethod(<span class="string">"gets"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们使用 <code>proxy.gets()</code> 实际上就是调用了 <code>this.h.invoke(this, m4, new Object[0]);</code>  this 是这个动态代理对象，h 就是 InvocationHandler 的实现类对象，也就是调用了实现类对象的 <code>invoke(Object proxy, Method method, Object[] args)</code> 方法，该 method 就是真实类的接口中的方法。</p>
<blockquote>
<p>如果我们在 InvocationHandler 中的 invoke 方法中打印 Proxy 动态代理类实例，其实是调用其 toString方法，会发现栈溢出，因为 toString 方法是真实类接口的父类接口方法，调用 toString 实际上还会调用 method 为 toString 的 invoke 方法，于是不停的重复调用出现栈溢出。</p>
</blockquote>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/spring/15646458668750-springaop.png" alt="2019-08-02 at 12.31 P"></p>
<h1 id="CGlib-动态代理"><a href="#CGlib-动态代理" class="headerlink" title="CGlib 动态代理"></a>CGlib 动态代理</h1><hr>
<p>没有接口的情况下，想要创建动态代理类，就只能选择继承真实类，然后通过覆盖真实类的方法去实现增强。</p>
<h2 id="使用-CGlib"><a href="#使用-CGlib" class="headerlink" title="使用 CGlib"></a>使用 CGlib</h2><p>Spring 内部已经集成了 CGLIB 库，而且为了和 JDK 动态增强保持一致，Spring 重写了 InvocationHandle 接口和相关组件，使之与 java.lang.reflect.InvocationHandler 接口保持回调的方法签名一致，这样在使用时，会发现除了生成动态代理类的方法会有区别，其余代码无需更改。</p>
<p>所以在使用时，只需要更改 TransactionManagerAdvice 类即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionManagerAdvice</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Object target; <span class="comment">// 真实对象</span></span><br><span class="line">	<span class="keyword">private</span> TransactionManager manager; <span class="comment">// 事务管理类</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 创建代理对象</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxyObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// enhancer 的意思是 增强者</span></span><br><span class="line">		Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">		enhancer.setSuperclass(target.getClass()); <span class="comment">// 设置父类</span></span><br><span class="line">		enhancer.setCallback(<span class="keyword">this</span>); <span class="comment">// 设置增强回调</span></span><br><span class="line">		<span class="keyword">return</span> (T)enhancer.create();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		Object res = <span class="keyword">null</span>;</span><br><span class="line">		<span class="comment">// 开启事务</span></span><br><span class="line">		manager.begin();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			res = method.invoke(target, args);</span><br><span class="line">			<span class="comment">// 提交事务</span></span><br><span class="line">			manager.commit();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="comment">// 回滚事务</span></span><br><span class="line">			manager.rollback();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			manager.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：InvocationHandler接口 是 org.springframework.cglib.proxy.InvocationHandler 包下的接口。<br>Enhancer 是增强类，用于动态构建字节码对象<br>需要传入父类，类型和设置回调。</p>
</blockquote>
<h2 id="CGlib-原理"><a href="#CGlib-原理" class="headerlink" title="CGlib 原理"></a>CGlib 原理</h2><hr>
<p>动态代理类代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span>$$<span class="title">EnhancerByCGLIB</span>$$<span class="title">b78ee32f</span> <span class="keyword">extends</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> CGLIB$BOUND;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Object CGLIB$FACTORY_DATA;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal CGLIB$THREAD_CALLBACKS;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Callback[] CGLIB$STATIC_CALLBACKS;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> InvocationHandler CGLIB$CALLBACK_0;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Object CGLIB$CALLBACK_FILTER;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method CGLIB$setAccountMapper$<span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method CGLIB$gets$<span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method CGLIB$equals$<span class="number">2</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method CGLIB$toString$<span class="number">3</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method CGLIB$hashCode$<span class="number">4</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method CGLIB$clone$<span class="number">5</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> CGLIB$STATICHOOK1() &#123;</span><br><span class="line">    CGLIB$THREAD_CALLBACKS = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line">    CGLIB$setAccountMapper$<span class="number">0</span> = Class.forName(<span class="string">"cn.lizhaoloveit.aop.service.impl.AccountServiceImpl"</span>).getDeclaredMethod(<span class="string">"setAccountMapper"</span>, <span class="keyword">new</span> Class[] &#123; Class.forName(<span class="string">"cn.lizhaoloveit.aop.mapper.AccountMapper"</span>) &#125;);</span><br><span class="line">    CGLIB$gets$<span class="number">1</span> = Class.forName(<span class="string">"cn.lizhaoloveit.aop.service.impl.AccountServiceImpl"</span>).getDeclaredMethod(<span class="string">"gets"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">    CGLIB$equals$<span class="number">2</span> = Class.forName(<span class="string">"java.lang.Object"</span>).getDeclaredMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[] &#123; Class.forName(<span class="string">"java.lang.Object"</span>) &#125;);</span><br><span class="line">    CGLIB$toString$<span class="number">3</span> = Class.forName(<span class="string">"java.lang.Object"</span>).getDeclaredMethod(<span class="string">"toString"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">    CGLIB$hashCode$<span class="number">4</span> = Class.forName(<span class="string">"java.lang.Object"</span>).getDeclaredMethod(<span class="string">"hashCode"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">    CGLIB$clone$<span class="number">5</span> = Class.forName(<span class="string">"java.lang.Object"</span>).getDeclaredMethod(<span class="string">"clone"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAccountMapper</span><span class="params">(AccountMapper paramAccountMapper)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.CGLIB$CALLBACK_0 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">new</span> Object[<span class="number">1</span>][<span class="number">0</span>] = paramAccountMapper;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException|Error runtimeException) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(<span class="keyword">null</span>);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> List <span class="title">gets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.CGLIB$CALLBACK_0 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">return</span> (List)<span class="keyword">this</span>.CGLIB$CALLBACK_0.invoke(<span class="keyword">this</span>, CGLIB$gets$<span class="number">1</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException|Error runtimeException) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(<span class="keyword">null</span>);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object paramObject)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.CGLIB$CALLBACK_0 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">return</span> ((Boolean)<span class="keyword">this</span>.CGLIB$CALLBACK_0.invoke(<span class="keyword">this</span>, CGLIB$equals$<span class="number">2</span>, <span class="keyword">new</span> Object[] &#123; paramObject &#125;)).booleanValue();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException|Error runtimeException) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(<span class="keyword">null</span>);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.CGLIB$CALLBACK_0 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">return</span> (String)<span class="keyword">this</span>.CGLIB$CALLBACK_0.invoke(<span class="keyword">this</span>, CGLIB$toString$<span class="number">3</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException|Error runtimeException) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(<span class="keyword">null</span>);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.CGLIB$CALLBACK_0 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">return</span> ((Number)<span class="keyword">this</span>.CGLIB$CALLBACK_0.invoke(<span class="keyword">this</span>, CGLIB$hashCode$<span class="number">4</span>, <span class="keyword">new</span> Object[<span class="number">0</span>])).intValue();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException|Error runtimeException) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(<span class="keyword">null</span>);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.CGLIB$CALLBACK_0 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.CGLIB$CALLBACK_0.invoke(<span class="keyword">this</span>, CGLIB$clone$<span class="number">5</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException|Error|CloneNotSupportedException runtimeException) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(<span class="keyword">null</span>);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> AccountServiceImpl$$EnhancerByCGLIB$$b78ee32f() &#123; CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>); &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> CGLIB$SET_THREAD_CALLBACKS(Callback[] paramArrayOfCallback) &#123; CGLIB$THREAD_CALLBACKS.set(paramArrayOfCallback); &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> CGLIB$SET_STATIC_CALLBACKS(Callback[] paramArrayOfCallback) &#123; CGLIB$STATIC_CALLBACKS = paramArrayOfCallback; &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> CGLIB$BIND_CALLBACKS(Object paramObject) &#123;</span><br><span class="line">    AccountServiceImpl$$EnhancerByCGLIB$$b78ee32f accountServiceImpl$$EnhancerByCGLIB$$b78ee32f = (AccountServiceImpl$$EnhancerByCGLIB$$b78ee32f)paramObject;</span><br><span class="line">    <span class="keyword">if</span> (!accountServiceImpl$$EnhancerByCGLIB$$b78ee32f.CGLIB$BOUND) &#123;</span><br><span class="line">      accountServiceImpl$$EnhancerByCGLIB$$b78ee32f.CGLIB$BOUND = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (CGLIB$THREAD_CALLBACKS.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        CGLIB$THREAD_CALLBACKS.get();</span><br><span class="line">        <span class="keyword">if</span> (CGLIB$STATIC_CALLBACKS == <span class="keyword">null</span>) &#123;</span><br><span class="line">          CGLIB$STATIC_CALLBACKS;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125; </span><br><span class="line">      &#125; </span><br><span class="line">      accountServiceImpl$$EnhancerByCGLIB$$b78ee32f.CGLIB$CALLBACK_0 = (InvocationHandler)(Callback[])CGLIB$THREAD_CALLBACKS.get()[<span class="number">0</span>];</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(Callback[] paramArrayOfCallback)</span> </span>&#123;</span><br><span class="line">    CGLIB$SET_THREAD_CALLBACKS(paramArrayOfCallback);</span><br><span class="line">    CGLIB$SET_THREAD_CALLBACKS(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AccountServiceImpl$$EnhancerByCGLIB$$b78ee32f();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(Callback paramCallback)</span> </span>&#123;</span><br><span class="line">    CGLIB$SET_THREAD_CALLBACKS(<span class="keyword">new</span> Callback[] &#123; paramCallback &#125;);</span><br><span class="line">    CGLIB$SET_THREAD_CALLBACKS(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AccountServiceImpl$$EnhancerByCGLIB$$b78ee32f();</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Callback <span class="title">getCallback</span><span class="params">(<span class="keyword">int</span> paramInt)</span> </span>&#123;</span><br><span class="line">    CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">switch</span> (paramInt) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallback</span><span class="params">(<span class="keyword">int</span> paramInt, Callback paramCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (paramInt) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">this</span>.CGLIB$CALLBACK_0 = (InvocationHandler)paramCallback;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> Callback[] getCallbacks() &#123;</span><br><span class="line">    CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Callback[] &#123; <span class="keyword">this</span>.CGLIB$CALLBACK_0 &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallbacks</span><span class="params">(Callback[] paramArrayOfCallback)</span> </span>&#123; <span class="keyword">this</span>.CGLIB$CALLBACK_0 = (InvocationHandler)paramArrayOfCallback[<span class="number">0</span>]; &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span>  &#123;</span><br><span class="line">    CGLIB$STATICHOOK1();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，动态代理类继承了 AccountServiceImpl ，覆盖了所有的 public 修饰的方法，与JDK动态代理类类似，将 AccountServiceImpl 中的 public 方法全部作为成员变量记录下来，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> CGLIB$STATICHOOK1() &#123;</span><br><span class="line">    CGLIB$THREAD_CALLBACKS = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line">    CGLIB$setAccountMapper$<span class="number">0</span> = Class.forName(<span class="string">"cn.lizhaoloveit.aop.service.impl.AccountServiceImpl"</span>).getDeclaredMethod(<span class="string">"setAccountMapper"</span>, <span class="keyword">new</span> Class[] &#123; Class.forName(<span class="string">"cn.lizhaoloveit.aop.mapper.AccountMapper"</span>) &#125;);</span><br><span class="line">    CGLIB$gets$<span class="number">1</span> = Class.forName(<span class="string">"cn.lizhaoloveit.aop.service.impl.AccountServiceImpl"</span>).getDeclaredMethod(<span class="string">"gets"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">    CGLIB$equals$<span class="number">2</span> = Class.forName(<span class="string">"java.lang.Object"</span>).getDeclaredMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[] &#123; Class.forName(<span class="string">"java.lang.Object"</span>) &#125;);</span><br><span class="line">    CGLIB$toString$<span class="number">3</span> = Class.forName(<span class="string">"java.lang.Object"</span>).getDeclaredMethod(<span class="string">"toString"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">    CGLIB$hashCode$<span class="number">4</span> = Class.forName(<span class="string">"java.lang.Object"</span>).getDeclaredMethod(<span class="string">"hashCode"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">    CGLIB$clone$<span class="number">5</span> = Class.forName(<span class="string">"java.lang.Object"</span>).getDeclaredMethod(<span class="string">"clone"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> List <span class="title">gets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.CGLIB$CALLBACK_0 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">return</span> (List)<span class="keyword">this</span>.CGLIB$CALLBACK_0.invoke(<span class="keyword">this</span>, CGLIB$gets$<span class="number">1</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException|Error runtimeException) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(<span class="keyword">null</span>);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当使用动态代理类调用 gets() 时，实际上调用了 <code>(List)this.CGLIB$CALLBACK_0.invoke(this, CGLIB$gets$1, new Object[0]);</code></p>
<p>CGLIB$CALLBACK_0 就是 TransactionManagerAdvice，是 InvocationHandler 的实现类。<br>调用该方法就是调用 TransactionManagerAdvice 实现的 invoke 方法。并在方法内部对真实类的 gets() 方法进行增强。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/spring/15646458668751-springaop.png" alt="2019-08-02 at 4.02 P"></p>
<blockquote>
<p>总结：<br>JDK 动态代理会拦截所有接口中定义的方法，在接口中增加了新的方法，不用修改代码也会被拦截。<br>用 CGlib，类型不能被final 修饰，只能拦截 <strong>非final</strong>、<strong>非static</strong>、<strong>非private</strong>的方法。<br>动态代理的最小单位是类，所有类(接口)中的方法都会被拦截，如果只想拦截一部分方法，则需要在 invoke 中处理。<br>性能：Javassit &gt; CGlib &gt; JDK<br>真实对象实现了接口，选用 JDK，否则选用 CGlib、JDK(面向接口编程)</p>
</blockquote>
<h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><hr>
<p>在很多业务中，需要在一些<strong>业务流程</strong>中插入一些其他的模块功能。将业务流程当作水流，AOP 思想就是在<strong>水流的某个位置(切面)插入功能模块，同时，不影响正常的业务代码类的思想</strong>。</p>
<p>开发中，为了给业务方法中增加日志记录，权限检查，事务控制等功能，我们需要修改业务代码，考虑到代码的重用性，使用 继承、组合关系消除重复代码。但无论是集成业务类的子类，还是引用业务类去完成功能，都无法做到通用性，必须对业务类有所影响。</p>
<p>此时，既不遵循<a href="https://www.lizhaoloveit.cn/2019/08/02/%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/#%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99" target="_blank" rel="noopener">开闭原则</a>，也无法完全消除重复代码。</p>
<h2 id="AOP-思想"><a href="#AOP-思想" class="headerlink" title="AOP 思想"></a>AOP 思想</h2><hr>
<p>我们把这些零散的存在于业务方法中的功能代码，称为横切面关注点，横切面关注点不属于业务范围，应该从业务代码中剥离。把多个业务方法的切面关注点封装到一个模块中称为一个切面。切面就是一个功能模块，通用的解决业务流中的某一个面上的问题。比如，应用中许多地方需要做日志记录，只需要插入日志切面即可。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/spring/15647384178563-springaop.jpg" alt=""></p>
<blockquote>
<p>AOP 把多个业务方法需要调用的代码封装到不同的模块中去(责任分离思想)，使用动态代理机制来动态的增强业务功能，从而达到了代码的复用，提高了维护性。</p>
</blockquote>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><hr>
<ul>
<li>where 哪些方法，使用类的全限定名称 (<strong>Pointcut</strong>，哪些包的哪些类中的哪些方法)</li>
<li>when 在方法体执行的时机：之前、之后、异常、最终、环绕 (<strong>Jointpoint</strong>)</li>
<li>what 做什么功能的增强：不同的增强功能使用不同的模块或类来封装 (<strong>Advice</strong>)</li>
</ul>
<p>AOP 中有几个核心概念，必须掌握：</p>
<ul>
<li>Joinpoint：连接点，程序执行过程中的特定位置，初始化前/后，方法调用前/后，方法抛出异常后，这些特定的位置称为连接点，<strong>在连接点可以插入代码，增强功能</strong></li>
<li>Pointcut：切入点，开发中，不需要对应用中所有的连接点都做增强，切入点的作用就是缩小增强范围，比如那些包的哪些类中的那些方法，相当于切面在何处增强</li>
<li>Advice：增强，拦截到连接点后，需要做什么功能。 what</li>
<li>Aspect：切面，Pointcur + Advice。哪些方法中+在方法执行的什么时机+做什么增强</li>
<li>Target：真实类，被代理的目标</li>
<li>Weaving：把 Advice 加到 Target 上后，创建出 Proxy 对象的过程，编织。</li>
<li>Proxy：一个类被 AOP 织入增强后，产生的代理类。</li>
</ul>
<h2 id="Pointcut-语法"><a href="#Pointcut-语法" class="headerlink" title="Pointcut 语法"></a>Pointcut 语法</h2><hr>
<p>在指定 AOP 规范时，首先需要解决的一个问题就是<br><em>怎么来表示切入点，需要在哪些方法上做增强？这是一个如何表示 Where 的问题</em></p>
<p>AspectJ 项目定义了 AOP 的语法，确定了如何去表达 where:(哪些包?哪些类?哪些方法?)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">execution(modifiers-pattern? ret-type-pattern declaring-type-pattern? </span><br><span class="line">name-pattern(param-pattern) <span class="keyword">throws</span>-pattern?)</span><br></pre></td></tr></table></figure>
<p>中文：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>modifiers-pattern</td>
<td>方法修饰符?</td>
</tr>
<tr>
<td>ret-type-pattern</td>
<td>返回类型</td>
</tr>
<tr>
<td>declaring-type-pattern</td>
<td>声明类型?(方法名的全限定名)</td>
</tr>
<tr>
<td>name-pattern</td>
<td>方法名</td>
</tr>
<tr>
<td>param-pattern</td>
<td>参数</td>
</tr>
<tr>
<td>throws-pattern</td>
<td>异常?</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public static Class java.lang.Class.forName(String className) throws ClassNotFoundException</span><br><span class="line">--修饰符-------返回类型---------全限定名-------------参数------------异常---</span><br></pre></td></tr></table></figure>
<p>表达式中可使用通配符： </p>
<ul>
<li><code>*</code> 表示匹配任意部分，不包括子包。</li>
<li><code>..</code> 用于全限定名和方法参数中，分别表示子包和0-N个参数。</li>
</ul>
<h3 id="常见写法"><a href="#常见写法" class="headerlink" title="常见写法"></a>常见写法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">excution(public * *(..))</span><br></pre></td></tr></table></figure>
<p>所有的以 public 修饰的方法都会被增强</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* cn.wolfcode.wms.service.*.*(..))</span><br></pre></td></tr></table></figure>
<p>表示：在 cn.wolfcode.wms.service 包下的方法会被增强</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* set*(..))</span><br></pre></td></tr></table></figure>
<p>表示所有 setXxx 方法都会被增强</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* cn.wolfcode.wms.service.*Service.*(..))</span><br></pre></td></tr></table></figure>
<p>表示 所有 cn.wolfcode.wms.service 包下的类名称以 Service 结尾的，所有方法都会被增强。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* cn.wolfcode..service.*Service.*(..))</span><br></pre></td></tr></table></figure>
<p>表示 所有以 cn.wolfcode 开头，以 service 包结尾下的 类名称以 Service 结尾的所有方法都会被增强</p>
<h2 id="开发中的配置"><a href="#开发中的配置" class="headerlink" title="开发中的配置"></a>开发中的配置</h2><hr>
<p>Spring5 开始，在 spring-aop 中纳入了 AOP 联盟的 API，不需要拷贝 aopalliance-1.0.0.jar。</p>
<p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>AOP 配置三部曲：where-when-what</p>
<p>之前，我们自己来做 JDK 动态代理时，需要创建 Advice 增强类来获取动态代理对象，并接受回调。而使用 spring-aop，只需要增强功能模块，以及配置文件即可。让 spring-aop 帮我们完成动态代理增强功能。</p>
<p>配置文件中要阐述清楚 where-when-what</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/aop </span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:applicationContext.xml"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- execution(* cn.lizhaoloveit.aop.service.*Service.*(..)) --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 1. what --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.aopjdkproxy.TransactionManager"</span>/&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 2. where 哪些包 哪些类 哪些方法 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 3. when --&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- Aop 配置 proxy-target-class 默认是 false 使用 JDK动态代理，改为 true 使用CGlib动态代理 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">aop:config</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 切面:切面内部有 where 和 when 需要和 what 联系起来</span></span><br><span class="line"><span class="comment">			意思就是 在 Service 类中的所有方法调用前插入事务管理类的 begin 方法 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- where --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* cn.lizhaoloveit.aop.service.*Service.*(..))"</span> <span class="attr">id</span>=<span class="string">"txPointcut"</span>/&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- when --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"begin"</span> <span class="attr">pointcut-ref</span>=<span class="string">"txPointcut"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先，必须引入 schema/aop 约束，然后注入我们的增强功能模块 <code>transactionManager</code>。</p>
<p>在 <code>&lt;aop:config&gt;</code> 的配置中，默认是使用 JDK动态代理，因为 spring 希望我们使用面向接口编程的思想。<code>proxy-target-class=&quot;true&quot;</code> 该属性默认是 false 使用 JDK动态代理，改为 true 则使用 CGlib 动态代理。</p>
<p>在 aop 标签中，一个 aspect 代表一个功能模块，译文为切面。每个 <code>&lt;aop:aspect&gt;</code> 都会阐述清楚 在 <strong>哪个类中的哪个方法(where)</strong> 的 <strong>前置/后置/异常/环绕等(when)</strong> 时机插入<strong>哪个功能模块类的 什么方法(what)</strong>  具体为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* cn.lizhaoloveit.aop.service.*Service.*(..))"</span> <span class="attr">id</span>=<span class="string">"txPointcut"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"begin"</span> <span class="attr">pointcut-ref</span>=<span class="string">"txPointcut"</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></table></figure>


<ul>
<li>aspect : 表示一个切面 ref 属性表示功能增强模块类</li>
<li>pointcut : 表示切入点，也就是用 AspectJ语法表达了在哪个业务类，为了方便后续引用，给该切入点配置 id 属性。</li>
<li><code>&lt;aop:before&gt;...</code> 等标签规定了时机，比如上面的例子，before 就是前置增强，也就是说框架会在业务代码调用该方法时拦截<strong>(通过业务类的接口生成动态代理对象调用接口方法，动态代理再调用接口方法时，实际上调用的 InvocationHandler 实现类(也就是增强类)的 invoke方法，使得增强类通过实现接口的回调方法进行拦截)</strong>并在业务类的方法调用前，调用增强模块的 begin 方法。 </li>
</ul>
<blockquote>
<p>代码变得非常简洁：我们需要写的只有</p>
<ol>
<li>业务类</li>
<li>增强功能模块</li>
<li>配置文件，把(where, when, what)串联起来<br>就可以在不修改任何业务代码的情况下，给业务流中间注入功能模块，维护只需要修改配置文件即可。提现了业务与功能模块分离，更好管理和维护。</li>
</ol>
</blockquote>
<h2 id="各种增强时机"><a href="#各种增强时机" class="headerlink" title="各种增强时机"></a>各种增强时机</h2><hr>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/spring/15646434208790-springaop.jpg" alt=""></p>
<table>
<thead>
<tr>
<th>增强</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>aop:before 前置增强</td>
<td>方法执行前执行增强 权限控制、记录调用日志</td>
</tr>
<tr>
<td>aop:after-returning 后置增强</td>
<td>在方法正常执行之后，执行增强(中间没遇到任何异常) 统计分析结果数据</td>
</tr>
<tr>
<td>aop:throwing 异常增强</td>
<td>在方法抛出异常catch时执行增强 日志记录方法获取异常信息，可以通过配置 throwing 来获得拦截到的异常信息</td>
</tr>
<tr>
<td>aop:after 最终增强</td>
<td>finally 里执行，通常用于释放资源</td>
</tr>
<tr>
<td>aop:around 环绕增强</td>
<td>最强大的一种增强类型，环绕增强可以在方法调用前/后完成自定义行为，环绕增强有两个要求：1.方法需要返回一个 Object，2.方法的第一个参数必须是 ProceedingJoinPoint 可以继续向下传递的连接点  缓存、性能日志、权限、事务管理</td>
</tr>
</tbody></table>
<blockquote>
<p>如果在增强方法中引用了没有的参数会报如下错误，例如在 <code>close()</code> 关闭资源中加入了 Throwable exception 参数，<code>close(Throwable exception)</code>，aop:after 是没有 Throwable exception 引用的</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalArgumentException: error at ::0 formal unbound in pointcut</span><br></pre></td></tr></table></figure>

<p>TranscationManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionManager</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 提供访问当前被增强对象的 真实对象、代理对象、方法参数等数据，所有增强方法都可以带这个参数</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(JoinPoint jp)</span> </span>&#123;</span><br><span class="line">	   <span class="comment">// 代理对象 :class com.sun.proxy.$Proxy21</span></span><br><span class="line">		System.out.println(<span class="string">"代理对象 :"</span> + jp.getThis().getClass());</span><br><span class="line">		<span class="comment">// 目标对象 :class cn.lizhaoloveit.aop.service.impl.AccountServiceImpl</span></span><br><span class="line">		System.out.println(<span class="string">"目标对象 :"</span> + jp.getTarget().getClass());</span><br><span class="line">		System.out.println(<span class="string">"被增强方法参数 :"</span> + Arrays.toString(jp.getArgs()));</span><br><span class="line">		<span class="comment">// 当前连接点签名 :List cn.lizhaoloveit.aop.service.IAccountService.gets()</span></span><br><span class="line">		System.out.println(<span class="string">"当前连接点签名 :"</span> + jp.getSignature());</span><br><span class="line">		<span class="comment">// 当前连接点类型 :method-execution</span></span><br><span class="line">		System.out.println(<span class="string">"当前连接点类型 :"</span> + jp.getKind());</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"事务开始..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(JoinPoint jp)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"当前连接点签名 :"</span> + jp.getSignature());</span><br><span class="line">		System.out.println(<span class="string">"提交事务..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">(JoinPoint jp, Throwable exception)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"当前连接点签名 :"</span> + jp.getSignature());</span><br><span class="line">		System.out.println(<span class="string">"回滚..."</span> + exception);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"关闭资源..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint pjp)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		Object res = <span class="keyword">null</span>;</span><br><span class="line">		begin(pjp);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"执行目标方法"</span>);</span><br><span class="line">			<span class="comment">// 执行目标方法</span></span><br><span class="line">			res = pjp.proceed();</span><br><span class="line">			commit(pjp);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			rollback(pjp, e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JDKProxyApp-context.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/aop </span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:applicationContext.xml"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- execution(* cn.lizhaoloveit.aop.service.*Service.*(..)) --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 1. what --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.aopjdkproxy.TransactionManager"</span>/&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 2. where 哪些包 哪些类 哪些方法 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 3. when --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- Aop 配置 proxy-target-class 默认是 false 使用 JDK动态代理，改为 true 使用CGlib动态代理 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">aop:config</span> <span class="attr">proxy-target-class</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 切面:切面内部有 where 和 when 需要和 what 联系起来</span></span><br><span class="line"><span class="comment">			意思就是 在 Service 类中的所有方法调用前插入事务管理类的 begin 方法 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- where --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* cn.lizhaoloveit.aop.service.*Service.*(..))"</span> <span class="attr">id</span>=<span class="string">"txPointcut"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"begin"</span> <span class="attr">pointcut-ref</span>=<span class="string">"txPointcut"</span>/&gt;</span> </span><br><span class="line">			<span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">"commit"</span> <span class="attr">pointcut-ref</span>=<span class="string">"txPointcut"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">"rollback"</span> <span class="attr">pointcut-ref</span>=<span class="string">"txPointcut"</span> <span class="attr">throwing</span>=<span class="string">"exception"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"close"</span> <span class="attr">pointcut-ref</span>=<span class="string">"txPointcut"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">"around"</span> <span class="attr">pointcut-ref</span>=<span class="string">"txPointcut"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>环绕增强=前置增强 + 后置增强 + 异常增强 + 最终增强，如果有环绕增强，则其余增强不需要写</p>
</blockquote>
<p>配置增强的参数：</p>
<ol>
<li>Spring AOP 提供 org.aspectj.lang.joinPoint 类，作为增强方法的第一个参数。<ul>
<li>JoinPoint：提供访问当前被增强方法的真实对象、代理对象、方法参数等数据</li>
<li>ProceedingJoinPoint：JinPoint 子类，只用于环绕增强中，可以处理被增强方法。环绕增强中，调用真实类的业务方法。</li>
</ul>
</li>
<li>异常增强获取异常信息：<code>&lt;aop:after-throwing method=&quot;rollback&quot; pointcut-ref=&quot;txPointcut&quot; throwing=&quot;exception&quot;/&gt;</code>，只需要做这个配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">(JoinPoint jp, Throwable exception)</span> </span>&#123;</span><br><span class="line">	System.out.println(<span class="string">"当前连接点签名 :"</span> + jp.getSignature());</span><br><span class="line">	System.out.println(<span class="string">"回滚..."</span> + exception.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如此可以拿到异常信息。</p>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><hr>
<p>在每次调用 service 方法之前，往数据库中插入一条数据，记录时间，哪一个类中的哪一个方法。</p>
<p>在做一个切面功能模块时，按照以下步骤：</p>
<ol>
<li>先要将模块功能代码编写完毕，编写测试功能模块，并且测试通过。</li>
<li>编写模块功能使用类型，例如 TransactionManager.java 类，对外入口。</li>
<li>编写切面模块插入业务流程的测试模块。并测试完毕</li>
</ol>
<p>日志录入功能其实并不复杂，就是对另一个表进行增删改查，首先建立一个表 record 表，设置字段，建立domain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Record</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> Date addTime;</span><br><span class="line">	<span class="keyword">private</span> String method;</span><br><span class="line">	<span class="keyword">private</span> String classQualifiedName;</span><br><span class="line">	<span class="keyword">private</span> String className;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 Mybatis 需要的 RecordMapper.java 接口和 RecordMapper.xml，这里只需要 insert 方法即可。(略)</p>
<p>编写测试代码，并且测试通过</p>
<p>接下来，需要有一个类去完成功能增强，LogRecord.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogRecord</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> RecordService recordService;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRecordService</span><span class="params">(RecordService recordService)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.recordService = recordService;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(JoinPoint jp)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"插入日志到数据库"</span>);</span><br><span class="line">		Class targetClass = jp.getTarget().getClass();</span><br><span class="line">		String className = targetClass.getSimpleName();</span><br><span class="line">		String classQualifiedName = targetClass.getName();</span><br><span class="line">		String method = jp.getSignature().getName();</span><br><span class="line">		Date addtime = <span class="keyword">new</span> Date();</span><br><span class="line">		Record record = <span class="keyword">new</span> Record(<span class="keyword">null</span>, addtime, method, classQualifiedName, className);</span><br><span class="line">		recordService.insertLog(record);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类的作用就是完成增强功能的代码，接下来就可以在配置文件中告诉 spring-aop 实现动态代理增强业务功能了，what 已经有了，还需要配置 where 和 when</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"logRecord"</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.logrecord.LogRecord"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"recordService"</span> <span class="attr">ref</span>=<span class="string">"recordService"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"logRecord"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* cn.lizhaoloveit.aop.service.*Service.*(..))"</span> <span class="attr">id</span>=<span class="string">"logPointcut"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"record"</span> <span class="attr">pointcut-ref</span>=<span class="string">"logPointcut"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后对业务功能进行测试，看是否已经插入切面。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ammar</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lizhaoloveit.cn/2019/07/31/SpringAOP/">http://lizhaoloveit.cn/2019/07/31/SpringAOP/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lizhaoloveit.cn">Ammar's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring/">Spring    </a></div><div class="post_share"><div class="social-share" data-image="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2019/08/01/MapperFactoryBean/"><img class="prev_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>MapperFactoryBean</span></div></a></div><div class="next-post pull-right"><a href="/2019/07/25/Spring%E5%85%A5%E9%97%A8IoC%E3%80%81DI/"><img class="next_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Spring入门IoC、DI</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'http://lizhaoloveit.cn/2019/07/31/SpringAOP/';
  this.page.identifier = '2019/07/31/SpringAOP/';
  this.page.title = 'SpringAOP';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'lizhao' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2023 By Ammar</div><div class="icp"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener"><span>浙ICP备19013619号-1</span></a></div><div class="bag"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010502006128" target="_blank" rel="noopener"><img src="/img/beian.png"><span>浙公网安备 33010502006128号</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="far fa-moon nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script async src="/js/search/algolia.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>