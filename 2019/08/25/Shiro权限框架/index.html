<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Shiro权限框架 | Ammar's Blog</title><meta name="description" content="Shiro权限框架"><meta name="keywords" content="Shiro"><meta name="author" content="Ammar"><meta name="copyright" content="Ammar"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://lizhaoloveit.cn/2019/08/25/Shiro%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Shiro权限框架"><meta name="twitter:description" content="Shiro权限框架"><meta name="twitter:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Shiro权限框架"><meta property="og:url" content="http://lizhaoloveit.cn/2019/08/25/Shiro%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/"><meta property="og:site_name" content="Ammar's Blog"><meta property="og:description" content="Shiro权限框架"><meta property="og:image" content="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="Restful架构" href="http://lizhaoloveit.cn/2019/09/03/Restful%E6%9E%B6%E6%9E%84/"><link rel="next" title="CRM系统" href="http://lizhaoloveit.cn/2019/08/24/CRM%E7%B3%BB%E7%BB%9F/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?162506e75ffd64287398566b2f5738c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"VRMKRAV9AT","apiKey":"bd7157400046d0f02396708a501a3480","indexName":"lizhaoloveit","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://lizhaoloveit.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script><meta name="generator" content="Hexo 4.2.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Apache-Shiro"><span class="toc-number">1.</span> <span class="toc-text">Apache Shiro</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基于-ini-的-Shiro-认证"><span class="toc-number">2.</span> <span class="toc-text">基于 ini 的 Shiro 认证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#自定义-Realm"><span class="toc-number">3.</span> <span class="toc-text">自定义 Realm</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-与-Shiro-整合"><span class="toc-number">4.</span> <span class="toc-text">Spring 与 Shiro 整合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shiro-制定化认证登录"><span class="toc-number">5.</span> <span class="toc-text">Shiro 制定化认证登录</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shiro-RememberMe-流程原理"><span class="toc-number">6.</span> <span class="toc-text">Shiro RememberMe 流程原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shiro-授权概述"><span class="toc-number">7.</span> <span class="toc-text">Shiro 授权概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web-下-Realm-的授权"><span class="toc-number">8.</span> <span class="toc-text">web 下 Realm 的授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#异步请求没有权限异常处理"><span class="toc-number">8.1.</span> <span class="toc-text">异步请求没有权限异常处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shiro标签控制权限"><span class="toc-number">9.</span> <span class="toc-text">Shiro标签控制权限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-number">9.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用标签"><span class="toc-number">9.2.</span> <span class="toc-text">常用标签</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MD5-加密"><span class="toc-number">10.</span> <span class="toc-text">MD5 加密</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#集成-EhCache"><span class="toc-number">11.</span> <span class="toc-text">集成 EhCache</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#清空缓存"><span class="toc-number">11.1.</span> <span class="toc-text">清空缓存</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">12.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Security"><span class="toc-number">13.</span> <span class="toc-text">Spring Security</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://lizhaoloveit.cn/blogimages/blog/top_img.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Ammar's Blog</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description">微信号：aicjaish</div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a><a class="site-page" href="/comment/"><i class="fa-fw fa fa-coffee"></i><span> 留言</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Shiro权限框架</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-08-25<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-09-02</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%A1%86%E6%9E%B6/Apache/">Apache</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">8.4k</span><span class="post-meta__separator">|</span><span>阅读时长: 34 分钟</span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="Apache-Shiro"><a href="#Apache-Shiro" class="headerlink" title="Apache Shiro"></a>Apache Shiro</h1><hr>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>强大易用的 Java 安全框架，身份验证、授权、密码和会话管理。不跟任何框架或者容器绑定，可以独立运行。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/shiro/15667435984805-shiro.png"></p>
<table>
<thead>
<tr>
<th>组件</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Subject(用户)</td>
<td>认证主体，相当于当前操作用户。它可以是任何事物，比如程序等 <code>Subject currentUser = SecurityUtils.getSubject();</code> 类似 <code>Employee user = SessionUtil.getAttribute(Employee.class);</code> 一旦获得 Subject，就可以立即使用 Shrio 为当前用户做事，比如登录、登出、访问会话、执行授权等</td>
</tr>
<tr>
<td>SecurityManager 安全管理器</td>
<td>它是 Shiro 功能实现的核心，负责与其他组件(认证器&#x2F;授权器&#x2F;缓存控制器)进行交互，实现 Subject 委托的各种功能。类似于 SpringMVC 中的 DispatcherServlet 前端控制器</td>
</tr>
<tr>
<td>Realms 数据源</td>
<td>Realm 是 Shiro 与应用数据之间的桥梁，可以把 Realm 看成连接池 DataSource，执行认证(登录)和授权(访问控制)时，Shiro 会从应用配置的 Realm 中查找相关的比对数据，确认用户是否合法，操作是否合理</td>
</tr>
<tr>
<td>Authenticator 认证</td>
<td>协调一个或者多个 Realm，从 Realm 指定的数据源取得数据之后执行具体的认证</td>
</tr>
<tr>
<td>Authorizer 授权</td>
<td>决定用户是否拥有执行指定操作的权限</td>
</tr>
<tr>
<td>SessionManager</td>
<td>Shiro 支持会话管理，在安全框架中是独一无二的功能，即便不存在 web 容器环境，Shiro 都可以使用自己的会话管理机制，提供相同的会话 API</td>
</tr>
<tr>
<td>CacheManager 缓存组件</td>
<td>缓存认证信息</td>
</tr>
<tr>
<td>Cryptography 加密组件</td>
<td>Shiro 提供了加密解密的命令行工具 jar 包，需要单独下载使用</td>
</tr>
</tbody></table>
<blockquote>
<p>Shiro 架构的核心(Subject，SecurityManager，Realms)</p>
</blockquote>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/shiro/15668040957744-shiro.jpg"></p>
<p>Shiro 在应用中最常用的两个功能：用户登录认证和访问授权。</p>
<h1 id="基于-ini-的-Shiro-认证"><a href="#基于-ini-的-Shiro-认证" class="headerlink" title="基于 ini 的 Shiro 认证"></a>基于 ini 的 Shiro 认证</h1><hr>
<p>Shiro 认证概述，认证的过程为用户的身份确认过程。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/shiro/15668044324952-shiro.jpg"></p>
<p>上图表明了用户访问的认证流程，是否需要认证和是否已经通过认证，最关键的是如何认证。</p>
<p>准备工作：导入 jar 包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写 ini 配置文件：<br>shiro-permission.ini</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户</span></span><br><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="comment"># 用户zhang的密码是123，此用户具有role1和role2两个角色</span></span><br><span class="line"><span class="attr">zhang</span>=<span class="number">123</span>,role1,role2</span><br><span class="line"><span class="attr">wang</span>=<span class="number">123</span>,role3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 权限</span></span><br><span class="line"><span class="section">[roles]</span></span><br><span class="line"><span class="comment"># 角色role1对资源user拥有create、update权限</span></span><br><span class="line"><span class="attr">role1</span>=user:create,user:update</span><br><span class="line"><span class="comment"># 角色role2对资源user拥有create、delete权限</span></span><br><span class="line"><span class="attr">role2</span>=user:create,user:delete</span><br><span class="line"><span class="comment"># 角色role3对资源user拥有create权限</span></span><br><span class="line"><span class="attr">role3</span>=user:create</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 权限标识符号规则：资源:操作:实例(中间使用半角:分隔)</span></span><br><span class="line">user：create:01  表示对用户资源的01实例进行create操作。</span><br><span class="line">user:create：表示对用户资源进行create操作，相当于user:create:*，对所有用户资源实例进行create操作。</span><br><span class="line">user：*：01  表示对用户资源实例01进行所有操作。</span><br></pre></td></tr></table></figure>

<p>shiro-permi.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">zhang</span>=<span class="number">123</span></span><br><span class="line"><span class="attr">lisi</span>=<span class="number">555</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义的 Realm 信息</span></span><br><span class="line"><span class="attr">crmRealm</span>=shiro.CRMRealm</span><br><span class="line"><span class="comment"># 将 crmRealm 设置到当前环境中</span></span><br><span class="line"><span class="attr">securityManager.realms</span>=<span class="variable">$crmRealm</span></span><br></pre></td></tr></table></figure>

<p>使用 Shiro 相关的 API 完成身份认证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testShiro</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建SecurityManager工厂</span></span><br><span class="line">    Factory&lt;SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(</span><br><span class="line">            <span class="string">"classpath:shiro-permission.ini"</span>);</span><br><span class="line">    <span class="comment">// 创建SecurityManager</span></span><br><span class="line">    SecurityManager securityManager = factory.getInstance();</span><br><span class="line">    <span class="comment">// 将SecurityManager设置到系统运行环境，</span></span><br><span class="line">    <span class="comment">// 和spring后将SecurityManager配置spring容器中，一般单例管理</span></span><br><span class="line">    SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">    <span class="comment">// 创建subject</span></span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line">    <span class="comment">// 创建token令牌</span></span><br><span class="line">    UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">"wang"</span>, <span class="string">"123"</span>);</span><br><span class="line">    <span class="comment">// 执行认证</span></span><br><span class="line">    <span class="comment">// 1. 账号错误 org.apache.shiro.authc.UnknownAccountException</span></span><br><span class="line">    <span class="comment">// 2. 密码错误 org.apache.shiro.authc.IncorrectCredentialsException</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        subject.login(token);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"认证状态："</span> + subject.isAuthenticated());</span><br><span class="line">    <span class="comment">// 认证通过后执行授权</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基于角色的授权判断</span></span><br><span class="line">    <span class="comment">// hasRole传入角色标识</span></span><br><span class="line">    <span class="keyword">boolean</span> ishasRole = subject.hasRole(<span class="string">"role1"</span>);</span><br><span class="line">    System.out.println(<span class="string">"单个角色判断"</span> + ishasRole);</span><br><span class="line">    <span class="comment">// hasAllRoles是否拥有多个角色</span></span><br><span class="line">    <span class="keyword">boolean</span> hasAllRoles = subject.hasAllRoles(Arrays.asList(<span class="string">"role1"</span>,</span><br><span class="line">            <span class="string">"role2"</span>, <span class="string">"role3"</span>));</span><br><span class="line">    System.out.println(<span class="string">"多个角色判断"</span> + hasAllRoles);</span><br><span class="line">    <span class="comment">// 使用check方法进行授权，如果授权不通过会抛出异常</span></span><br><span class="line">    <span class="comment">// subject.checkRole("role13");</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基于资源的授权判断</span></span><br><span class="line">    <span class="comment">// isPermitted传入权限标识符</span></span><br><span class="line">    <span class="keyword">boolean</span> isPermitted = subject.isPermitted(<span class="string">"user:create:1"</span>);</span><br><span class="line">    System.out.println(<span class="string">"单个权限判断"</span> + isPermitted);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> isPermittedAll = subject.isPermittedAll(<span class="string">"user:create:1"</span>,</span><br><span class="line">            <span class="string">"user:delete"</span>);</span><br><span class="line">    System.out.println(<span class="string">"多个权限判断"</span> + isPermittedAll);</span><br><span class="line">    <span class="comment">// 使用check方法进行授权，如果授权不通过会抛出异常</span></span><br><span class="line">    subject.checkPermission(<span class="string">"items:create:1"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 加载 ini 文件，获取配置中的用户信息(账号+密码)</span></span><br><span class="line">    IniSecurityManagerFactory factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">"classpath:shiro-permi.ini"</span>);</span><br><span class="line">    <span class="comment">// 创建 Shiro 安全管理器</span></span><br><span class="line">    SecurityManager manager = factory.getInstance();</span><br><span class="line">    <span class="comment">// 安全管理器添加到运行环境中</span></span><br><span class="line">    SecurityUtils.setSecurityManager(manager);</span><br><span class="line">    <span class="comment">// 获取用户对象</span></span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"登录前的用户认证状态"</span> + subject.isAuthenticated());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建登录用户身份凭证</span></span><br><span class="line">    UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">"zhang"</span>, <span class="string">"123"</span>);</span><br><span class="line">    subject.login(token);</span><br><span class="line">    System.out.println(<span class="string">"登录后用户认证状态"</span> + subject.isAuthenticated());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Shiro 认证流程分析：</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/shiro/15668132293957-shiro.jpg"></p>
<h1 id="自定义-Realm"><a href="#自定义-Realm" class="headerlink" title="自定义 Realm"></a>自定义 Realm</h1><hr>
<p>实际开发中，需要的账户信息来自于数据库或者程序中，而不是 ini 配置文件。<br>上面的例子中，通过源码可以看到，使用的是 SimpleAccountRealm 类来处理账户的认证和授权的。其实现为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 认证，获取认证信息</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    UsernamePasswordToken upToken = (UsernamePasswordToken) token;</span><br><span class="line">    SimpleAccount account = getUser(upToken.getUsername());</span><br><span class="line">    <span class="keyword">if</span> (account != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (account.isLocked()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedAccountException(<span class="string">"Account ["</span> + account + <span class="string">"] is locked."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (account.isCredentialsExpired()) &#123;</span><br><span class="line">            String msg = <span class="string">"The credentials for account ["</span> + account + <span class="string">"] are expired"</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExpiredCredentialsException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> account;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 授权获取授权信息</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">    String username = getUsername(principals);</span><br><span class="line">    USERS_LOCK.readLock().lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.users.get(username);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        USERS_LOCK.readLock().unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 AuthenticatingRealm 中调用该方法判断账号是否正确，如果返回的 account 不为空，说明账号存在，然后进行密码校验。</p>
<p>覆写 doGetAuthenticationInfo() 方法，在该方法中实现账号的校验，返回 AuthenticationInfo 对象给上层调用者。</p>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/shiro/15668228891164-shiro.jpg"></p>
<p>上图为 Realm 的继承体系。我们需要继承 AuthorizingRealm，因为我们会使用缓存、认证和授权的所有功能。</p>
<p>创建自己的 Realm 文件，继承 AuthorizingRealm。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRMRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        String username = <span class="string">"111"</span>;</span><br><span class="line">        String password = <span class="string">"555"</span>;</span><br><span class="line">        <span class="comment">// 如果账号正确，返回一个 AuthenticationInfo 对象</span></span><br><span class="line">        <span class="keyword">if</span> (username.equals(token.getPrincipal())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(username, password, <span class="keyword">this</span>.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后需要告诉 Shiro 认证或者授权时，去找哪个类完成功能。修改 SecurityManager 中的默认 Realm 的使用</p>
<p>shiro.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义的 Realm 信息</span></span><br><span class="line"><span class="attr">crmRealm</span>=shiro.CRMRealm</span><br><span class="line"><span class="comment"># 将 crmRealm 设置到当前环境中</span></span><br><span class="line"><span class="attr">securityManager.realms</span>=<span class="variable">$crmRealm</span></span><br></pre></td></tr></table></figure>

<p>运行与之前测试结果一致，但现在是我们自己自定义的 Realm 完成了账号的校验。</p>
<h1 id="Spring-与-Shiro-整合"><a href="#Spring-与-Shiro-整合" class="headerlink" title="Spring 与 Shiro 整合"></a>Spring 与 Shiro 整合</h1><hr>
<p>导入 jar 包，shiro-web、shiro-spring、shiro-code</p>
<p>shiro 通过 filter 进行拦截，拦截后将操作权交给 spring 中配置的 filterChain 进行过滤。</p>
<p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- shiroFilter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        org.springframework.web.filter.DelegatingFilterProxy</span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>shiro过滤器，DelegatingFilterProxy 会从 spring 容器中找 shiroFilter，过滤器生命周期交给 Spring 容器管理。<br>Shiro 中定义了多个过滤器完成不同的预处理操作：</p>
<p>所有的过滤器导入的包为 <code>org.apache.shiro.web.filter.authc.</code></p>
<table>
<thead>
<tr>
<th>过滤器名称</th>
<th>过滤器</th>
<th>理解</th>
</tr>
</thead>
<tbody><tr>
<td>anon</td>
<td>AnonymousFilter</td>
<td>匿名拦截器，即不需要登录即可访问；一般用于静态资源过滤；示例 <code>/static/**=anon</code></td>
</tr>
<tr>
<td>authc</td>
<td>FormAuthenticationFilter</td>
<td>表示需要认证(登录)才能使用;示例 <code>/**=authc</code> 主要属性下面有说明</td>
</tr>
<tr>
<td>authcBasic</td>
<td>BasicHttpAuthenticationFilter</td>
<td>Basic HTTP身份验证拦截器，主要属性： applicationName：弹出登录框显示的信息(application)</td>
</tr>
<tr>
<td>roles</td>
<td>RolesAuthorizationFilter</td>
<td>角色授权拦截器，验证用户是否拥有资源角色;示例 <code>/admin/=roles[admin]</code></td>
</tr>
<tr>
<td>perms</td>
<td>PermissionsAuthorizationFilter</td>
<td>权限授权拦截器，验证用户是否拥有资源权限;示例 <code>/employee/input=perms[&quot;user:update&quot;]</code></td>
</tr>
<tr>
<td>user</td>
<td>UserFilter</td>
<td>用户拦截器，用户已经身份验证&#x2F;记住 我登录的都可;示例<code>/index=user</code></td>
</tr>
<tr>
<td>logout</td>
<td>LogoutFilter</td>
<td>注销拦截器，主要属性：redirectUrl：退出成功后重定向的地址(&#x2F;);示例 <code>/logout=logout</code></td>
</tr>
<tr>
<td>port</td>
<td>PortFilter</td>
<td>端口拦截器,主要属性 port(80),可以通过的端口;示例 <code>/test= port[80]</code> 如果用户访问该页面是非80,将自动将请求端口改为80并重定向到该80端口,其他路径&#x2F;参数等都一样</td>
</tr>
<tr>
<td>rest</td>
<td>HttpMethodPermissionFilter</td>
<td>rest风格拦截器,自动根据请求方法构建权限字符串</td>
</tr>
<tr>
<td>ssl</td>
<td>SslFilter</td>
<td>ssl:SSL拦截器，只有请求协议是https才能通过;否则自动跳转会https端口(443)其他和port拦截器一样</td>
</tr>
</tbody></table>
<blockquote>
<p>HttpMethodPermissionFilter : rest 风格拦截器,自动根据请求方法构建权限字符串(GET&#x3D;read,POST&#x3D;create,PUT&#x3D;update,DELETE&#x3D;delete,HEAD&#x3D;read,TRACE&#x3D;read,OPTIONS&#x3D;read, MKCOL&#x3D;create)构建权限字符串,示例 <code>/users=rest[user]</code>，会自动拼出 <code>user:read,user:create,user:update,user:delete</code> 权限字符串进行权限匹配(所有都得匹配isPermittedAll)</p>
</blockquote>
<p>CRMRealm.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">"crmRealm"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRMRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        String username = <span class="string">"zhang"</span>;</span><br><span class="line">        String password = <span class="string">"123"</span>;</span><br><span class="line">        <span class="comment">// 如果账号正确，返回一个 AuthenticationInfo 对象</span></span><br><span class="line">        <span class="keyword">if</span> (username.equals(token.getPrincipal())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(username, password, <span class="keyword">this</span>.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>shiro.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 扫描 realm 包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"cn.lizhaoloveit.crm.realm"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityManager"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"realm"</span> <span class="attr">ref</span>=<span class="string">"crmRealm"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- web.xml 中 shiro 的 filter 对应的 bean --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Shiro 的 Web 过滤器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"shiroFilter"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.spring.web.ShiroFilterFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"securityManager"</span> <span class="attr">ref</span>=<span class="string">"securityManager"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- loginUrl 认证提交地址，如果没有认证将会请求此地址进行认证，请求此地址将由formAuthenticationFilter进行表单认证 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"loginUrl"</span> <span class="attr">value</span>=<span class="string">"/login.html"</span>/&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--认证成功统一跳转到 first.action，建议不配置，shiro 认证成功自动到上一个请求路径 --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"successUrl"</span> <span class="attr">value</span>=<span class="string">"/first.action"</span>/&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--通过 unauthorizedUrl 指定没有权限操作时跳转页面--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"unauthorizedUrl"</span> <span class="attr">value</span>=<span class="string">"/refuse.jsp"</span>/&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--自定义 filter 配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filters"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 将自定义 的 FormAuthenticationFilter 注入 shiroFilter 中--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"authc"</span> <span class="attr">value-ref</span>=<span class="string">"crmFormAuthenticationFilter"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 过虑器链定义，从上向下顺序执行，一般将/**放在最下边 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filterChainDefinitions"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--所有 url 都可以匿名访问--&gt;</span></span><br><span class="line">            /css/** = anon</span><br><span class="line">            /js/** = anon</span><br><span class="line">            /images/** = anon</span><br><span class="line">            /uploads/** = anon</span><br><span class="line">            /** = authc</span><br><span class="line">        <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>步骤：</p>
<ol>
<li>在 web.xml 文件中配置 shiro 的过滤器</li>
<li>在对应的 spring 配置文件中配置与 web.xml 中对应的 filter<ul>
<li>保证静态资源不被拦截 <code>/css/** = anon、/js/** = anon、/images/** = anon</code></li>
<li>匿名可以访问</li>
</ul>
</li>
<li>配置安全管理器，注入自定义的 realm</li>
<li>配置自定义的 realm</li>
<li>交验完，告知前端页面校验结果</li>
</ol>
<p>有了上面的配置，在访问达到具体资源前，会通过制定的过滤器做预处理，允许通过后才能继续访问。在 JavaEE 环境中，使用过的安全管理器是 <code>DefaultWebSecurityManager</code>，并且在该安全管理器中指定我们自定义的 Realm。需要将自定义的 realm 交给 spring 容器管理，之后 shiro 就会通过自定义的 realm 进行账号认证和授权了。</p>
<p><strong>如果你使用 Dispatcher 配置路径 url-pattern 为 &#x2F;，且 mvc 中配置了 <code>&lt;mvc:default-servlet-handler/&gt;</code> 就一定记住，动态资源访问名与静态资源访问名不能同名。</strong></p>
<p>默认情况下，会调用 FormAuthenticationFilter 中的 onLoginFailure 和 onloginSuccess 对成功和失败的结果进行处理，而 shiro 不知道失败或者成功或者权限被拒后要做什么，需要我们去告诉它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">"crmFormAuthenticationFilter"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRMFormAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">FormAuthenticationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onLoginSuccess</span><span class="params">(AuthenticationToken token, Subject subject, ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        <span class="comment">// 响应页面需要的数据 成功</span></span><br><span class="line">        JsonResult result = <span class="keyword">new</span> JsonResult();</span><br><span class="line">        response.getWriter().print(JSON.toJSONString(result));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onLoginFailure</span><span class="params">(AuthenticationToken token, AuthenticationException e, ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        JsonResult result = <span class="keyword">new</span> JsonResult();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result.mark(<span class="string">"用户名或者密码错误"</span>);</span><br><span class="line">            response.getWriter().print(JSON.toJSONString(result));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在 Realm 中实现真实的查询即可。</p>
<p>CRMReam.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRMRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">		<span class="comment">// 验证用户名 密码</span></span><br><span class="line">		String username = (String) token.getPrincipal();</span><br><span class="line">		Employee employee = mapper.selectByName(username);</span><br><span class="line">		<span class="keyword">if</span> (employee != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(username, employee.getPassword(), <span class="keyword">this</span>.getName());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Shiro-制定化认证登录"><a href="#Shiro-制定化认证登录" class="headerlink" title="Shiro 制定化认证登录"></a>Shiro 制定化认证登录</h1><hr>
<p>从 Shiro 的认证体系可以看出来，FormAuthenticationFilter 中通过认证参数获取的几个参数是固定的，封装的认证数据类型为 UsernamePasswordToken ，UsernamePasswordToken 中只有 username，password，rememberMe，这显然不能满足需求，因此我们在覆写 FormAuthenticationFilter.java 时，也要扩展 Token 类，以提供需要的参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRMToken</span> <span class="keyword">extends</span> <span class="title">UsernamePasswordToken</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 序列化ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2804050723838289739L</span>;</span><br><span class="line">    <span class="comment">// 验证码</span></span><br><span class="line">    <span class="keyword">private</span> String captchaCode;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     * 用户名和密码是登录必须的,因此构造函数中包含两个字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CRMToken</span><span class="params">(String username, String password, String captchaCode)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 父类UsernamePasswordToken的构造函数,后两个参数暂不需要, 不设置</span></span><br><span class="line">        <span class="keyword">super</span>(username, password, <span class="keyword">false</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">this</span>.captchaCode = captchaCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCaptchaCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> captchaCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>必须在覆写的 FormAuthenticationFilter 中，重写 createToken 方法来创建我们自己的 Token 对象，否则不会有扩展。</p>
<p>CRMFormAuthenticationFilter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRMFormAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">FormAuthenticationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造Token,重写Shiro构造Token的方法,增加验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationToken <span class="title">createToken</span><span class="params">(String username, String password, ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取登录请求中用户输入的验证码</span></span><br><span class="line">        String captchaCode = request.getParameter(<span class="string">"captchaCode"</span>);</span><br><span class="line">        <span class="comment">// 返回带验证码的Token,Token会被传入Realm, 在Realm中可以取得验证码</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CRMToken(username, password, captchaCode);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后使用自己的数据模块来进行认证，CRMRealm 继承 org.apache.shiro.realm.AuthorizingRealm.java 类，代码如下：<br>CRMRealm.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">"crmRealm"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRMRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在自定义认证过滤器中奖验证码保存到 KaptchaCodeToken 中</span></span><br><span class="line">        <span class="comment">// 此处的 Token 就是认证过滤器中实例化的 Token 可以直接强制转换</span></span><br><span class="line">        CRMToken crmToken = (CRMToken) token;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证码</span></span><br><span class="line">        String loginCaptcha = crmToken.getCaptchaCode();</span><br><span class="line">        <span class="comment">// 验证码未输入</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isEmptyStr(loginCaptcha)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CaptchaEmptyException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">        String sessionCaptcha = (String) subject</span><br><span class="line">                .getSession().getAttribute(<span class="string">"RANDOMCODE_IN_SESSION"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!loginCaptcha.equals(sessionCaptcha)) &#123;</span><br><span class="line">            <span class="comment">// 抛出自定义异常(继承AuthenticationException),</span></span><br><span class="line">            <span class="comment">// Shiro会捕获 AuthenticationException 异常</span></span><br><span class="line">            <span class="comment">// 发现该异常时认为登录失败, 执行登录失败逻辑,</span></span><br><span class="line">            <span class="comment">// 登录失败页中可以判断如果是 CaptchaEmptyException 时为验证码错误</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CaptchaErrorException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记住用户名</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证用户名 密码</span></span><br><span class="line">        String username = (String) token.getPrincipal();</span><br><span class="line">        Employee employee = mapper.selectByName(username);</span><br><span class="line">        <span class="keyword">if</span> (employee != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(employee, employee.getPassword(), <span class="keyword">this</span>.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CRMRealm 做的是用户名认证，会将用户名密码传递给下一个认证链，如果抛出异常(AuthenticationException类型)，就会返回，并调用 FormAuthenticationFilter 的 <code>onLoginSuccess</code> 和 <code>onLoginFailure</code> 方法将结果响应给前端浏览器。所以我们也可以抛出自己自定义的异常类型，来精准判断错误。AuthenticationException 类型的异常会被 <code>onLoginFailure</code> 捕捉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CaptchaEmptyException</span> <span class="keyword">extends</span> <span class="title">AuthenticationException</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CaptchaErrorException</span> <span class="keyword">extends</span> <span class="title">AuthenticationException</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终根据程序执行流程响应结果</p>
<p>CRMFormAuthenticationFilter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">"crmFormAuthenticationFilter"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRMFormAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">FormAuthenticationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造Token,重写Shiro构造Token的方法,增加验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationToken <span class="title">createToken</span><span class="params">(String username, String password, ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取登录请求中用户输入的验证码</span></span><br><span class="line">        String captchaCode = request.getParameter(<span class="string">"captchaCode"</span>);</span><br><span class="line">        <span class="comment">// 返回带验证码的Token,Token会被传入Realm, 在Realm中可以取得验证码</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CRMToken(username, password, captchaCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onLoginSuccess</span><span class="params">(AuthenticationToken token, Subject subject, ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        <span class="comment">// 响应页面需要的数据 成功</span></span><br><span class="line">        JsonResult result = <span class="keyword">new</span> JsonResult();</span><br><span class="line">        response.getWriter().print(JSON.toJSONString(result));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onLoginFailure</span><span class="params">(AuthenticationToken token, AuthenticationException e, ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        JsonResult result = <span class="keyword">new</span> JsonResult();</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> CaptchaEmptyException) &#123;</span><br><span class="line">            result.mark(<span class="string">"验证码为空"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> CaptchaErrorException) &#123;</span><br><span class="line">            result.mark(<span class="string">"验证码错误"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.mark(<span class="string">"用户名或者密码错误"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.getWriter().print(JSON.toJSONString(result));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Shiro-RememberMe-流程原理"><a href="#Shiro-RememberMe-流程原理" class="headerlink" title="Shiro RememberMe 流程原理"></a>Shiro RememberMe 流程原理</h1><hr>
<h1 id="Shiro-授权概述"><a href="#Shiro-授权概述" class="headerlink" title="Shiro 授权概述"></a>Shiro 授权概述</h1><hr>
<p>基于 ini 的授权，详情见上面基于 ini 的 Shiro 认证代码。</p>
<p>规则，”资源标识符:操作:资源实例标识符”，意思是对哪个资源的哪个实例具有什么操作，:是资源&#x2F;操作&#x2F;实例的分割付，权限字符串也可以用 * 通配符。</p>
<p>exp:用户创建权限:(user:create)，或者 user:create.* 用户修改实例 001 的权限：user:update001，用户实例001的所有权限：user:*:001</p>
<p>方法：</p>
<ul>
<li>isPermitted(String permission) 是否拥有当前指定的一个权限</li>
<li>isPermitted(String permission,…) 是否拥有当前指定的一个或者多个权限，以数组形式返回每个判断结果</li>
<li>hasRole(String role) 是否拥有当前指定的一个角色</li>
<li>hasRoles(List roles) 是否拥有当前指定的多个角色，以数组形式返回每个判断的结果</li>
<li>hasAllRoles(Collection roles) 是否拥有指定的多个角色，只有当都有的时候才返回 true，反之返回 false</li>
</ul>
<h1 id="web-下-Realm-的授权"><a href="#web-下-Realm-的授权" class="headerlink" title="web 下 Realm 的授权"></a>web 下 Realm 的授权</h1><hr>
<ol>
<li>对 subject 进行授权，调用方法 isPermitted(“permission 串”)</li>
<li>SecurityManager 执行授权，通过 ModularRealmAuthorizer 执行授权</li>
<li>ModularRealmAuthorizer 执行自定义的 Realm 中的方法 <code>doGetAuthorizationInfo</code> 从数据库查询权限数据调用 realm 的授权方法。</li>
<li>realm 从数据库查询权限数据，返回 ModularRealmAuthorizer</li>
<li>如果对比后，isPermitted 中 “permission串”在realm 查询到权限数据中，说明用户访问 permission 传有权限，否则没有权限，抛出异常。</li>
</ol>
<p><img src="https://www.lizhaoloveit.cn/blogimages/java/frames/shiro/15668132293958-shiro.jpg"></p>
<p>在权限管理模块中，采用自定义权限注解，贴在需要授权的方法上，获取对应的注解，生成权限表达式。但这个注解是我们自己定义的，Shiro 并不知道，所以需要使用 Shiro 自身提供的注解来完成。</p>
<ul>
<li>在 Controller 的方法上贴上 Shiro 提供的权限注解(@RequiresPermissions)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line"><span class="meta">@RequiresPermissions</span>(value = &#123;<span class="string">"Employee:list"</span>, <span class="string">"员工列表"</span>&#125;, logical = Logical.OR)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">list</span><span class="params">(Model model, @ModelAttribute(<span class="string">"qe"</span>)</span> QueryEmployee qe) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (qe == <span class="keyword">null</span> || qe.getPageNum() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        qe = QueryEmployee.EMPTYQUERY;</span><br><span class="line">        model.addAttribute(<span class="string">"qe"</span>, qe);</span><br><span class="line">    &#125;</span><br><span class="line">    qe.setDeptId(Optional.ofNullable(qe.getDeptId())</span><br><span class="line">            .filter(s -&gt; s.intValue() &gt; <span class="number">0</span>).orElse(<span class="keyword">null</span>));</span><br><span class="line">    PageInfo pageInfoEmp = employeeService.gets(qe);</span><br><span class="line">    model.addAttribute(<span class="string">"pageInfo"</span>, pageInfoEmp);</span><br><span class="line">    PageInfo pageInfoDept = departmentService.gets(<span class="keyword">null</span>);</span><br><span class="line">    model.addAttribute(<span class="string">"pageInfoDept"</span>, pageInfoDept);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"employee/list"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>value 属性可以传递 String[] ，同时设置权限表达式和权限名称，<br>logical Shiro 会将 value 中的数据都作为权限表达式使用，校验的时候都要有，或者拥有其中一个，对应的值是 Logical.AND 和 Logical.OR</p>
<ul>
<li>开启 Shiro 注解扫描器，当扫描到 Controller 中有使用 @RequiresPermissions 注解时，会使用动态代理为当前 Controller 生成代理对象，增强对应方法的权限校验功能。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"securityManager"</span> <span class="attr">ref</span>=<span class="string">"securityManager"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面的增强类需要依赖 aop 组件，并且要注明是用 CGLib 创建动态代理</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- aop 组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;aspectj.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjrt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;aspectj.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>PermissionService.reload()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取所有的权限，并且做成一个 map 方便查找</span></span><br><span class="line">    List&lt;Permission&gt; permissions = permissionMapper.selectAll();</span><br><span class="line">    <span class="comment">// 将所有的 Controller 从容器中取出</span></span><br><span class="line">    Map&lt;String, Object&gt; beans = context.getBeansWithAnnotation(Controller.class);</span><br><span class="line">    Collection&lt;Object&gt; controllers = beans.values();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历所有的 Controller</span></span><br><span class="line">    <span class="keyword">for</span> (Object controller : controllers) &#123;</span><br><span class="line">        <span class="comment">// 获取 Controller 中的方法，因为在运行时，shiro 会对贴有注解的 Controller 生成动态代理</span></span><br><span class="line">        <span class="comment">// 所以需要通过其父类来获取方法</span></span><br><span class="line">        Method[] methods = controller.getClass().getSuperclass().getDeclaredMethods();</span><br><span class="line">        <span class="comment">// 遍历所有的方法</span></span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> isPermissionMethod = method.isAnnotationPresent(RequiresPermissions.class);</span><br><span class="line">            <span class="comment">// 如果方法没有贴 @RequiresPermissions 注解，就继续循环</span></span><br><span class="line">            <span class="keyword">if</span> (!isPermissionMethod) <span class="keyword">continue</span>;</span><br><span class="line">            RequiresPermissions reqPerAnn = method.getDeclaredAnnotation(RequiresPermissions.class);</span><br><span class="line">            <span class="comment">// 说明数据库中已经存在了 methodExpression，继续循环</span></span><br><span class="line">            <span class="keyword">if</span> (permissions.contains(reqPerAnn.value()[<span class="number">0</span>])) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// 来到这里说明数据库不存在该权限</span></span><br><span class="line">            Permission permission = <span class="keyword">new</span> Permission();</span><br><span class="line">            permission.setName(reqPerAnn.value()[<span class="number">1</span>]);</span><br><span class="line">            permission.setExpression(reqPerAnn.value()[<span class="number">0</span>]); <span class="comment">// employee:delete</span></span><br><span class="line">            permissionMapper.insert(permission);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：</p>
<ol>
<li>从 Spring 容器中获取的 Controller 对象是代理对象，该对象的类型继承原 Controller，而注解是在原 Controller 类方法上的，所以需要获取到 Controller 代理对象的父类字节码，然后获取方法</li>
<li>权限表达式在注解中直接指定。</li>
</ol>
</blockquote>
<p>在 CRMRealm.java 中获取当前登录用户的授权信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">    SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">    <span class="comment">// 获取当前登录用户</span></span><br><span class="line">    Employee employee = (Employee) principals.getPrimaryPrincipal();</span><br><span class="line">    <span class="comment">// 如果是超管，放行</span></span><br><span class="line">    <span class="keyword">if</span> (employee.isAdmin()) &#123;</span><br><span class="line">        info.addRole(<span class="string">"admin"</span>);</span><br><span class="line">        info.addStringPermission(<span class="string">"*:*"</span>);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据用户 id 获取其所有角色名</span></span><br><span class="line">    List&lt;String&gt; roleSns = roleMapper.selectRoleSnsWithEmpId(employee.getId());</span><br><span class="line">    <span class="comment">// 根据 id 获取所有权限表达式</span></span><br><span class="line">    List&lt;String&gt; expressions = permissionMapper.selectExpressionsByEmpId(employee.getId());</span><br><span class="line">    info.addRoles(roleSns);</span><br><span class="line">    info.addStringPermissions(expressions);</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>*:*</code> 表示所有权限，如果用户是超管，可以访问所有权限，不是超管，就分配给用户响应的权限。<code>doGetAuthorizationInfo</code> 方法配置角色，基于角色获取对象是否有访问权限，或者基于角色判断页面是否需要展示页面。这里 subject.hasRole(String sn)，sn 为上面我们在授权时，添加的角色名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Subject subject = SecurityUtils.getSubject();</span><br><span class="line">Employee employee = (Employee) subject.getPrincipal();</span><br><span class="line"><span class="comment">// 如果不是管理员且不是销售经理，就只能查看自己的客户 否则，可以看到全部用户</span></span><br><span class="line"><span class="keyword">if</span> (!subject.hasRole(Role.ROLE_ADMIN) &amp;&amp; !subject.hasRole(Role.ROLE_MARKETMASTER))</span><br><span class="line">    qc.setSellerId(employee.getId());</span><br><span class="line"><span class="keyword">else</span> &#123; <span class="comment">// 可以看到全部用户</span></span><br><span class="line">    model.addAttribute(<span class="string">"sellers"</span>, employeeService.getsSellers());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前端页面中的写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 如果是管理员或者销售经理才会出现这个 --&gt;</span><br><span class="line">&lt;@shiro.hasAnyRoles name&#x3D;&quot;admin,marketMaster&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;form-group&quot;&gt;</span><br><span class="line">        &lt;label for&#x3D;&quot;seller&quot;&gt;市场专员:&lt;&#x2F;label&gt;</span><br><span class="line">        &lt;select class&#x3D;&quot;form-control&quot; id&#x3D;&quot;seller&quot; name&#x3D;&quot;sellerId&quot;&gt;</span><br><span class="line">            &lt;option value&#x3D;&quot;-1&quot;&gt;全部&lt;&#x2F;option&gt;</span><br><span class="line"></span><br><span class="line">            &lt;#list sellers.list as e&gt;</span><br><span class="line">                &lt;option value&#x3D;&quot;$&#123;e.id&#125;&quot;&gt;$&#123;e.name&#125;&lt;&#x2F;option&gt;</span><br><span class="line">            &lt;&#x2F;#list&gt;</span><br><span class="line">        &lt;&#x2F;select&gt;</span><br><span class="line">        &lt;script&gt;</span><br><span class="line">            $(&quot;#seller option[value&#x3D;&#39;$&#123;qc.sellerId!&#39;-1&#39;&#125;&#39;]&quot;).prop(&quot;selected&quot;, true);</span><br><span class="line">        &lt;&#x2F;script&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;@shiro.hasAnyRoles&gt;</span><br></pre></td></tr></table></figure>

<p>如果访问没有权限的资源会抛出异常：<code>org.apache.shiro.authz.UnauthorizedException</code> ，只要捕获到该异常，然后进行处理。使用 SpringMVC 的统一异常处理。</p>
<p>mvc.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.handler.SimpleMappingExceptionResolver"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 定义默认的异常处理页面 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultErrorView"</span> <span class="attr">value</span>=<span class="string">"common/error"</span>/&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 定义需要特殊处理的异常，使用类名或完全路径名作为 Key，异常页作为值 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"exceptionMappings"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">			org.apache.shiro.authz.UnauthorizedException=common/nopermission</span><br><span class="line">		<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 exceptionMappings 中键值对的格式设置，是如果异常类名是 org.apache.shiro.authz.UnauthorizedException，则跳转的错误页面资源路径为 <code>common/nopermission</code></p>
<h2 id="异步请求没有权限异常处理"><a href="#异步请求没有权限异常处理" class="headerlink" title="异步请求没有权限异常处理"></a>异步请求没有权限异常处理</h2><p>异步请求需要拦截 org.apache.shiro.authz.UnauthorizedException 异常，并判断是否是异步请求，然后做相应处理，而拦截访问资源的异常，最好使用 aop 对 Controller 进行增强，就可以拦截器方法抛出的异常了。</p>
<p>Spring 已经提供了一个增强器 @ControllerAdvice，贴上改标签的类被认为是 Controller 的增强类型。通常和 @ExceptionHandler、@InitBinder、@ModelAttribute 注解配合使用，最常用的是 @ExceptionHandler。对Controller 中的异常做特定处理。</p>
<p>@ExceptionHandler 贴了该注解的方法，会在Controller 抛出异常时，进入方法执行逻辑，参数如下：</p>
<ul>
<li>异常参数，包括一般的异常或者自定义异常，如果注解没有指定异常类，会默认进行映射。</li>
<li>请求或者响应对象，(HttpServletRequest、ServletRequest、HttpServletResponse、ServletResponse)</li>
<li>HttpSession</li>
<li>WebRequest 或者 NativeWebRequest</li>
<li>Locale</li>
<li>InputStream&#x2F;Reader</li>
<li>OutputStream&#x2F;Writer</li>
<li>Model</li>
</ul>
<p>UnauthorizedExceptionUtil.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DESCRIPTION: 处理异步请求时，用户没有权限的异常</span></span><br><span class="line"><span class="comment"> * Author: Ammar</span></span><br><span class="line"><span class="comment"> * Date:   2019-08-28</span></span><br><span class="line"><span class="comment"> * Time:   19:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnauthorizedExceptionUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 专门捕获 UnauthorizedException 异常</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(UnauthorizedException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(HttpServletResponse response, HandlerMethod method, UnauthorizedException e)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 判断资源方法是否为异步请求</span></span><br><span class="line">        <span class="keyword">if</span> (method.getMethod().isAnnotationPresent(ResponseBody.class)) &#123;</span><br><span class="line">            response.setContentType(<span class="string">"text/json;charset=UTF-8"</span>);</span><br><span class="line">            JsonResult jsonResult = <span class="keyword">new</span> JsonResult();</span><br><span class="line">            jsonResult.mark(<span class="string">"对不起，您没有权限执行该操作"</span>);</span><br><span class="line">            response.getWriter().print(JSON.toJSONString(jsonResult));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Shiro标签控制权限"><a href="#Shiro标签控制权限" class="headerlink" title="Shiro标签控制权限"></a>Shiro标签控制权限</h1><hr>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>前端页面的权限处理，根据权限控制前端页面。比如：用户拥有删除员工的权限，则在页面上把删除按钮显示出来。<br>引入 jar 包，<code>shiro-freemarker-tags</code></p>
<p>并且默认 freemarker 是不支持 shiro 标签的，需要扩展 freemarker 功能。</p>
<p>MyFreeMarkerConfig.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFreeMarkerConfig</span> <span class="keyword">extends</span> <span class="title">FreeMarkerConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TemplateException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.afterPropertiesSet();</span><br><span class="line">        Configuration cfg = <span class="keyword">this</span>.getConfiguration();</span><br><span class="line">        cfg.setSharedVariable(<span class="string">"shiro"</span>, <span class="keyword">new</span> ShiroTags());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mvc.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"cn.lizhaoloveit.crm.util.MyFreeMarkerConfig"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 配置 freemarker 的文件编码 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultEncoding"</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 配置 freemarker 寻找模板的路径 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"templateLoaderPath"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/view"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>覆写 FreemarkerConfigerer 类，加入 shiro 标签，然后再 mvc.xml 中用自己的 FreemarkerConfig 类来覆盖原来的 bean。</p>
<h2 id="常用标签"><a href="#常用标签" class="headerlink" title="常用标签"></a>常用标签</h2><ol>
<li>authenticated：已经认证通过的用户 <code>&lt;@shiro.authenticated&gt;&lt;/@shiro.authenticated&gt;</code></li>
<li>notAuthenticated</li>
<li>principal 输出当前用户信息，通常为登录账号信息 <code>&lt;@shiro.principal property=&quot;name&quot;/&gt;</code>，就是 Employee 对象，也就是我们在验证的时候传入的对象。相当于<code>Employee principal = (Employee) SecurityUtils.getSubject().getPrincipal();</code></li>
<li>hasRole 验证当前用户是否属于该角色 <code>&lt;@shiro.hasRole name=&quot;admin&quot;&gt;Hello admin!&lt;/@shiro.hasRole&gt;</code></li>
<li>hasAnyRoles 验证当前用户是否属于这些角色中的任何一个，角色之间用逗号分隔 <code>&lt;@shiro.hasAnyRoles name=&quot;admin,user,operator&quot;&gt;Hello admin!&lt;/@shiro.hasAnyRoles&gt;</code></li>
<li>hasPermission 验证当前用户是否拥有该权限 <code>&lt;@shiro.hasPermission name=&quot;/order:*&quot;&gt;订单&lt;/@shiro.hasPermission&gt;</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;@shiro.hasPermission name&#x3D;&quot;employee:delete&quot;&gt;</span><br><span class="line">	&lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;btn btn-danger btn-xs btn-delete&quot; data-href&#x3D;&quot;&#x2F;employee&#x2F;delete?id&#x3D;$&#123;entity.id&#125;&quot;&gt;</span><br><span class="line">		&lt;span class&#x3D;&quot;glyphicon glyphicon-trash&quot;&gt;&lt;&#x2F;span&gt; 删除</span><br><span class="line">	&lt;&#x2F;a&gt;</span><br><span class="line">&lt;&#x2F;@shiro.hasPermission&gt;</span><br></pre></td></tr></table></figure>

<p>如果当前登录的用户没有员工删除权限，就不在页面中显示超链接。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- authenticated 用户已经经过身份验证，但不是记住我登录的 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:authenticated</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shiro:principal</span> /&gt;</span>已经经过身份验证<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:authenticated</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 用户没有进行身份验证，记住我自动登录的属于没有进行身份验证 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:notAuthenticated</span>&gt;</span></span><br><span class="line">    用户没有进行身份验证，记住我自动登录的属于没有进行身份验证<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:notAuthenticated</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- guest  ：用户没有验证时显示相应信息 ,如登录等相关信息--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:guest</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"login.jsp"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:guest</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 当前用户有任意一个角色将会显示body体中的内容 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:hasAnyRoles</span> <span class="attr">name</span>=<span class="string">"admin,user,manager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shiro:principal</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:principal</span>&gt;</span>拥有admin/user/manager中的角色<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:hasAnyRoles</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 当前用户有相应的权限，将显示body体中的信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:hasPermission</span> <span class="attr">name</span>=<span class="string">"customer:delete"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shiro:principal</span> /&gt;</span>拥有customer:delete权限<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:hasPermission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 当前用户没有相应的权限，将显示body体中的信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"customer:delete"</span>&gt;</span></span><br><span class="line">    没有权限customer:delete<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:lacksPermission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 当前用户没有相应的角色，将显示body中的信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"manager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shiro:principal</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:principal</span>&gt;</span>没有manager角色<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- user: 用户已经经过认证/记住我登录后 显示相应的信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"logout"</span>&gt;</span>登出<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 当前用户是否拥有该角色，有就显示相关信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"admin"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"admin.jsp"</span>&gt;</span>Admin Page<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="MD5-加密"><a href="#MD5-加密" class="headerlink" title="MD5 加密"></a>MD5 加密</h1><hr>
<p>登录的时候，虽然 POST 请求，仍然要对用户数据进行加密。而加密后的数据需要告诉 shiro 是何种加密算法，不然 shiro 不能对用户进行认证，需要在 shiro.xml 中配置加密器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 加密器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.authc.credential.HashedCredentialsMatcher"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 加密算法 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hashAlgorithmName"</span> <span class="attr">value</span>=<span class="string">"MD5"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 加密次数 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name="hashIterations" value="3"/&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先，在保存用户名密码时，应该加密保存。<br>EmployeeServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(Employee e, Long[] roleIds)</span> <span class="keyword">throws</span> RuntimeException </span>&#123;</span><br><span class="line">    <span class="comment">// 加密</span></span><br><span class="line"><span class="comment">//        Md5Hash password = new Md5Hash(e.getPassword(), e.getName(), 1); (加密体，salt，加密次数)</span></span><br><span class="line">    Md5Hash password = <span class="keyword">new</span> Md5Hash(e.getPassword(), e.getName(), <span class="number">1</span>);</span><br><span class="line">    e.setPassword(password.toString());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.getId() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            employeeMapper.insert(e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            employeeMapper.update(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为空就是超管</span></span><br><span class="line">        <span class="keyword">if</span> (roleIds == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除 emp_role 中的 empId 的数据</span></span><br><span class="line">        employeeMapper.deleteFromEmpRoleWithEmpId(e.getId());</span><br><span class="line">        <span class="comment">// 维护表关系</span></span><br><span class="line">        <span class="keyword">for</span> (Long roleId : roleIds) &#123;</span><br><span class="line">            employeeMapper.insertEmpRole(e.getId(), roleId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"用户名已存在"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面模拟整个登录认证，用户输入用户名密码登录，shiro 的 realm 拿到用户名密码后，调用 <code>doGetAuthenticationInfo</code> 方法。在调用 <code>SimpleAuthenticationInfo(Object principal, Object hashedCredentials, ByteSource credentialsSalt, String realmName)</code> 时，如果用了 md5 加密算法，则要将 salt 告诉 shiro，在 ByteSource credentialsSalt。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(</span><br><span class="line">        employee,</span><br><span class="line">        employee.getPassword(),</span><br><span class="line">        ByteSource.Util.bytes(employee.getName()),</span><br><span class="line">        <span class="keyword">this</span>.getName());</span><br></pre></td></tr></table></figure>

<p>但此时还是不能让 shiro 来进行认证，因为我们虽然在 spring 容器中存放了加密器 <code>HashedCredentialsMatcher</code>，但是并没有将这个加密器设置给 realm，所以在 realm 中要设置 HashedCredentialsMatcher 为自定义的加密器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCredentialsMatcher</span><span class="params">(CredentialsMatcher credentialsMatcher)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.setCredentialsMatcher(credentialsMatcher);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>realm 接受一个 CredentialsMatcher 参数，但是 HashedCredentialsMatcher 继承了 SimpleCredentialsMatcher 实现了 CredentialsMatcher。</p>
<p>此时，shiro 已经可以为我们进行认证了。</p>
<h1 id="集成-EhCache"><a href="#集成-EhCache" class="headerlink" title="集成 EhCache"></a>集成 EhCache</h1><hr>
<p>shiro 中的缓存。在请求中，一旦进行权限控制，例如 @RequiresPermissions(“employee:list”) 或者 <code>&lt;@shiro:hasPermission name=&quot;employee:delete&quot;&gt;</code> 都会去 Realm 的 doGetAuthorizationInfo 方法中进行授权，而且每次都要查数据库，用到就查是非常麻烦的。而且用户登录以后，授权信息一般很少变动，所以在第一次授权后，就把授权信息缓存。</p>
<p>shiro 中没有实现自己的缓存机制，只提供了一个可以支持具体缓存的实现的抽象 API 接口，允许 shiro 根据自己的需求灵活的选择具体的 CacheManager，(Hazelcast, Ehcache, OSCache, Terracotta, Coherence, GigaSpaces, JBossCache等)，这里选择使用 EHCache。</p>
<p>实现步骤：</p>
<ul>
<li>添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- shiro 权限管理缓存组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;shiro.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcache-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>shiro.xml 中配置缓存管理器，并引用缓存</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cacheManager"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.cache.ehcache.EhCacheManager"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 缓存配置文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheManagerConfigFile"</span> <span class="attr">value</span>=<span class="string">"classpath:shiro-ehcache.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityManager"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"realm"</span> <span class="attr">ref</span>=<span class="string">"crmRealm"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheManager"</span> <span class="attr">ref</span>=<span class="string">"cacheManager"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        &lt;property name="rememberMeManager" ref="rememberMeManager"/&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>shiro-ehcache.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ehcache</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">defaultCache</span> <span class="attr">maxElementsInMemory</span>=<span class="string">"1000"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">eternal</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">timeToIdleSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">timeToLiveSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">"LRU"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">defaultCache</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Ehcache 配置属性名：</p>
<ul>
<li>name:缓存名称</li>
<li><strong>maxElementsInmemory</strong> 缓存最大个数，</li>
<li><strong>eternal</strong> 对象是否永久有效，一旦设置，timeout 将不起作用。</li>
<li><strong>timeToLiveSeconds</strong> 设置对象在失效前允许存活时间(单位：s)最大时间介于创建时间和失效时间之间。当 eternal&#x3D;false 时使用，默认是0,也就是对象存活时间无穷大。</li>
<li><strong>overflowToDisk</strong> 当内存中对象数量达到 maxElementsInMemory 时，Ehcache 会将对象写到磁盘中，</li>
<li><strong>diskSpoolBufferSizeMB</strong> 这个参数设置 DiskStore 磁盘缓存区域大小。默认 30 MB。每个 Cache 都有自己的一个缓冲区</li>
<li><strong>maxElementsOnDisk</strong> 硬盘最大缓存个数，</li>
<li><strong>diskPersistent</strong> 是否缓存虚拟机重启期数据。默认值是 false</li>
<li><strong>diskExpireThreadIntervalSeconds</strong> 磁盘失效线程运行时间间隔，默认120秒</li>
<li><strong>memoryStoreEvictionPolicy</strong> 当达到 maxElementsInMemory 限制时，Ehcache 会根据指定的策略去清理内存。默认策略是 LRU (最近最少使用),可以设置为 FIFO(先进先出) 或者 LFU(较少使用)。</li>
<li><strong>clearOnFlush</strong> 内存数量最大时是否清楚。</li>
</ul>
<p>配置结束，登录之后，多次访问权限资源时，不会在反复查询权限数据，而是直接使用缓存汇总的权限数据。</p>
<h2 id="清空缓存"><a href="#清空缓存" class="headerlink" title="清空缓存"></a>清空缓存</h2><ol>
<li>用户正常退出，缓存自动清空</li>
<li>如果用户非正常退出，缓存自动清空</li>
<li>如果修改了用户的权限，而用户不退出系统，修改的权限无法立即生效</li>
<li>当用户权限修改以后，用户再次登录 shiro 会自动调用 realm 从数据库获取权限，修改权限后想立即清除缓存的话，可以调用 realm 的 clearCache 方法清除缓存。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    PrincipalCollection principals = SecurityUtils.getSubject().getPrincipals();</span><br><span class="line">    <span class="keyword">super</span>.clearCache(principals);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在角色权限 Service 中，delete、update 方法区调用 realm 的清除缓存方法。<br>测试时，可以用命令对数据库中的密码加密：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 将所有的密码设置为1</span></span><br><span class="line"><span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> <span class="keyword">password</span> = <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 使用 MD5 函数对密码进行加密，使用 name 作为 salt</span></span><br><span class="line"><span class="keyword">UPDATE</span> employee <span class="keyword">SET</span> <span class="keyword">password</span>=<span class="keyword">MD5</span>(<span class="keyword">concat</span>(<span class="keyword">name</span>, <span class="keyword">password</span>));</span><br></pre></td></tr></table></figure>

<p><strong>上述方法只能清空自己的授权缓存</strong></p>
<p>如果想要清空所有用户的缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cacheManager.getCacheManager().clearAll(); <span class="comment">// 性能比较差，不建议使用</span></span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><hr>
<p>Shiro 做了哪些事情</p>
<ol>
<li>实现了用户的身份认证</li>
<li>实现了系统级别的注销登录</li>
<li>实现了访问权限的控制</li>
<li>用户信息的加密</li>
<li>权限数据的缓存</li>
</ol>
<h1 id="Spring-Security"><a href="#Spring-Security" class="headerlink" title="Spring Security"></a>Spring Security</h1><hr>
<p>目前最流行的一个安全权限管理框架，它与 Spring 结合紧密。如果项目使用 Spring 可以使用。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ammar</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lizhaoloveit.cn/2019/08/25/Shiro%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/">http://lizhaoloveit.cn/2019/08/25/Shiro%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lizhaoloveit.cn">Ammar's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Shiro/">Shiro    </a></div><div class="post_share"><div class="social-share" data-image="https://lizhaoloveit.cn/blogimages/blog/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2019/09/03/Restful%E6%9E%B6%E6%9E%84/"><img class="prev_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Restful架构</span></div></a></div><div class="next-post pull-right"><a href="/2019/08/24/CRM%E7%B3%BB%E7%BB%9F/"><img class="next_cover lozad" data-src="https://www.lizhaoloveit.cn/blogimages/blog/cover/1.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/2.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/3.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/4.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/5.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/6.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/7.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/8.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/9.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/10.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/11.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/12.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/13.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/14.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/15.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/16.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/17.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/18.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/19.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/20.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/21.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/22.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/23.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/24.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/25.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/26.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/27.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/28.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/29.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/31.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/32.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/33.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/34.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/35.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/36.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/37.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/38.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/39.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/40.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/41.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/42.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/43.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/44.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/45.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/46.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/47.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/48.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/49.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/50.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/51.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/52.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/53.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/54.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/55.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/56.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/57.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/58.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/59.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/60.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/62.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/63.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/64.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/65.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/66.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/67.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/68.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/69.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/70.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/71.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/72.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/73.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/74.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/75.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/76.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/77.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/78.jpg,https://www.lizhaoloveit.cn/blogimages/blog/cover/79.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>CRM系统</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'http://lizhaoloveit.cn/2019/08/25/Shiro%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6/';
  this.page.identifier = '2019/08/25/Shiro权限框架/';
  this.page.title = 'Shiro权限框架';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'lizhao' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2024 By Ammar</div><div class="icp"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener"><span>浙ICP备19013619号-1</span></a></div><div class="bag"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010502006128" target="_blank" rel="noopener"><img src="/img/beian.png"><span>浙公网安备 33010502006128号</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="far fa-moon nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script async src="/js/search/algolia.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>